<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lex: Law School Companion</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .serif-text { font-family: 'Merriweather', serif; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .loader {
            border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #2563eb;
            width: 24px; height: 24px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen flex overflow-hidden">

    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center text-white transition-opacity duration-300">
        <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center text-3xl font-bold font-serif mb-6 shadow-lg">L</div>
        <h1 class="text-3xl font-bold mb-2 tracking-wide">LEX COMPANION</h1>
        <p class="text-slate-400 mb-8">Your 2L Journey, Synced Anywhere.</p>
        <button onclick="window.appHandlers.login()" class="bg-white text-slate-900 px-6 py-3 rounded-lg font-bold flex items-center gap-3 hover:bg-slate-100 transition shadow-xl">
            <i class="fab fa-google text-red-500"></i> Sign in with Google
        </button>
    </div>

    <aside class="w-64 bg-slate-900 text-white flex flex-col shadow-xl flex-shrink-0 transition-all duration-300" id="sidebar">
        <div class="p-6 border-b border-slate-800 flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-xl font-bold font-serif shadow-inner">L</div>
            <div>
                <h1 class="font-bold text-lg tracking-wide">LEX</h1>
                <p class="text-[10px] text-amber-400 font-bold tracking-widest uppercase">Version 3.4</p>
            </div>
        </div>
        <nav class="flex-1 overflow-y-auto py-4 space-y-1 px-3"></nav>
        <div class="p-4 border-t border-slate-800 space-y-3">
            <div class="flex items-center justify-between px-3 py-2 rounded bg-slate-800">
                <div class="flex items-center gap-3 overflow-hidden">
                    <div class="w-8 h-8 rounded-full bg-slate-600 flex items-center justify-center"><i class="fas fa-user text-xs"></i></div>
                    <div class="overflow-hidden">
                        <p class="text-sm font-medium truncate" id="user-display">Student</p>
                        <p class="text-[10px] text-green-400"><i class="fas fa-cloud text-[10px]"></i> Cloud Sync Active</p>
                    </div>
                </div>
                <button onclick="window.appHandlers.logout()" class="text-slate-400 hover:text-red-400 transition" title="Log Out"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col min-w-0 bg-slate-50 relative">
        <header class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-8 flex-shrink-0">
            <h2 id="page-title" class="text-2xl font-bold text-slate-800 serif-text">Dashboard</h2>
            <div class="flex items-center gap-4">
                <span id="header-date-display" class="text-sm font-medium text-slate-600 hidden md:inline-block"></span>
                <span id="header-clock" class="text-sm font-mono text-slate-500 bg-slate-100 px-3 py-1 rounded">00:00:00</span>
            </div>
        </header>
        <div id="content-area" class="flex-1 overflow-y-auto p-8 relative">
            <div class="flex items-center justify-center h-full"><div class="loader"></div></div>
        </div>
    </main>

    <div id="app-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4 transition-all duration-200">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all duration-200" id="app-modal-card">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 id="app-modal-title" class="font-bold text-slate-800 text-lg flex items-center gap-2">Modal Title</h3>
                <button onclick="document.getElementById('app-modal').classList.add('hidden')" class="text-slate-400 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
            </div>
            <div id="app-modal-body" class="p-6 space-y-4"></div>
            <div class="px-6 py-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                <button onclick="document.getElementById('app-modal').classList.add('hidden')" class="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-lg text-sm font-medium transition">Cancel</button>
                <button id="app-modal-submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium transition shadow-sm">Save</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, serverTimestamp, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDxKEf2v5P2LN_a2BcR_ODYDGINZMmVPWk",
            authDomain: "abogado-ea708.firebaseapp.com",
            projectId: "abogado-ea708",
            storageBucket: "abogado-ea708.firebasestorage.app",
            messagingSenderId: "469135522184",
            appId: "1:469135522184:web:d7cf28de119011f282623d"
        };
        
        const appNamespace = 'law-companion-v1'; 
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const db = getFirestore(app);
        
        let currentUser = null;
        let currentView = 'dashboard';

        // --- DATABASE ADAPTER ---
        const AppDB = {
            subscribe: (collectionName, callback) => {
                if (!currentUser) return () => {};
                const q = collection(db, 'artifacts', appNamespace, 'users', currentUser.uid, collectionName);
                return onSnapshot(q, callback, (error) => { console.error("Firestore Error:", error); callback({ empty: true, forEach: () => {} }); });
            },
            subscribeQuery: (collectionName, field, op, value, callback) => {
                if (!currentUser) return () => {};
                const q = query(collection(db, 'artifacts', appNamespace, 'users', currentUser.uid, collectionName), where(field, op, value));
                return onSnapshot(q, callback, (error) => { console.error("Firestore Error:", error); callback({ empty: true, forEach: () => {} }); });
            },
            add: async (collectionName, data) => {
                if (!currentUser) throw new Error("User not authenticated");
                return addDoc(collection(db, 'artifacts', appNamespace, 'users', currentUser.uid, collectionName), data);
            },
            update: async (collectionName, id, data) => {
                if (!currentUser) throw new Error("User not authenticated");
                return updateDoc(doc(db, 'artifacts', appNamespace, 'users', currentUser.uid, collectionName, id), data);
            },
            delete: async (collectionName, id) => {
                if (!currentUser) throw new Error("User not authenticated");
                return deleteDoc(doc(db, 'artifacts', appNamespace, 'users', currentUser.uid, collectionName, id));
            }
        };

        const Utils = {
            getDailyVerse: () => {
                const verses = [
                    { text: "Learn to do right; seek justice. Defend the oppressed.", ref: "Isaiah 1:17" },
                    { text: "But let justice roll on like a river, righteousness like a never-failing stream!", ref: "Amos 5:24" },
                    { text: "Speak up for those who cannot speak for themselves...", ref: "Proverbs 31:8" }
                ];
                const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
                return verses[dayOfYear % verses.length];
            }
        };

        // --- CUSTOM MODAL CONTROLLER ---
        const Modal = {
            show: (options) => {
                const modal = document.getElementById('app-modal');
                document.getElementById('app-modal-title').innerHTML = options.title;
                document.getElementById('app-modal-body').innerHTML = options.content;
                const submitBtn = document.getElementById('app-modal-submit');
                submitBtn.innerText = options.submitText || 'Save';
                submitBtn.className = options.submitClass || 'px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium transition shadow-sm';
                submitBtn.onclick = async () => {
                    const originalText = submitBtn.innerText;
                    submitBtn.innerText = 'Processing...'; submitBtn.disabled = true;
                    try { await options.onSubmit(); modal.classList.add('hidden'); } 
                    catch (e) { console.error(e); alert("An error occurred."); } 
                    finally { submitBtn.innerText = originalText; submitBtn.disabled = false; }
                };
                modal.classList.remove('hidden');
            },
            hide: () => document.getElementById('app-modal').classList.add('hidden')
        };

        // --- VIEWS ---
        class DashboardView {
            constructor() { this.unsubscribe = null; }
            render() {
                const verse = Utils.getDailyVerse();
                return `
                    <div class="max-w-6xl mx-auto">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 space-y-6">
                                <div class="bg-gradient-to-r from-blue-800 to-slate-900 rounded-2xl p-8 text-white shadow-lg relative overflow-hidden">
                                    <i class="fas fa-balance-scale text-white opacity-5 text-9xl absolute -right-10 -bottom-10"></i>
                                    <h3 class="text-2xl font-bold serif-text mb-2 relative z-10">Welcome back, Counsel.</h3>
                                    <p class="text-blue-200 mb-6 relative z-10">Your journey to the Bar continues today.</p>
                                    <div class="bg-white/10 p-4 rounded-lg border border-white/10 backdrop-blur-sm relative z-10">
                                        <p class="serif-text italic text-lg mb-2">"${verse.text}"</p>
                                        <p class="text-sm text-amber-400 font-bold text-right">— ${verse.ref}</p>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                        <div class="flex items-center justify-between mb-4"><h4 class="font-bold text-slate-700">Upcoming</h4><i class="fas fa-calendar-alt text-blue-600"></i></div>
                                        <div id="dashboard-schedule-list" class="space-y-3"><p class="text-sm text-slate-400 italic">Loading schedule...</p></div>
                                    </div>
                                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                        <div class="flex items-center justify-between mb-4"><h4 class="font-bold text-slate-700">Study Streak</h4><i class="fas fa-fire text-amber-500"></i></div>
                                        <div class="text-center py-2"><span class="text-4xl font-bold text-slate-800">Active</span><p class="text-xs text-slate-500 mt-1">Keep pushing forward</p></div>
                                    </div>
                                </div>
                            </div>
                            <div class="lg:col-span-1">
                                <div class="bg-white rounded-xl shadow-sm border border-slate-100 h-full flex flex-col">
                                    <div class="p-5 border-b border-slate-100 flex justify-between items-center">
                                        <h4 class="font-bold text-slate-700">Reminders</h4>
                                        <button onclick="window.appHandlers.addReminder()" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100 transition"><i class="fas fa-plus mr-1"></i> Add</button>
                                    </div>
                                    <div id="reminder-list" class="flex-1 overflow-y-auto p-4 space-y-3 max-h-[500px]"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            async init() {
                const clockEl = document.getElementById('header-clock');
                if (clockEl) {
                    setInterval(() => {
                        const now = new Date();
                        clockEl.innerText = now.toLocaleTimeString('en-US', { hour12: true });
                        const dateEl = document.getElementById('header-date-display');
                        if (dateEl) dateEl.innerText = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                    }, 1000);
                }
                this.unsubscribe = AppDB.subscribe('reminders', (snapshot) => {
                    const list = document.getElementById('reminder-list');
                    const schedList = document.getElementById('dashboard-schedule-list');
                    if (!list) return;
                    list.innerHTML = ''; schedList.innerHTML = '';
                    if (snapshot.empty) {
                        list.innerHTML = `<div class="text-center py-8 text-slate-400 text-sm">No reminders set.</div>`;
                        schedList.innerHTML = `<div class="text-slate-400 text-sm">No upcoming events.</div>`;
                        return;
                    }
                    snapshot.forEach(doc => {
                        const data = doc.data(); const id = doc.id;
                        const date = data.date ? new Date(data.date).toLocaleDateString() : 'No Date';
                        const item = document.createElement('div');
                        item.className = `p-3 rounded-lg border-l-4 ${data.type === 'Quiz' ? 'border-red-500 bg-red-50' : 'border-blue-500 bg-blue-50'} flex justify-between items-start group`;
                        item.innerHTML = `<div><p class="text-sm font-semibold text-slate-800">${data.title}</p><p class="text-xs text-slate-500">${data.type} • ${date}</p></div><button onclick="window.appHandlers.deleteReminder('${id}')" class="text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-times"></i></button>`;
                        list.appendChild(item);
                        if (schedList.children.length < 3) {
                            const schedItem = document.createElement('div');
                            schedItem.className = "flex items-center gap-3 text-sm";
                            schedItem.innerHTML = `<div class="w-2 h-2 rounded-full ${data.type === 'Quiz' ? 'bg-red-500' : 'bg-blue-500'}"></div><span class="flex-1 truncate">${data.title}</span><span class="text-slate-400 text-xs">${date}</span>`;
                            schedList.appendChild(schedItem);
                        }
                    });
                });
            }
        }

        class SubjectsView {
            constructor() { this.unsubscribe = null; }
            render() {
                return `
                    <div class="max-w-5xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-slate-700">My Subjects</h3>
                            <button onclick="window.appHandlers.addSubject()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition shadow-md">
                                <i class="fas fa-plus mr-2"></i>New Subject
                            </button>
                        </div>
                        <div id="subjects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    </div>
                `;
            }
            init() {
                this.unsubscribe = AppDB.subscribe('subjects', (snapshot) => {
                    const grid = document.getElementById('subjects-grid');
                    if (!grid) return;
                    grid.innerHTML = '';
                    if (snapshot.empty) {
                        grid.innerHTML = `<div class="col-span-full text-center py-12 border-2 border-dashed border-slate-300 rounded-xl bg-white"><i class="fas fa-book-open text-4xl text-slate-300 mb-3"></i><p class="text-slate-500 mb-3">No subjects added yet.</p><button onclick="window.appHandlers.addSubject()" class="text-blue-600 font-bold hover:underline">Create Subject Notebook</button></div>`;
                        return;
                    }
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const card = document.createElement('div');
                        card.onclick = () => window.appHandlers.openSubject(doc.id, data.name.replace(/'/g, "\\'"));
                        card.className = "bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-blue-300 transition cursor-pointer group relative flex flex-col h-full";
                        card.innerHTML = `
                            <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition z-10">
                                <button onclick="event.stopPropagation(); window.appHandlers.deleteSubject('${doc.id}')" class="text-slate-400 hover:text-red-500 bg-white rounded-full p-1"><i class="fas fa-trash"></i></button>
                            </div>
                            <span class="inline-block self-start px-2 py-1 bg-blue-50 text-blue-700 text-xs rounded mb-3 font-bold tracking-wider uppercase">${data.year || 'General'}</span>
                            <h4 class="text-lg font-bold text-slate-800 mb-2 serif-text">${data.name}</h4>
                            <p class="text-sm text-slate-500 line-clamp-2 mb-4 flex-1">${data.description || 'Open notebook to view notes.'}</p>
                            <div class="pt-4 border-t border-slate-100 flex items-center justify-between mt-auto">
                                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider"><i class="fas fa-book mr-1"></i> Notebook</span>
                                <span class="text-blue-600 text-xs font-bold group-hover:translate-x-1 transition-transform">Open <i class="fas fa-arrow-right ml-1"></i></span>
                            </div>
                        `;
                        grid.appendChild(card);
                    });
                });
            }
        }

        class SubjectNotebookView {
            constructor() { this.unsubscribe = null; this.subjectId = null; this.subjectName = ""; this.activeNoteId = null; }
            render() {
                return `
                    <div class="h-[calc(100vh-4rem)] flex flex-col -m-8">
                        <div class="bg-white border-b border-slate-200 px-8 py-4 flex justify-between items-center flex-shrink-0 shadow-sm z-10">
                            <div class="flex items-center gap-4">
                                <button onclick="window.appHandlers.navigate('subjects')" class="text-slate-400 hover:text-blue-600 transition flex items-center gap-2 font-medium bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-200"><i class="fas fa-arrow-left"></i> Back to Subjects</button>
                                <h3 class="text-xl font-bold text-slate-800 serif-text">${this.subjectName}</h3>
                            </div>
                            <button onclick="window.appHandlers.addNote('${this.subjectId}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-sm">
                                <i class="fas fa-plus mr-2"></i>New Page
                            </button>
                        </div>
                        <div class="flex flex-1 overflow-hidden bg-slate-50">
                            <div class="w-72 bg-white border-r border-slate-200 overflow-y-auto flex flex-col shadow-sm z-0" id="notebook-pages-list">
                                <div class="p-8 text-center text-slate-400"><div class="loader mx-auto"></div></div>
                            </div>
                            <div class="flex-1 flex flex-col relative bg-slate-50/50" id="notebook-editor-area">
                                <div class="absolute inset-0 flex flex-col items-center justify-center text-slate-400">
                                    <i class="fas fa-book-open text-6xl mb-4 opacity-20"></i>
                                    <p class="font-medium text-slate-500">Select a page from the sidebar</p>
                                    <p class="text-sm mt-1">or create a new one to start taking notes.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            init(subjectId, subjectName) {
                this.subjectId = subjectId; this.subjectName = subjectName; this.activeNoteId = null; 
                document.getElementById('content-area').innerHTML = this.render();

                this.unsubscribe = AppDB.subscribeQuery('notes', 'subjectId', '==', subjectId, (snapshot) => {
                    const list = document.getElementById('notebook-pages-list');
                    if (!list) return;
                    list.innerHTML = '';

                    if (snapshot.empty) {
                        list.innerHTML = `<div class="p-8 text-center text-slate-400 text-sm mt-10"><i class="far fa-folder-open text-4xl mb-3 opacity-30"></i><br>Notebook is empty.</div>`;
                        return;
                    }

                    snapshot.forEach(doc => {
                        const data = doc.data(); const noteId = doc.id;
                        const isActive = this.activeNoteId === noteId;
                        const btn = document.createElement('button');
                        btn.className = `w-full text-left px-5 py-4 border-b border-slate-100 text-sm font-medium transition group flex justify-between items-center ${isActive ? 'bg-blue-50 text-blue-700 border-l-4 border-l-blue-600' : 'text-slate-600 hover:bg-slate-50 border-l-4 border-l-transparent'}`;
                        btn.innerHTML = `
                            <span class="truncate pr-2 flex items-center gap-2"><i class="far fa-file-alt opacity-50"></i> ${data.title}</span>
                            <i class="fas fa-trash text-slate-300 hover:text-red-500 transition px-2 py-1 opacity-0 group-hover:opacity-100" onclick="event.stopPropagation(); window.appHandlers.deleteNote('${noteId}')"></i>
                        `;
                        btn.onclick = () => window.appHandlers.openNote(noteId, data.title, data.content, btn);
                        list.appendChild(btn);
                    });
                });
            }
        }

        class DigestsView {
            constructor() { this.unsubscribe = null; }
            render() {
                return `
                    <div class="max-w-5xl mx-auto h-full flex flex-col">
                        <div class="flex justify-between items-center mb-6 flex-shrink-0">
                            <div>
                                <h3 class="text-xl font-bold text-slate-700">Consolidated Case Digests</h3>
                            </div>
                            <button onclick="window.appHandlers.addDigest()" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-md">
                                <i class="fas fa-plus mr-2"></i>Manual Digest
                            </button>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex-1 overflow-hidden flex flex-col">
                            <div id="digest-list" class="overflow-y-auto flex-1 p-6 space-y-4"></div>
                        </div>
                    </div>
                `;
            }
            init() {
                this.unsubscribe = AppDB.subscribe('digests', (snapshot) => {
                    const list = document.getElementById('digest-list');
                    if (!list) return;
                    list.innerHTML = '';
                    if(snapshot.empty) {
                        list.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-slate-400"><i class="fas fa-folder-open text-5xl mb-4 opacity-30"></i><p>No case digests found.</p></div>`;
                        return;
                    }
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const row = document.createElement('div');
                        row.className = "p-5 border border-slate-200 rounded-xl hover:border-blue-300 bg-slate-50 transition shadow-sm";
                        row.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div class="flex-1 pr-4">
                                    <h4 class="font-bold text-slate-800 serif-text text-lg leading-snug">${data.title}</h4>
                                    <span class="inline-block mt-2 bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-bold uppercase tracking-wider">${data.subject}</span>
                                </div>
                                <button onclick="window.appHandlers.deleteDigest('${doc.id}')" class="text-slate-300 hover:text-red-500 transition bg-white border border-slate-200 p-2 rounded shadow-sm"><i class="fas fa-trash"></i></button>
                            </div>
                            <details class="mt-4 group cursor-pointer outline-none">
                                <summary class="font-bold text-sm text-blue-600 hover:text-blue-800 outline-none list-none flex items-center gap-2 select-none border-t border-slate-200 pt-3">
                                    <div class="flex items-center gap-2 flex-1"><i class="fas fa-chevron-right text-xs transition-transform group-open:rotate-90"></i> Read Full Digest</div>
                                    <div class="flex gap-2">
                                        <button onclick="event.stopPropagation(); window.appHandlers.printDigest('${data.title.replace(/'/g, "\\'")}', '${(data.facts + data.issue + data.ruling).replace(/'/g, "\\'").replace(/\n/g, "")}')" class="text-xs text-slate-400 hover:text-blue-600 p-1"><i class="fas fa-print"></i></button>
                                        <button onclick="event.stopPropagation(); window.appHandlers.downloadText('${data.title}.txt', \`Title: ${data.title}\\nSubject: ${data.subject}\\n\\nFACTS:\\n${data.facts}\\n\\nISSUE:\\n${data.issue}\\n\\nRULING:\\n${data.ruling}\`)" class="text-xs text-slate-400 hover:text-blue-600 p-1"><i class="fas fa-download"></i></button>
                                    </div>
                                </summary>
                                <div class="mt-4 p-5 bg-white border border-slate-200 rounded-xl space-y-5 shadow-inner cursor-text text-sm">
                                    ${data.facts ? `<div><h5 class="font-bold text-slate-500 text-xs uppercase tracking-widest mb-2 border-b border-slate-100 pb-1">Facts</h5><p class="text-slate-700 leading-relaxed whitespace-pre-wrap">${data.facts}</p></div>` : ''}
                                    ${data.issue ? `<div><h5 class="font-bold text-slate-500 text-xs uppercase tracking-widest mb-2 border-b border-slate-100 pb-1">Issue</h5><p class="text-slate-800 font-semibold leading-relaxed whitespace-pre-wrap">${data.issue}</p></div>` : ''}
                                    <div><h5 class="font-bold text-slate-500 text-xs uppercase tracking-widest mb-2 border-b border-slate-100 pb-1">Ruling</h5><p class="text-slate-700 leading-relaxed whitespace-pre-wrap">${data.ruling || 'No ruling extracted.'}</p></div>
                                </div>
                            </details>
                        `;
                        list.appendChild(row);
                    });
                });
            }
        }

        class CaseDigesterView {
            constructor() { this.digestedData = null; }
            render() {
                const savedKey = localStorage.getItem('gemini_api_key') || '';
                return `
                    <div class="max-w-5xl mx-auto h-full flex flex-col">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-slate-700 flex items-center gap-2">
                                <i class="fas fa-magic text-amber-500"></i> AI Case Digester
                            </h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 flex-1 overflow-hidden">
                            <div class="md:col-span-1 bg-white p-6 rounded-xl shadow-sm border border-slate-200 overflow-y-auto flex flex-col gap-4">
                                <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                    <label class="block text-xs font-bold text-blue-800 mb-1"><i class="fas fa-key"></i> Gemini API Key</label>
                                    <input type="password" id="gemini-api-key" placeholder="Paste key here..." class="w-full p-2 border border-blue-200 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" value="${savedKey}">
                                </div>
                                <div><label class="block text-sm font-medium text-slate-700 mb-1">Case Title <span class="text-red-500">*</span></label><input type="text" id="digest-title" placeholder="e.g. People vs. Example" class="w-full p-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-amber-500 outline-none"></div>
                                <div><label class="block text-sm font-medium text-slate-700 mb-1">Subject Matter <span class="text-red-500">*</span></label><input type="text" id="digest-subject" placeholder="e.g. Crim 1" class="w-full p-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-amber-500 outline-none"></div>
                                <div class="border-t border-slate-100 pt-4"><label class="block text-sm font-medium text-slate-700 mb-1">Paste Full Text</label><textarea id="digest-textarea" rows="4" class="w-full p-2 border border-slate-200 rounded-lg text-sm resize-none focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Paste case text here..."></textarea></div>
                                <div class="text-center text-xs text-slate-400 font-bold uppercase tracking-wider my-1">- OR -</div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Upload PDF</label>
                                    <div class="border-2 border-dashed border-slate-300 rounded-lg p-4 text-center hover:bg-slate-50 transition cursor-pointer relative">
                                        <input type="file" accept=".pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="window.appHandlers.handleDigestUpload(this)">
                                        <i class="fas fa-file-pdf text-2xl text-red-400 mb-1"></i>
                                        <p class="text-xs text-slate-500">Click to upload PDF</p>
                                    </div>
                                    <div id="digest-filename" class="text-xs text-blue-600 mt-2 truncate hidden font-medium"></div>
                                </div>
                                <button onclick="window.appHandlers.processDigest()" id="btn-process-digest" class="w-full bg-slate-800 text-white py-3 rounded-lg text-sm font-bold hover:bg-slate-700 transition shadow-md mt-auto"><i class="fas fa-robot mr-1"></i> Digest & Auto-Save</button>
                            </div>
                            <div class="md:col-span-2 bg-slate-50 border border-slate-200 rounded-xl p-6 overflow-y-auto" id="digest-results-area">
                                <div class="h-full flex flex-col items-center justify-center text-slate-400 text-center">
                                    <i class="fas fa-brain text-5xl mb-4 opacity-20"></i>
                                    <p class="text-sm font-medium">Provide the case text and your API key.</p>
                                    <p class="text-xs mt-1">Gemini will read it, extract the core elements, and automatically save it.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        class ReviewView {
            constructor() {
                this.generatedContent = null;
                this.isProcessing = false;
            }
            render() {
                const savedKey = localStorage.getItem('gemini_api_key') || '';
                return `
                    <div class="max-w-5xl mx-auto h-full flex flex-col">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col h-full overflow-y-auto">
                                <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
                                    <i class="fas fa-graduation-cap text-blue-600"></i> AI Mock Review
                                </h3>

                                <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg mb-4">
                                    <label class="block text-xs font-bold text-blue-800 mb-1"><i class="fas fa-key"></i> Gemini API Key</label>
                                    <input type="password" id="review-api-key" placeholder="Paste key here..." class="w-full p-2 border border-blue-200 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" value="${savedKey}">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Paste Text <span class="text-xs text-slate-400 font-normal">(Best for Codals)</span></label>
                                    <textarea id="review-textarea" rows="4" class="w-full p-2 border border-slate-200 rounded-lg text-sm resize-none focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Paste provisions or notes here..." oninput="document.getElementById('btn-generate').disabled = false;"></textarea>
                                </div>

                                <div class="text-center text-xs text-slate-400 font-bold uppercase tracking-wider my-2">- OR -</div>

                                <div class="border-2 border-dashed border-slate-300 rounded-lg p-4 text-center hover:bg-slate-50 transition cursor-pointer relative" id="drop-zone">
                                    <input type="file" id="pdf-upload" accept=".pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="window.appHandlers.handleFileUpload(this)">
                                    <i class="fas fa-file-pdf text-2xl text-slate-400 mb-2"></i>
                                    <p class="text-sm font-medium text-slate-600">Upload text-searchable PDF</p>
                                </div>
                                <div id="file-name-display" class="mt-2 text-xs text-blue-600 font-medium truncate hidden"></div>

                                <div class="mt-4 space-y-3">
                                    <label class="block text-sm font-medium text-slate-700">Review Mode</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button onclick="window.appHandlers.setMode('recit')" id="btn-recit" class="px-4 py-2 rounded border border-slate-200 text-sm font-medium bg-slate-800 text-white transition">Recit (Flashcards)</button>
                                        <button onclick="window.appHandlers.setMode('exam')" id="btn-exam" class="px-4 py-2 rounded border border-slate-200 text-sm font-medium hover:bg-slate-50 text-slate-600 transition">Exam (Essay)</button>
                                    </div>
                                </div>

                                <button onclick="window.appHandlers.generateReview()" id="btn-generate" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold shadow-md transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    Generate AI Review
                                </button>
                            </div>

                            <div class="lg:col-span-2 bg-slate-200 rounded-xl border border-slate-300 p-6 overflow-y-auto flex flex-col relative" id="review-output">
                                <div class="absolute inset-0 flex flex-col items-center justify-center text-slate-500 pointer-events-none p-8 text-center">
                                    <i class="fas fa-brain text-4xl mb-4 opacity-50"></i>
                                    <h4 class="text-lg font-semibold">AI Mock Review</h4>
                                    <p class="text-sm max-w-xs mt-2">Paste text or upload a PDF to generate interactive practice questions based on your material.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // --- Saved Reviews View ---
        class SavedReviewsView {
            constructor() { this.unsubscribe = null; }
            render() {
                return `
                    <div class="max-w-5xl mx-auto h-full flex flex-col">
                        <div class="flex justify-between items-center mb-6 flex-shrink-0">
                            <h3 class="text-xl font-bold text-slate-700">My Saved Reviews</h3>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex-1 overflow-hidden flex flex-col">
                            <div id="saved-reviews-list" class="overflow-y-auto flex-1 p-6 space-y-4"></div>
                        </div>
                    </div>
                `;
            }
            init() {
                this.unsubscribe = AppDB.subscribe('reviews', (snapshot) => {
                    const list = document.getElementById('saved-reviews-list');
                    if (!list) return;
                    list.innerHTML = '';
                    
                    if (snapshot.empty) {
                        list.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-slate-400"><i class="fas fa-archive text-5xl mb-4 opacity-30"></i><p>No saved reviews yet.</p></div>`;
                        return;
                    }

                    window.appHandlers.savedExamData = {};

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const row = document.createElement('div');
                        row.className = "p-5 border border-slate-200 rounded-xl hover:border-blue-300 bg-slate-50 transition shadow-sm";

                        let contentHtml = '';
                        let textForDownload = '';

                        if (data.type === 'recit') {
                            contentHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
                            data.content.forEach((c, i) => {
                                textForDownload += `Q${i+1}: ${c.front}\nA: ${c.back}\n\n`;
                                contentHtml += `
                                    <div class="border border-slate-200 rounded-xl p-5 bg-white shadow-sm flex flex-col justify-between group">
                                        <div>
                                            <p class="text-[10px] text-blue-600 font-bold uppercase mb-2 tracking-widest">Q${i+1}</p>
                                            <p class="text-sm font-semibold text-slate-800 mb-4 leading-relaxed">${c.front}</p>
                                        </div>
                                        <details class="text-sm group-details cursor-pointer outline-none mt-auto border-t border-slate-100 pt-3">
                                            <summary class="text-xs text-amber-600 font-bold hover:text-amber-700 outline-none list-none select-none">(Reveal Answer)</summary>
                                            <div class="mt-3 p-3 bg-amber-50 rounded border border-amber-200 text-slate-700 leading-relaxed shadow-inner">${c.back}</div>
                                        </details>
                                    </div>`;
                            });
                            contentHtml += `</div>`;
                        } else {
                            window.appHandlers.savedExamData[doc.id] = data.content;
                            data.content.forEach((c, i) => {
                                textForDownload += `Question ${i+1}:\n${c.question}\n\nSuggested Guide:\n${c.suggested_answer}\n\n-----------------\n\n`;
                                contentHtml += `
                                    <div class="mb-8 p-5 bg-white border border-slate-200 rounded-xl shadow-sm">
                                        <h4 class="font-bold mb-3 text-lg font-sans text-blue-800">Question ${i+1}</h4>
                                        <p class="mb-5 leading-relaxed text-justify whitespace-pre-wrap">${c.question}</p>
                                        <textarea id="saved-exam-answer-${doc.id}-${i}" class="w-full p-4 border border-slate-200 rounded-lg font-sans text-sm focus:ring-0 outline-none resize-y min-h-[150px] shadow-inner bg-slate-50 placeholder-slate-400" placeholder="Type your answer here..."></textarea>
                                        <div class="mt-4">
                                            <button onclick="window.appHandlers.evaluateAnswer(${i}, '${doc.id}')" id="btn-eval-${doc.id}-${i}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition"><i class="fas fa-check-double mr-1"></i> Check Answer</button>
                                        </div>
                                        <div id="eval-result-${doc.id}-${i}" class="mt-4 hidden"></div>
                                        <details class="mt-5 font-sans text-sm group border-t border-slate-100 pt-4">
                                            <summary class="cursor-pointer text-amber-600 font-bold flex items-center gap-2 hover:text-amber-700 outline-none list-none"><i class="fas fa-lightbulb transition-transform group-open:text-green-500"></i> Show Suggested Answer</summary>
                                            <div class="mt-3 p-5 bg-amber-50 border border-amber-200 rounded-xl text-slate-800 leading-relaxed shadow-inner whitespace-pre-wrap">${c.suggested_answer}</div>
                                        </details>
                                    </div>`;
                            });
                        }

                        row.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div class="flex-1 pr-4">
                                    <h4 class="font-bold text-slate-800 serif-text text-lg leading-snug">${data.title}</h4>
                                    <span class="inline-block mt-2 ${data.type === 'recit' ? 'bg-amber-100 text-amber-800' : 'bg-blue-100 text-blue-800'} px-2 py-1 rounded text-xs font-bold uppercase tracking-wider">${data.type === 'recit' ? 'Flashcards' : 'Mock Exam'}</span>
                                </div>
                                <button onclick="window.appHandlers.deleteReview('${doc.id}')" class="text-slate-300 hover:text-red-500 transition bg-white border border-slate-200 p-2 rounded shadow-sm"><i class="fas fa-trash"></i></button>
                            </div>
                            <details class="mt-4 group cursor-pointer outline-none">
                                <summary class="font-bold text-sm text-blue-600 hover:text-blue-800 outline-none list-none flex items-center gap-2 select-none border-t border-slate-200 pt-3">
                                    <div class="flex items-center gap-2 flex-1"><i class="fas fa-chevron-right text-xs transition-transform group-open:rotate-90"></i> Open Material</div>
                                    <div class="flex gap-2">
                                        <button onclick="event.stopPropagation(); window.appHandlers.printContent('${data.title.replace(/'/g, "\\'")}', '<h1>${data.title}</h1><br>${textForDownload.replace(/\n/g, '<br>')}')" class="text-xs text-slate-400 hover:text-blue-600 p-1"><i class="fas fa-print"></i></button>
                                        <button onclick="event.stopPropagation(); window.appHandlers.downloadText('${data.title}.txt', \`${textForDownload.replace(/'/g, "\\'")}\`)" class="text-xs text-slate-400 hover:text-blue-600 p-1"><i class="fas fa-download"></i></button>
                                    </div>
                                </summary>
                                <div class="mt-4 cursor-text border-t border-slate-200 pt-4">
                                    ${contentHtml}
                                </div>
                            </details>
                        `;
                        list.appendChild(row);
                    });
                });
            }
        }

        const views = {
            dashboard: new DashboardView(),
            subjects: new SubjectsView(),
            subject_notebook: new SubjectNotebookView(),
            digests: new DigestsView(),
            case_digester: new CaseDigesterView(), 
            review: new ReviewView(),
            saved_reviews: new SavedReviewsView(),
            codals: { render: () => { window.open('https://www.ecodalplus.com/ecodals', '_blank'); return `<div class="text-center mt-20 text-slate-500">Opening eCodal+ in a new tab...</div>`; } },
        };

        const sidebarNav = document.querySelector('nav');
        const contentArea = document.getElementById('content-area');
        const pageTitle = document.getElementById('page-title');

        const navItems = [
            { id: 'dashboard', label: 'Dashboard', icon: 'fa-home' },
            { id: 'subjects', label: 'Subjects', icon: 'fa-book' },
            { id: 'codals', label: 'Codals', icon: 'fa-balance-scale' },
            { id: 'digests', label: 'Cons. Digests', icon: 'fa-gavel' },
            { id: 'case_digester', label: 'Case Digester', icon: 'fa-magic' },
            { id: 'review', label: 'Mock Review', icon: 'fa-graduation-cap' },
            { id: 'saved_reviews', label: 'Saved Reviews', icon: 'fa-archive' }
        ];

        function renderSidebar() {
            sidebarNav.innerHTML = navItems.map(item => `
                <a href="#" onclick="window.appHandlers.navigate('${item.id}')" 
                   class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors mb-1 
                   ${currentView === item.id ? 'bg-blue-600 text-white shadow-md' : 'text-slate-300 hover:bg-slate-800 hover:text-white'}">
                    <i class="fas ${item.icon} w-5 text-center"></i>
                    ${item.label}
                </a>
            `).join('');
        }

        window.appHandlers = {
            // --- PRINT & DOWNLOAD HELPERS ---
            printContent: (title, htmlContent) => {
                const printWindow = window.open('', '', 'height=600,width=800');
                printWindow.document.write('<html><head><title>'+title+'</title>');
                printWindow.document.write('<script src="https://cdn.tailwindcss.com"><\/script>');
                printWindow.document.write('</head><body class="p-10 font-sans">');
                printWindow.document.write(htmlContent);
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                setTimeout(() => printWindow.print(), 500); // Small delay to load styles
            },
            downloadText: (filename, textContent) => {
                const element = document.createElement('a');
                element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(textContent));
                element.setAttribute('download', filename);
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
            },

            // --- AUTHENTICATION ---
            login: async () => { try { await signInWithPopup(auth, provider); } catch (e) { alert("Login failed. Check Authorized Domains in Firebase Console."); } },
            logout: async () => { try { await signOut(auth); } catch (e) {} },

            // --- NAVIGATION ---
            navigate: (viewId) => {
                if (viewId === 'codals') { window.open('https://www.ecodalplus.com/ecodals', '_blank'); return; }
                if(views[currentView] && views[currentView].unsubscribe) views[currentView].unsubscribe();
                
                currentView = viewId; renderSidebar();
                const item = navItems.find(i => i.id === viewId);
                pageTitle.innerText = item ? item.label : 'App';
                
                if (views[viewId]) {
                    contentArea.innerHTML = views[viewId].render();
                    if (views[viewId].init) views[viewId].init();
                }
            },
            
            // --- NOTEBOOK ROUTING & LOGIC ---
            openSubject: (id, name) => {
                if(views[currentView] && views[currentView].unsubscribe) views[currentView].unsubscribe();
                currentView = 'subject_notebook';
                renderSidebar(); 
                pageTitle.innerText = 'Notebook';
                views.subject_notebook.init(id, name);
            },
            addNote: (subjectId) => {
                Modal.show({
                    title: '<i class="fas fa-file-alt text-blue-600"></i> New Page',
                    content: `<div><label class="block text-sm font-medium text-slate-700 mb-1">Page Title</label><input type="text" id="note-title" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="e.g., Article 1156"></div>`,
                    onSubmit: async () => {
                        const title = document.getElementById('note-title').value.trim() || 'Untitled Page';
                        await AppDB.add('notes', { subjectId, title, content: '', created: serverTimestamp() });
                    }
                });
            },
            openNote: (noteId, title, content, btnElement) => {
                views.subject_notebook.activeNoteId = noteId;
                document.querySelectorAll('#notebook-pages-list button').forEach(b => {
                    b.classList.remove('bg-blue-50', 'text-blue-700', 'border-l-blue-600');
                    b.classList.add('text-slate-600', 'border-l-transparent');
                });
                if(btnElement) {
                    btnElement.classList.remove('text-slate-600', 'border-l-transparent');
                    btnElement.classList.add('bg-blue-50', 'text-blue-700', 'border-l-blue-600');
                }

                const area = document.getElementById('notebook-editor-area');
                area.innerHTML = `
                    <div class="flex-1 flex flex-col p-8 bg-white m-6 rounded-2xl shadow-sm border border-slate-200">
                        <div class="flex justify-between items-center mb-6">
                            <input type="text" id="note-title-editor" class="text-3xl font-bold text-slate-800 border-none outline-none focus:ring-0 placeholder-slate-300 serif-text bg-transparent flex-1" value="${title}" placeholder="Page Title...">
                            <div class="flex gap-2">
                                <button onclick="window.appHandlers.printContent('${title}', document.getElementById('note-content-editor').value.replace(/\\n/g, '<br>'))" class="text-slate-400 hover:text-blue-600 p-2"><i class="fas fa-print"></i></button>
                                <button onclick="window.appHandlers.downloadText('${title}.txt', document.getElementById('note-content-editor').value)" class="text-slate-400 hover:text-blue-600 p-2"><i class="fas fa-download"></i></button>
                            </div>
                        </div>
                        <textarea id="note-content-editor" class="flex-1 w-full border-none outline-none resize-none text-slate-700 leading-relaxed text-base font-sans placeholder-slate-300 focus:ring-0 bg-transparent" placeholder="Start typing your notes here...">${content || ''}</textarea>
                        <div class="mt-4 flex justify-end items-center gap-4 pt-4 border-t border-slate-100">
                            <span id="note-save-status" class="text-sm font-bold text-green-500 opacity-0 transition-opacity"><i class="fas fa-check-circle mr-1"></i> Saved to Cloud</span>
                            <button onclick="window.appHandlers.saveNote('${noteId}')" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-bold transition shadow-md"><i class="fas fa-save mr-2"></i> Save Page</button>
                        </div>
                    </div>
                `;
            },
            saveNote: async (noteId) => {
                const title = document.getElementById('note-title-editor').value.trim() || 'Untitled Page';
                const content = document.getElementById('note-content-editor').value;
                const status = document.getElementById('note-save-status');
                try {
                    await AppDB.update('notes', noteId, { title, content, updated: serverTimestamp() });
                    status.classList.remove('opacity-0');
                    setTimeout(() => status.classList.add('opacity-0'), 3000);
                } catch(e) { alert("Error saving note."); }
            },
            deleteNote: (noteId) => {
                Modal.show({
                    title: '<i class="fas fa-trash text-red-500"></i> Delete Page',
                    content: '<p class="text-slate-600">Are you sure you want to delete this page permanently?</p>',
                    submitText: 'Delete', submitClass: 'px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700',
                    onSubmit: async () => {
                        await AppDB.delete('notes', noteId);
                        views.subject_notebook.activeNoteId = null;
                        document.getElementById('notebook-editor-area').innerHTML = `
                            <div class="absolute inset-0 flex flex-col items-center justify-center text-slate-400">
                                <i class="fas fa-book-open text-6xl mb-4 opacity-20"></i>
                                <p class="font-medium text-slate-500">Page deleted.</p>
                            </div>`;
                    }
                });
            },

            // --- DATABASE CRUD (MODALS) ---
            addReminder: () => {
                Modal.show({
                    title: '<i class="fas fa-bell text-amber-500"></i> New Reminder',
                    content: `<div><label class="block text-sm font-medium text-slate-700 mb-1">Title</label><input type="text" id="rem-title" class="w-full p-2 border border-slate-300 rounded-lg outline-none" placeholder="e.g., Read Obicon cases"></div><div class="mt-3"><label class="block text-sm font-medium text-slate-700 mb-1">Type</label><select id="rem-type" class="w-full p-2 border border-slate-300 rounded-lg outline-none"><option value="Assignment">Assignment</option><option value="Quiz">Quiz / Recit</option></select></div>`,
                    onSubmit: async () => {
                        const t = document.getElementById('rem-title').value.trim(); if (!t) return;
                        await AppDB.add('reminders', { title: t, type: document.getElementById('rem-type').value, date: new Date().toISOString(), created: serverTimestamp() });
                    }
                });
            },
            deleteReminder: (id) => {
                Modal.show({ title: '<i class="fas fa-check text-green-500"></i> Complete Task', content: '<p>Mark reminder as complete?</p>', submitText: 'Complete', submitClass: 'px-4 py-2 bg-green-600 text-white rounded-lg', onSubmit: async () => await AppDB.delete('reminders', id) });
            },
            addSubject: () => {
                Modal.show({
                    title: '<i class="fas fa-book text-blue-600"></i> New Subject',
                    content: `<div><label class="block text-sm font-medium text-slate-700 mb-1">Subject Name</label><input type="text" id="sub-name" class="w-full p-2 border border-slate-300 rounded-lg outline-none" placeholder="e.g., Obicon"></div><div class="mt-3"><label class="block text-sm font-medium text-slate-700 mb-1">Year</label><input type="text" id="sub-year" class="w-full p-2 border border-slate-300 rounded-lg outline-none" value="2L"></div><div class="mt-3"><label class="block text-sm font-medium text-slate-700 mb-1">Notes</label><textarea id="sub-desc" rows="2" class="w-full p-2 border border-slate-300 rounded-lg outline-none"></textarea></div>`,
                    onSubmit: async () => {
                        const n = document.getElementById('sub-name').value.trim(); if (!n) return;
                        await AppDB.add('subjects', { name: n, year: document.getElementById('sub-year').value.trim(), description: document.getElementById('sub-desc').value.trim(), created: serverTimestamp() });
                    }
                });
            },
            deleteSubject: (id) => {
                Modal.show({ title: '<i class="fas fa-trash text-red-500"></i> Delete', content: '<p>Remove subject?</p>', submitText: 'Delete', submitClass: 'px-4 py-2 bg-red-600 text-white rounded-lg', onSubmit: async () => await AppDB.delete('subjects', id) });
            },
            addDigest: () => {
                Modal.show({
                    title: '<i class="fas fa-gavel text-amber-700"></i> Manual Digest',
                    content: `<div><label class="block text-sm mb-1">Case Title</label><input type="text" id="dig-title" class="w-full p-2 border rounded-lg outline-none"></div><div class="mt-3"><label class="block text-sm mb-1">Subject</label><input type="text" id="dig-sub" class="w-full p-2 border rounded-lg outline-none"></div><div class="mt-3"><label class="block text-sm mb-1">Facts</label><textarea id="dig-facts" rows="2" class="w-full p-2 border rounded-lg outline-none"></textarea></div><div class="mt-3"><label class="block text-sm mb-1">Issue</label><textarea id="dig-issue" rows="2" class="w-full p-2 border rounded-lg outline-none"></textarea></div><div class="mt-3"><label class="block text-sm mb-1">Ruling</label><textarea id="dig-ruling" rows="2" class="w-full p-2 border rounded-lg outline-none"></textarea></div>`,
                    onSubmit: async () => {
                        const t = document.getElementById('dig-title').value.trim(); if (!t) return;
                        await AppDB.add('digests', { title: t, subject: document.getElementById('dig-sub').value, facts: document.getElementById('dig-facts').value, issue: document.getElementById('dig-issue').value, ruling: document.getElementById('dig-ruling').value, created: serverTimestamp() });
                    }
                });
            },
            deleteDigest: (id) => { Modal.show({ title: '<i class="fas fa-trash text-red-500"></i> Delete', content: '<p>Delete case digest?</p>', submitText: 'Delete', submitClass: 'px-4 py-2 bg-red-600 text-white rounded-lg', onSubmit: async () => await AppDB.delete('digests', id) }); },

            // --- AI CASE DIGESTER LOGIC ---
            digestText: '',
            handleDigestUpload: async (input) => {
                const file = input.files[0]; if (!file) return;
                const display = document.getElementById('digest-filename'); const btn = document.getElementById('btn-process-digest');
                display.innerText = file.name; display.classList.remove('hidden'); btn.innerText = "Reading PDF..."; btn.disabled = true; 
                try {
                    const arrayBuffer = await file.arrayBuffer(); const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let fullText = ""; const maxPages = Math.min(pdf.numPages, 10);
                    for (let i = 1; i <= maxPages; i++) { const page = await pdf.getPage(i); const textContent = await page.getTextContent(); fullText += textContent.items.map(item => item.str).join(' ') + "\n"; }
                    window.appHandlers.digestText = fullText; document.getElementById('digest-textarea').value = '';
                    btn.disabled = false; btn.innerHTML = '<i class="fas fa-robot mr-1"></i> Digest with Gemini';
                } catch (e) { alert("Failed to read PDF."); btn.innerHTML = "Error"; }
            },
            processDigest: async () => {
                const titleInput = document.getElementById('digest-title').value.trim();
                const subjectInput = document.getElementById('digest-subject').value.trim();
                const textAreaInput = document.getElementById('digest-textarea').value.trim();
                const apiKey = document.getElementById('gemini-api-key').value.trim();
                
                if (!apiKey) { alert("Please enter your Gemini API Key."); return; }
                localStorage.setItem('gemini_api_key', apiKey);
                if (!titleInput || !subjectInput) { alert("Please enter both the Case Title and Subject Matter."); return; }
                let textToDigest = textAreaInput || window.appHandlers.digestText;
                if (!textToDigest) { alert("Please paste the full text of the case or upload a PDF."); return; }

                const area = document.getElementById('digest-results-area');
                const btn = document.getElementById('btn-process-digest');
                btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Gemini is Digesting...';
                area.innerHTML = `<div class="flex justify-center h-full items-center flex-col"><div class="loader mb-4"></div><p class="text-slate-500 text-sm animate-pulse">Gemini is analyzing the case...</p></div>`;
                
                try {
                    const promptText = `
                        You are an expert law professor. Digest the following legal case text. 
                        Focus your extraction of the Facts, Issue, and Ruling strictly in relation to: "${subjectInput}".
                        Return the result STRICTLY as a raw JSON object with exactly three keys: "facts", "issue", and "ruling". 
                        Do NOT use markdown formatting like \`\`\`json. DO NOT add any other text.
                        
                        Case Text:
                        ${textToDigest.substring(0, 50000)}
                    `;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: promptText }] }], generationConfig: { responseMimeType: "application/json" } })
                    });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);

                    const data = await response.json();
                    let jsonString = data.candidates[0].content.parts[0].text;
                    jsonString = jsonString.replace(/^```json\s*/i, '').replace(/\s*```$/i, '').trim();
                    const parsedDigest = JSON.parse(jsonString);

                    const facts = parsedDigest.facts || "Facts not found.";
                    const issue = parsedDigest.issue || "Issue not found.";
                    const ruling = parsedDigest.ruling || "Ruling not found.";

                    await AppDB.add('digests', { title: titleInput, subject: subjectInput, facts: facts, issue: issue, ruling: ruling, created: serverTimestamp() });
                    
                    area.innerHTML = `
                        <div class="space-y-4">
                            <div class="bg-green-50 border border-green-200 text-green-700 p-4 rounded-xl flex items-center gap-4 shadow-sm animate-fade-in">
                                <i class="fas fa-check-circle text-3xl"></i>
                                <div class="flex-1"><p class="font-bold">Successfully Digested by Gemini!</p><p class="text-xs opacity-80">Saved to Cons. Digests.</p></div>
                                <button onclick="window.appHandlers.navigate('digests')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm">View</button>
                            </div>
                            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><h4 class="font-bold text-slate-700 text-xs tracking-wider uppercase mb-2">Facts</h4><p class="text-sm">${facts}</p></div>
                            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><h4 class="font-bold text-slate-700 text-xs tracking-wider uppercase mb-2">Issue</h4><p class="text-sm font-medium">${issue}</p></div>
                            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><h4 class="font-bold text-slate-700 text-xs tracking-wider uppercase mb-2">Ruling</h4><p class="text-sm">${ruling}</p></div>
                        </div>
                    `;
                } catch (error) {
                    area.innerHTML = `<div class="bg-red-50 text-red-700 p-4 rounded-xl border border-red-200">Error processing: ${error.message}</div>`;
                } finally {
                    btn.disabled = false; btn.innerHTML = '<i class="fas fa-robot mr-1"></i> Digest with Gemini'; window.appHandlers.digestText = '';
                }
            },

            // --- AI MOCK REVIEW LOGIC ---
            reviewMode: 'recit',
            pdfText: '',
            currentReviewData: null,
            savedExamData: {}, 
            
            setMode: (mode) => {
                window.appHandlers.reviewMode = mode;
                document.getElementById('btn-recit').className = mode === 'recit' ? "px-4 py-2 rounded border border-slate-200 text-sm font-medium bg-slate-800 text-white transition" : "px-4 py-2 rounded border border-slate-200 text-sm font-medium hover:bg-slate-50 text-slate-600 transition";
                document.getElementById('btn-exam').className = mode === 'exam' ? "px-4 py-2 rounded border border-slate-200 text-sm font-medium bg-slate-800 text-white transition" : "px-4 py-2 rounded border border-slate-200 text-sm font-medium hover:bg-slate-50 text-slate-600 transition";
            },
            handleFileUpload: async (input) => {
                const file = input.files[0];
                if (!file) return;

                document.getElementById('file-name-display').innerText = file.name;
                document.getElementById('file-name-display').classList.remove('hidden');
                document.getElementById('btn-generate').innerText = "Processing PDF...";
                document.getElementById('review-textarea').value = '';
                
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    
                    let fullText = "";
                    const maxPages = Math.min(pdf.numPages, 10);
                    
                    for (let i = 1; i <= maxPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        fullText += textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + "\n";
                    }

                    window.appHandlers.pdfText = fullText;
                    document.getElementById('btn-generate').disabled = false;
                    document.getElementById('btn-generate').innerText = "Generate AI Review";
                } catch (e) {
                    console.error(e); alert("Error reading PDF."); document.getElementById('btn-generate').innerText = "Error";
                }
            },
            
            generateReview: async () => {
                const textAreaInput = document.getElementById('review-textarea').value.trim();
                let text = textAreaInput || window.appHandlers.pdfText;
                
                const mode = window.appHandlers.reviewMode;
                const output = document.
