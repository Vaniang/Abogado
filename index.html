<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lex: Law School Companion</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .serif-text { font-family: 'Merriweather', serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #1e3a8a;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen flex overflow-hidden">

    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center text-white transition-opacity duration-300">
        <div class="w-16 h-16 bg-amber-600 rounded-2xl flex items-center justify-center text-3xl font-bold font-serif mb-6 shadow-lg">L</div>
        <h1 class="text-3xl font-bold mb-2 tracking-wide">LEX COMPANION</h1>
        <p class="text-slate-400 mb-8">Your 2L Journey, Synced Anywhere.</p>
        <button onclick="window.appHandlers.login()" class="bg-white text-slate-900 px-6 py-3 rounded-lg font-bold flex items-center gap-3 hover:bg-slate-100 transition shadow-xl">
            <i class="fab fa-google text-red-500"></i> Sign in with Google
        </button>
    </div>

    <aside class="w-64 bg-slate-900 text-white flex flex-col shadow-xl flex-shrink-0 transition-all duration-300" id="sidebar">
        <div class="p-6 border-b border-slate-800 flex items-center gap-3">
            <div class="w-10 h-10 bg-amber-600 rounded-lg flex items-center justify-center text-xl font-bold font-serif">L</div>
            <div>
                <h1 class="font-bold text-lg tracking-wide">LEX COMPANION</h1>
                <p class="text-xs text-slate-400">Juris Doctor Journey</p>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-4 space-y-1 px-3">
            </nav>

        <div class="p-4 border-t border-slate-800 space-y-3">
            <div class="flex items-center justify-between px-3 py-2 rounded bg-slate-800">
                <div class="flex items-center gap-3 overflow-hidden">
                    <div class="w-8 h-8 rounded-full bg-slate-600 flex items-center justify-center">
                        <i class="fas fa-user text-xs"></i>
                    </div>
                    <div class="overflow-hidden">
                        <p class="text-sm font-medium truncate" id="user-display">Student</p>
                        <p class="text-[10px] text-green-400"><i class="fas fa-cloud text-[10px]"></i> Cloud Sync Active</p>
                    </div>
                </div>
                <button onclick="window.appHandlers.logout()" class="text-slate-400 hover:text-red-400 transition" title="Log Out">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col min-w-0 bg-slate-50 relative">
        <header class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-8 flex-shrink-0">
            <h2 id="page-title" class="text-2xl font-bold text-slate-800 serif-text">Dashboard</h2>
            <div class="flex items-center gap-4">
                <span id="header-date-display" class="text-sm font-medium text-slate-600 hidden md:inline-block"></span>
                <span id="header-clock" class="text-sm font-mono text-slate-500 bg-slate-100 px-3 py-1 rounded">00:00:00</span>
            </div>
        </header>

        <div id="content-area" class="flex-1 overflow-y-auto p-8 relative">
            <div class="flex items-center justify-center h-full">
                <div class="loader"></div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        // IMPORT GOOGLE AUTH PROVIDER
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDxKEf2v5P2LN_a2BcR_ODYDGINZMmVPWk",
            authDomain: "abogado-ea708.firebaseapp.com",
            projectId: "abogado-ea708",
            storageBucket: "abogado-ea708.firebasestorage.app",
            messagingSenderId: "469135522184",
            appId: "1:469135522184:web:d7cf28de119011f282623d",
            measurementId: "G-CPJBKR7T59"
        };
        
        const appNamespace = 'law-companion-v1'; 
        
        // --- APP STATE ---
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app); 
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider(); // SETUP GOOGLE AUTH
        const db = getFirestore(app);
        
        let currentUser = null;
        let currentView = 'dashboard';

        // --- DATABASE ADAPTER (Strictly Cloud-Only Now) ---
        const AppDB = {
            subscribe: (collectionName, callback) => {
                if (!currentUser) return () => {};
                const q = collection(db, 'artifacts', appNamespace, 'users', currentUser.uid, collectionName);
                return onSnapshot(q, callback, (error) => {
                    console.error("Firestore Error:", error);
                    callback({ empty: true, forEach: () => {} }); 
                });
            },
            add: async (collectionName, data) => {
                if (!currentUser) throw new Error("User not authenticated");
                return addDoc(collection(db, 'artifacts', appNamespace, 'users', currentUser.uid, collectionName), data);
            },
            delete: async (collectionName, id) => {
                if (!currentUser) throw new Error("User not authenticated");
                return deleteDoc(doc(db, 'artifacts', appNamespace, 'users', currentUser.uid, collectionName, id));
            }
        };

        const verses = [
            { text: "Learn to do right; seek justice. Defend the oppressed. Take up the cause of the fatherless; plead the case of the widow.", ref: "Isaiah 1:17" },
            { text: "But let justice roll on like a river, righteousness like a never-failing stream!", ref: "Amos 5:24" },
            { text: "Speak up for those who cannot speak for themselves, for the rights of all who are destitute.", ref: "Proverbs 31:8" }
        ];

        const Utils = {
            formatDate: (date) => new Date(date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }),
            getDailyVerse: () => {
                const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
                return verses[dayOfYear % verses.length];
            }
        };

        // --- VIEW CONTROLLERS ---
        class DashboardView {
            constructor() { this.unsubscribe = null; }
            render() {
                const verse = Utils.getDailyVerse();
                return `
                    <div class="max-w-6xl mx-auto">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 space-y-6">
                                <div class="bg-gradient-to-r from-slate-800 to-slate-900 rounded-2xl p-8 text-white shadow-lg">
                                    <h3 class="text-2xl font-bold serif-text mb-2">Welcome back, Counsel.</h3>
                                    <p class="text-slate-300 mb-6">Your journey to the Bar continues today.</p>
                                    <div class="bg-white/10 p-4 rounded-lg border border-white/10 backdrop-blur-sm">
                                        <p class="serif-text italic text-lg mb-2">"${verse.text}"</p>
                                        <p class="text-sm text-amber-400 font-bold text-right">— ${verse.ref}</p>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                        <div class="flex items-center justify-between mb-4">
                                            <h4 class="font-bold text-slate-700">Upcoming</h4>
                                            <i class="fas fa-calendar-alt text-blue-600"></i>
                                        </div>
                                        <div id="dashboard-schedule-list" class="space-y-3">
                                            <p class="text-sm text-slate-400 italic">Loading schedule...</p>
                                        </div>
                                    </div>
                                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                        <div class="flex items-center justify-between mb-4">
                                            <h4 class="font-bold text-slate-700">Study Streak</h4>
                                            <i class="fas fa-fire text-amber-500"></i>
                                        </div>
                                        <div class="text-center py-2">
                                            <span class="text-4xl font-bold text-slate-800">Active</span>
                                            <p class="text-xs text-slate-500 mt-1">Keep pushing forward</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="lg:col-span-1">
                                <div class="bg-white rounded-xl shadow-sm border border-slate-100 h-full flex flex-col">
                                    <div class="p-5 border-b border-slate-100 flex justify-between items-center">
                                        <h4 class="font-bold text-slate-700">Reminders</h4>
                                        <button onclick="window.appHandlers.addReminder()" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100 transition">
                                            <i class="fas fa-plus mr-1"></i> Add
                                        </button>
                                    </div>
                                    <div id="reminder-list" class="flex-1 overflow-y-auto p-4 space-y-3 max-h-[500px]"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            async init() {
                const clockEl = document.getElementById('header-clock');
                if (clockEl) {
                    setInterval(() => {
                        const now = new Date();
                        clockEl.innerText = now.toLocaleTimeString('en-US', { hour12: true });
                        const dateEl = document.getElementById('header-date-display');
                        if (dateEl) dateEl.innerText = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                    }, 1000);
                }

                this.unsubscribe = AppDB.subscribe('reminders', (snapshot) => {
                    const list = document.getElementById('reminder-list');
                    const schedList = document.getElementById('dashboard-schedule-list');
                    if (!list) return;

                    list.innerHTML = '';
                    schedList.innerHTML = '';

                    if (snapshot.empty) {
                        list.innerHTML = `<div class="text-center py-8 text-slate-400 text-sm">No reminders set.</div>`;
                        schedList.innerHTML = `<div class="text-slate-400 text-sm">No upcoming events.</div>`;
                        return;
                    }

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const id = doc.id;
                        const date = data.date ? new Date(data.date).toLocaleDateString() : 'No Date';
                        
                        const item = document.createElement('div');
                        item.className = `p-3 rounded-lg border-l-4 ${data.type === 'Quiz' ? 'border-red-500 bg-red-50' : 'border-blue-500 bg-blue-50'} flex justify-between items-start group`;
                        item.innerHTML = `
                            <div>
                                <p class="text-sm font-semibold text-slate-800">${data.title}</p>
                                <p class="text-xs text-slate-500">${data.type} • ${date}</p>
                            </div>
                            <button onclick="window.appHandlers.deleteReminder('${id}')" class="text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        list.appendChild(item);

                        if (schedList.children.length < 3) {
                            const schedItem = document.createElement('div');
                            schedItem.className = "flex items-center gap-3 text-sm";
                            schedItem.innerHTML = `
                                <div class="w-2 h-2 rounded-full ${data.type === 'Quiz' ? 'bg-red-500' : 'bg-blue-500'}"></div>
                                <span class="flex-1 truncate">${data.title}</span>
                                <span class="text-slate-400 text-xs">${date}</span>
                            `;
                            schedList.appendChild(schedItem);
                        }
                    });
                });
            }
        }

        class SubjectsView {
            constructor() { this.unsubscribe = null; }
            render() {
                return `
                    <div class="max-w-5xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-slate-700">My Subjects</h3>
                            <button onclick="window.appHandlers.addSubject()" class="bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg text-sm transition shadow-md">
                                <i class="fas fa-plus mr-2"></i>New Subject
                            </button>
                        </div>
                        <div id="subjects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    </div>
                `;
            }

            init() {
                this.unsubscribe = AppDB.subscribe('subjects', (snapshot) => {
                    const grid = document.getElementById('subjects-grid');
                    if (!grid) return;
                    grid.innerHTML = '';

                    if (snapshot.empty) {
                        grid.innerHTML = `
                            <div class="col-span-full text-center py-12 border-2 border-dashed border-slate-300 rounded-xl">
                                <p class="text-slate-500 mb-2">No subjects added yet.</p>
                                <button onclick="window.appHandlers.addSubject()" class="text-blue-600 font-medium hover:underline">Add your first subject</button>
                            </div>
                        `;
                        return;
                    }

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const card = document.createElement('div');
                        card.className = "bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md transition cursor-pointer group relative";
                        card.innerHTML = `
                            <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition">
                                <button onclick="window.appHandlers.deleteSubject('${doc.id}')" class="text-slate-400 hover:text-red-500"><i class="fas fa-trash"></i></button>
                            </div>
                            <span class="inline-block px-2 py-1 bg-slate-100 text-slate-600 text-xs rounded mb-3 font-semibold tracking-wider uppercase">${data.year || 'General'}</span>
                            <h4 class="text-lg font-bold text-slate-800 mb-2 serif-text">${data.name}</h4>
                            <p class="text-sm text-slate-500 line-clamp-3 mb-4">${data.description || 'No notes added yet.'}</p>
                        `;
                        grid.appendChild(card);
                    });
                });
            }
        }

        class DigestsView {
            constructor() { this.unsubscribe = null; }
            render() {
                return `
                    <div class="max-w-4xl mx-auto h-full flex flex-col">
                        <div class="flex justify-between items-center mb-6 flex-shrink-0">
                            <h3 class="text-xl font-bold text-slate-700">Case Digests</h3>
                            <button onclick="window.appHandlers.addDigest()" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg text-sm transition shadow-md">
                                <i class="fas fa-gavel mr-2"></i>New Digest
                            </button>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex-1 overflow-hidden flex flex-col">
                            <div class="p-4 border-b border-slate-100 bg-slate-50 flex gap-4 text-sm font-semibold text-slate-600">
                                <div class="w-1/4">Case Title</div>
                                <div class="w-1/4">Subject</div>
                                <div class="w-1/2">Ruling Summary</div>
                            </div>
                            <div id="digest-list" class="overflow-y-auto flex-1 p-2"></div>
                        </div>
                    </div>
                `;
            }

            init() {
                this.unsubscribe = AppDB.subscribe('digests', (snapshot) => {
                    const list = document.getElementById('digest-list');
                    if (!list) return;
                    list.innerHTML = '';
                    
                    if(snapshot.empty) {
                        list.innerHTML = `<div class="p-8 text-center text-slate-400">No case digests found.</div>`;
                        return;
                    }

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const row = document.createElement('div');
                        row.className = "p-3 border-b border-slate-100 last:border-0 hover:bg-slate-50 flex gap-4 text-sm items-start transition";
                        row.innerHTML = `
                            <div class="w-1/4 font-semibold text-slate-800 serif-text">${data.title}</div>
                            <div class="w-1/4 text-slate-500"><span class="bg-slate-100 px-2 py-0.5 rounded text-xs">${data.subject}</span></div>
                            <div class="w-1/2 text-slate-600 line-clamp-2">${data.ruling}</div>
                            <button onclick="window.appHandlers.deleteDigest('${doc.id}')" class="text-slate-300 hover:text-red-500 ml-2"><i class="fas fa-trash"></i></button>
                        `;
                        list.appendChild(row);
                    });
                });
            }
        }

        const views = {
            dashboard: new DashboardView(),
            subjects: new SubjectsView(),
            digests: new DigestsView(),
            codals: { render: () => { window.open('https://www.ecodalplus.com/ecodals', '_blank'); return `<div class="text-center mt-20">Opening eCodal+ ...</div>`; } }
        };

        const sidebarNav = document.querySelector('nav');
        const contentArea = document.getElementById('content-area');
        const pageTitle = document.getElementById('page-title');

        const navItems = [
            { id: 'dashboard', label: 'Dashboard', icon: 'fa-home' },
            { id: 'subjects', label: 'Subjects', icon: 'fa-book' },
            { id: 'codals', label: 'Codals', icon: 'fa-balance-scale' },
            { id: 'digests', label: 'Cons. Digests', icon: 'fa-gavel' }
        ];

        function renderSidebar() {
            sidebarNav.innerHTML = navItems.map(item => `
                <a href="#" onclick="window.appHandlers.navigate('${item.id}')" 
                   class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors mb-1 
                   ${currentView === item.id ? 'bg-amber-600 text-white shadow-md' : 'text-slate-300 hover:bg-slate-800 hover:text-white'}">
                    <i class="fas ${item.icon} w-5 text-center"></i>
                    ${item.label}
                </a>
            `).join('');
        }

        window.appHandlers = {
            // AUTHENTICATION METHODS
            login: async () => {
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Login Error:", error);
                    alert("Failed to login: " + error.message);
                }
            },
            logout: async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Logout Error:", error);
                }
            },

            navigate: (viewId) => {
                if (viewId === 'codals') {
                    window.open('https://www.ecodalplus.com/ecodals', '_blank');
                    return;
                }
                
                if(views[currentView] && views[currentView].unsubscribe) {
                    views[currentView].unsubscribe();
                }

                currentView = viewId;
                renderSidebar();
                
                const item = navItems.find(i => i.id === viewId);
                pageTitle.innerText = item ? item.label : 'App';
                
                if (views[viewId]) {
                    contentArea.innerHTML = views[viewId].render();
                    if (views[viewId].init) views[viewId].init();
                }
            },

            addReminder: async () => {
                const title = prompt("Reminder Title:");
                if (!title) return;
                const type = confirm("Is this a Quiz? (Cancel for Assignment/Other)") ? "Quiz" : "Assignment";
                
                await AppDB.add('reminders', {
                    title, type,
                    date: new Date().toISOString(),
                    created: serverTimestamp()
                });
            },
            deleteReminder: async (id) => {
                if(confirm("Complete this task?")) await AppDB.delete('reminders', id);
            },

            addSubject: async () => {
                const name = prompt("Subject Name (e.g., Obicon):");
                if (!name) return;
                const year = prompt("Year Level (e.g., 2L):") || "2L";
                const desc = prompt("Short Note/Description:");

                await AppDB.add('subjects', {
                    name, year, description: desc, 
                    created: serverTimestamp()
                });
            },
            deleteSubject: async (id) => {
                if(confirm("Remove this subject?")) await AppDB.delete('subjects', id);
            },

            addDigest: async () => {
                const title = prompt("Case Title:");
                if(!title) return;
                const subject = prompt("Subject:");
                const ruling = prompt("Ruling Summary:");

                await AppDB.add('digests', {
                    title, subject, ruling, 
                    created: serverTimestamp()
                });
            },
            deleteDigest: async (id) => await AppDB.delete('digests', id)
        };

        // --- AUTHENTICATION LISTENER ---
        onAuthStateChanged(auth, (user) => {
            const loginScreen = document.getElementById('login-screen');
            if (user) {
                currentUser = user;
                // Set the user's name from their Google profile
                document.getElementById('user-display').innerText = user.displayName || "Counsel";
                
                // Hide login screen smoothly
                loginScreen.classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => loginScreen.classList.add('hidden'), 300);
                
                // Load Dashboard
                window.appHandlers.navigate('dashboard');
            } else {
                currentUser = null;
                // Cleanup current view subscriptions if logging out
                if(views[currentView] && views[currentView].unsubscribe) {
                    views[currentView].unsubscribe();
                }
                // Show login screen
                loginScreen.classList.remove('hidden', 'opacity-0', 'pointer-events-none');
            }
        });

    </script>
</body>
</html>
