<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lex: Law School Companion</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .serif-text { font-family: 'Merriweather', serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #1e3a8a;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen flex overflow-hidden">

    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center text-white transition-opacity duration-300">
        <div class="w-16 h-16 bg-amber-600 rounded-2xl flex items-center justify-center text-3xl font-bold font-serif mb-6 shadow-lg">L</div>
        <h1 class="text-3xl font-bold mb-2 tracking-wide">LEX COMPANION</h1>
        <p class="text-slate-400 mb-8">Your 2L Journey, Synced Anywhere.</p>
        <button onclick="window.appHandlers.login()" class="bg-white text-slate-900 px-6 py-3 rounded-lg font-bold flex items-center gap-3 hover:bg-slate-100 transition shadow-xl">
            <i class="fab fa-google text-red-500"></i> Sign in with Google
        </button>
    </div>

    <aside class="w-64 bg-slate-900 text-white flex flex-col shadow-xl flex-shrink-0 transition-all duration-300" id="sidebar">
        <div class="p-6 border-b border-slate-800 flex items-center gap-3">
            <div class="w-10 h-10 bg-amber-600 rounded-lg flex items-center justify-center text-xl font-bold font-serif">L</div>
            <div>
                <h1 class="font-bold text-lg tracking-wide">LEX COMPANION</h1>
                <p class="text-xs text-slate-400">Juris Doctor Journey</p>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-4 space-y-1 px-3">
            </nav>

        <div class="p-4 border-t border-slate-800 space-y-3">
            <div class="flex items-center justify-between px-3 py-2 rounded bg-slate-800">
                <div class="flex items-center gap-3 overflow-hidden">
                    <div class="w-8 h-8 rounded-full bg-slate-600 flex items-center justify-center">
                        <i class="fas fa-user text-xs"></i>
                    </div>
                    <div class="overflow-hidden">
                        <p class="text-sm font-medium truncate" id="user-display">Student</p>
                        <p class="text-[10px] text-green-400"><i class="fas fa-cloud text-[10px]"></i> Cloud Sync Active</p>
                    </div>
                </div>
                <button onclick="window.appHandlers.logout()" class="text-slate-400 hover:text-red-400 transition" title="Log Out">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col min-w-0 bg-slate-50 relative">
        <header class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-8 flex-shrink-0">
            <h2 id="page-title" class="text-2xl font-bold text-slate-800 serif-text">Dashboard</h2>
            <div class="flex items-center gap-4">
                <span id="header-date-display" class="text-sm font-medium text-slate-600 hidden md:inline-block"></span>
                <span id="header-clock" class="text-sm font-mono text-slate-500 bg-slate-100 px-3 py-1 rounded">00:00:00</span>
            </div>
        </header>

        <div id="content-area" class="flex-1 overflow-y-auto p-8 relative">
            <div class="flex items-center justify-center h-full">
                <div class="loader"></div>
            </div>
        </div>
    </main>

    <div id="app-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4 transition-all duration-200">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all duration-200" id="app-modal-card">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 id="app-modal-title" class="font-bold text-slate-800 text-lg flex items-center gap-2">Modal Title</h3>
                <button onclick="document.getElementById('app-modal').classList.add('hidden')" class="text-slate-400 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
            </div>
            <div id="app-modal-body" class="p-6 space-y-4">
                </div>
            <div class="px-6 py-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                <button onclick="document.getElementById('app-modal').classList.add('hidden')" class="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-lg text-sm font-medium transition">Cancel</button>
                <button id="app-modal-submit" class="px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 text-sm font-medium transition shadow-sm">Save</button>
            </div>
        </div>
    </div>

   <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDxKEf2v5P2LN_a2BcR_ODYDGINZMmVPWk",
            authDomain: "abogado-ea708.firebaseapp.com",
            projectId: "abogado-ea708",
            storageBucket: "abogado-ea708.firebasestorage.app",
            messagingSenderId: "469135522184",
            appId: "1:469135522184:web:d7cf28de119011f282623d",
            measurementId: "G-CPJBKR7T59"
        };
        
        const appNamespace = 'law-companion-v1'; 
        
        // --- APP STATE ---
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app); 
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const db = getFirestore(app);
        
        let currentUser = null;
        let currentView = 'dashboard';

        // --- DATABASE ADAPTER (Cloud-Only) ---
        const AppDB = {
            subscribe: (collectionName, callback) => {
                if (!currentUser) return () => {};
                const q = collection(db, 'artifacts', appNamespace, 'users', currentUser.uid, collectionName);
                return onSnapshot(q, callback, (error) => {
                    console.error("Firestore Error:", error);
                    callback({ empty: true, forEach: () => {} }); 
                });
            },
            add: async (collectionName, data) => {
                if (!currentUser) throw new Error("User not authenticated");
                return addDoc(collection(db, 'artifacts', appNamespace, 'users', currentUser.uid, collectionName), data);
            },
            delete: async (collectionName, id) => {
                if (!currentUser) throw new Error("User not authenticated");
                return deleteDoc(doc(db, 'artifacts', appNamespace, 'users', currentUser.uid, collectionName, id));
            }
        };

        const verses = [
            { text: "Learn to do right; seek justice. Defend the oppressed. Take up the cause of the fatherless; plead the case of the widow.", ref: "Isaiah 1:17" },
            { text: "But let justice roll on like a river, righteousness like a never-failing stream!", ref: "Amos 5:24" },
            { text: "Speak up for those who cannot speak for themselves, for the rights of all who are destitute.", ref: "Proverbs 31:8" },
            { text: "He has shown you, O mortal, what is good. And what does the Lord require of you? To act justly and to love mercy and to walk humbly with your God.", ref: "Micah 6:8" },
            { text: "Blessed are those who observe justice, who do righteousness at all times!", ref: "Psalm 106:3" },
            { text: "For the Lord is a God of justice; blessed are all those who wait for him.", ref: "Isaiah 30:18" }
        ];

        const Utils = {
            formatDate: (date) => new Date(date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }),
            getDailyVerse: () => {
                const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
                return verses[dayOfYear % verses.length];
            }
        };

        // --- VIEW CONTROLLERS ---
        class DashboardView {
            constructor() { this.unsubscribe = null; }
            render() {
                const verse = Utils.getDailyVerse();
                return `
                    <div class="max-w-6xl mx-auto">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 space-y-6">
                                <div class="bg-gradient-to-r from-slate-800 to-slate-900 rounded-2xl p-8 text-white shadow-lg">
                                    <h3 class="text-2xl font-bold serif-text mb-2">Welcome back, Counsel.</h3>
                                    <p class="text-slate-300 mb-6">Your journey to the Bar continues today.</p>
                                    <div class="bg-white/10 p-4 rounded-lg border border-white/10 backdrop-blur-sm">
                                        <p class="serif-text italic text-lg mb-2">"${verse.text}"</p>
                                        <p class="text-sm text-amber-400 font-bold text-right">— ${verse.ref}</p>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                        <div class="flex items-center justify-between mb-4">
                                            <h4 class="font-bold text-slate-700">Upcoming</h4>
                                            <i class="fas fa-calendar-alt text-blue-600"></i>
                                        </div>
                                        <div id="dashboard-schedule-list" class="space-y-3">
                                            <p class="text-sm text-slate-400 italic">Loading schedule...</p>
                                        </div>
                                    </div>
                                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                        <div class="flex items-center justify-between mb-4">
                                            <h4 class="font-bold text-slate-700">Study Streak</h4>
                                            <i class="fas fa-fire text-amber-500"></i>
                                        </div>
                                        <div class="text-center py-2">
                                            <span class="text-4xl font-bold text-slate-800">Active</span>
                                            <p class="text-xs text-slate-500 mt-1">Keep pushing forward</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="lg:col-span-1">
                                <div class="bg-white rounded-xl shadow-sm border border-slate-100 h-full flex flex-col">
                                    <div class="p-5 border-b border-slate-100 flex justify-between items-center">
                                        <h4 class="font-bold text-slate-700">Reminders</h4>
                                        <button onclick="window.appHandlers.addReminder()" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100 transition">
                                            <i class="fas fa-plus mr-1"></i> Add
                                        </button>
                                    </div>
                                    <div id="reminder-list" class="flex-1 overflow-y-auto p-4 space-y-3 max-h-[500px]"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            async init() {
                const clockEl = document.getElementById('header-clock');
                if (clockEl) {
                    setInterval(() => {
                        const now = new Date();
                        clockEl.innerText = now.toLocaleTimeString('en-US', { hour12: true });
                        const dateEl = document.getElementById('header-date-display');
                        if (dateEl) dateEl.innerText = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                    }, 1000);
                }

                this.unsubscribe = AppDB.subscribe('reminders', (snapshot) => {
                    const list = document.getElementById('reminder-list');
                    const schedList = document.getElementById('dashboard-schedule-list');
                    if (!list) return;

                    list.innerHTML = '';
                    schedList.innerHTML = '';

                    if (snapshot.empty) {
                        list.innerHTML = `<div class="text-center py-8 text-slate-400 text-sm">No reminders set.</div>`;
                        schedList.innerHTML = `<div class="text-slate-400 text-sm">No upcoming events.</div>`;
                        return;
                    }

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const id = doc.id;
                        const date = data.date ? new Date(data.date).toLocaleDateString() : 'No Date';
                        
                        const item = document.createElement('div');
                        item.className = `p-3 rounded-lg border-l-4 ${data.type === 'Quiz' ? 'border-red-500 bg-red-50' : 'border-blue-500 bg-blue-50'} flex justify-between items-start group`;
                        item.innerHTML = `
                            <div>
                                <p class="text-sm font-semibold text-slate-800">${data.title}</p>
                                <p class="text-xs text-slate-500">${data.type} • ${date}</p>
                            </div>
                            <button onclick="window.appHandlers.deleteReminder('${id}')" class="text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        list.appendChild(item);

                        if (schedList.children.length < 3) {
                            const schedItem = document.createElement('div');
                            schedItem.className = "flex items-center gap-3 text-sm";
                            schedItem.innerHTML = `
                                <div class="w-2 h-2 rounded-full ${data.type === 'Quiz' ? 'bg-red-500' : 'bg-blue-500'}"></div>
                                <span class="flex-1 truncate">${data.title}</span>
                                <span class="text-slate-400 text-xs">${date}</span>
                            `;
                            schedList.appendChild(schedItem);
                        }
                    });
                });
            }
        }

        class SubjectsView {
            constructor() { this.unsubscribe = null; }
            render() {
                return `
                    <div class="max-w-5xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-slate-700">My Subjects</h3>
                            <button onclick="window.appHandlers.addSubject()" class="bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg text-sm transition shadow-md">
                                <i class="fas fa-plus mr-2"></i>New Subject
                            </button>
                        </div>
                        <div id="subjects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    </div>
                `;
            }

            init() {
                this.unsubscribe = AppDB.subscribe('subjects', (snapshot) => {
                    const grid = document.getElementById('subjects-grid');
                    if (!grid) return;
                    grid.innerHTML = '';

                    if (snapshot.empty) {
                        grid.innerHTML = `
                            <div class="col-span-full text-center py-12 border-2 border-dashed border-slate-300 rounded-xl">
                                <p class="text-slate-500 mb-2">No subjects added yet.</p>
                                <button onclick="window.appHandlers.addSubject()" class="text-blue-600 font-medium hover:underline">Add your first subject</button>
                            </div>
                        `;
                        return;
                    }

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const card = document.createElement('div');
                        card.className = "bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md transition cursor-pointer group relative";
                        card.innerHTML = `
                            <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition">
                                <button onclick="window.appHandlers.deleteSubject('${doc.id}')" class="text-slate-400 hover:text-red-500"><i class="fas fa-trash"></i></button>
                            </div>
                            <span class="inline-block px-2 py-1 bg-slate-100 text-slate-600 text-xs rounded mb-3 font-semibold tracking-wider uppercase">${data.year || 'General'}</span>
                            <h4 class="text-lg font-bold text-slate-800 mb-2 serif-text">${data.name}</h4>
                            <p class="text-sm text-slate-500 line-clamp-3 mb-4">${data.description || 'No notes added yet.'}</p>
                        `;
                        grid.appendChild(card);
                    });
                });
            }
        }

        class DigestsView {
            constructor() { this.unsubscribe = null; }
            render() {
                return `
                    <div class="max-w-4xl mx-auto h-full flex flex-col">
                        <div class="flex justify-between items-center mb-6 flex-shrink-0">
                            <h3 class="text-xl font-bold text-slate-700">Case Digests</h3>
                            <button onclick="window.appHandlers.addDigest()" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg text-sm transition shadow-md">
                                <i class="fas fa-gavel mr-2"></i>New Digest
                            </button>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex-1 overflow-hidden flex flex-col">
                            <div class="p-4 border-b border-slate-100 bg-slate-50 flex gap-4 text-sm font-semibold text-slate-600">
                                <div class="w-1/4">Case Title</div>
                                <div class="w-1/4">Subject</div>
                                <div class="w-1/2">Ruling Summary</div>
                            </div>
                            <div id="digest-list" class="overflow-y-auto flex-1 p-2"></div>
                        </div>
                    </div>
                `;
            }

            init() {
                this.unsubscribe = AppDB.subscribe('digests', (snapshot) => {
                    const list = document.getElementById('digest-list');
                    if (!list) return;
                    list.innerHTML = '';
                    
                    if(snapshot.empty) {
                        list.innerHTML = `<div class="p-8 text-center text-slate-400">No case digests found.</div>`;
                        return;
                    }

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const row = document.createElement('div');
                        row.className = "p-3 border-b border-slate-100 last:border-0 hover:bg-slate-50 flex gap-4 text-sm items-start transition";
                        row.innerHTML = `
                            <div class="w-1/4 font-semibold text-slate-800 serif-text">${data.title}</div>
                            <div class="w-1/4 text-slate-500"><span class="bg-slate-100 px-2 py-0.5 rounded text-xs">${data.subject}</span></div>
                            <div class="w-1/2 text-slate-600 line-clamp-2">${data.ruling}</div>
                            <button onclick="window.appHandlers.deleteDigest('${doc.id}')" class="text-slate-300 hover:text-red-500 ml-2"><i class="fas fa-trash"></i></button>
                        `;
                        list.appendChild(row);
                    });
                });
            }
        }

        class CaseDigesterView {
            constructor() { this.digestedData = null; }
            render() {
                return `
                    <div class="max-w-4xl mx-auto h-full flex flex-col">
                        <h3 class="text-xl font-bold text-slate-700 mb-6 flex items-center gap-2">
                            <i class="fas fa-magic text-amber-500"></i> AI Case Digester
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 flex-1 overflow-hidden">
                            <div class="md:col-span-1 bg-white p-6 rounded-xl shadow-sm border border-slate-200 overflow-y-auto">
                                <label class="block text-sm font-medium text-slate-700 mb-1">Subject Matter</label>
                                <input type="text" id="digest-subject" placeholder="e.g. Criminal Law" class="w-full p-2 border border-slate-200 rounded text-sm mb-4">
                                
                                <label class="block text-sm font-medium text-slate-700 mb-1">Case Upload</label>
                                <div class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center hover:bg-slate-50 transition cursor-pointer relative mb-4">
                                    <input type="file" accept=".pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="window.appHandlers.handleDigestUpload(this)">
                                    <i class="fas fa-file-pdf text-3xl text-red-400 mb-2"></i>
                                    <p class="text-xs text-slate-500">Upload Full Text PDF</p>
                                </div>
                                <div id="digest-filename" class="text-xs text-blue-600 mb-4 truncate hidden"></div>
                                
                                <button onclick="window.appHandlers.processDigest()" id="btn-process-digest" class="w-full bg-slate-800 text-white py-2 rounded text-sm font-medium hover:bg-slate-700 transition disabled:opacity-50" disabled>
                                    <i class="fas fa-robot mr-1"></i> Digest Case
                                </button>
                            </div>

                            <div class="md:col-span-2 bg-slate-50 border border-slate-200 rounded-xl p-6 overflow-y-auto" id="digest-results-area">
                                <div class="h-full flex flex-col items-center justify-center text-slate-400 text-center">
                                    <i class="fas fa-file-invoice text-4xl mb-3 opacity-30"></i>
                                    <p class="text-sm">Upload a case file to extract the<br>Facts, Issue, and Ruling.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        class ReviewView {
            constructor() {
                this.generatedContent = null;
                this.isProcessing = false;
            }
            render() {
                return `
                    <div class="max-w-5xl mx-auto h-full flex flex-col">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col h-full">
                                <h3 class="font-bold text-lg text-slate-800 mb-4">Material Upload</h3>
                                
                                <div class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center hover:bg-slate-50 transition cursor-pointer relative" id="drop-zone">
                                    <input type="file" id="pdf-upload" accept=".pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="window.appHandlers.handleFileUpload(this)">
                                    <i class="fas fa-cloud-upload-alt text-3xl text-slate-400 mb-3"></i>
                                    <p class="text-sm font-medium text-slate-600">Click to upload PDF</p>
                                    <p class="text-xs text-slate-400 mt-1">Lecture notes, reviewers, or codals</p>
                                </div>
                                <div id="file-name-display" class="mt-2 text-xs text-blue-600 font-medium truncate hidden"></div>

                                <div class="mt-6 space-y-3">
                                    <label class="block text-sm font-medium text-slate-700">Review Mode</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button onclick="window.appHandlers.setMode('recit')" id="btn-recit" class="px-4 py-2 rounded border border-slate-200 text-sm font-medium hover:bg-slate-50 bg-slate-800 text-white transition">Recit (Flashcards)</button>
                                        <button onclick="window.appHandlers.setMode('exam')" id="btn-exam" class="px-4 py-2 rounded border border-slate-200 text-sm font-medium hover:bg-slate-50 text-slate-600 transition">Exam (Essay)</button>
                                    </div>
                                </div>

                                <button onclick="window.appHandlers.generateReview()" id="btn-generate" class="mt-auto w-full bg-amber-600 hover:bg-amber-700 text-white py-3 rounded-lg font-medium shadow-md transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    Generate Review
                                </button>
                            </div>

                            <div class="lg:col-span-2 bg-slate-200 rounded-xl border border-slate-300 p-6 overflow-y-auto flex flex-col relative" id="review-output">
                                <div class="absolute inset-0 flex flex-col items-center justify-center text-slate-500 pointer-events-none p-8 text-center">
                                    <i class="fas fa-brain text-4xl mb-4 opacity-50"></i>
                                    <h4 class="text-lg font-semibold">AI Mock Review</h4>
                                    <p class="text-sm max-w-xs mt-2">Upload a PDF to generate practice questions or flashcards based on your material.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        const views = {
            dashboard: new DashboardView(),
            subjects: new SubjectsView(),
            digests: new DigestsView(),
            case_digester: new CaseDigesterView(), 
            review: new ReviewView(),
            codals: { render: () => { window.open('https://www.ecodalplus.com/ecodals', '_blank'); return `<div class="text-center mt-20">Opening eCodal+ ...</div>`; } },
            cons_subject: new SubjectsView()
        };

        const sidebarNav = document.querySelector('nav');
        const contentArea = document.getElementById('content-area');
        const pageTitle = document.getElementById('page-title');

        const navItems = [
            { id: 'dashboard', label: 'Dashboard', icon: 'fa-home' },
            { id: 'subjects', label: 'Subjects', icon: 'fa-book' },
            { id: 'codals', label: 'Codals', icon: 'fa-balance-scale' },
            { id: 'digests', label: 'Cons. Digests', icon: 'fa-gavel' },
            { id: 'case_digester', label: 'Case Digester', icon: 'fa-magic' }, 
            { id: 'cons_subject', label: 'Cons. Subjects', icon: 'fa-layer-group' },
            { id: 'review', label: 'Mock Review', icon: 'fa-graduation-cap' }
        ];

        function renderSidebar() {
            sidebarNav.innerHTML = navItems.map(item => `
                <a href="#" onclick="window.appHandlers.navigate('${item.id}')" 
                   class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors mb-1 
                   ${currentView === item.id ? 'bg-amber-600 text-white shadow-md' : 'text-slate-300 hover:bg-slate-800 hover:text-white'}">
                    <i class="fas ${item.icon} w-5 text-center"></i>
                    ${item.label}
                </a>
            `).join('');
        }

        window.appHandlers = {
            // --- AUTHENTICATION METHODS ---
            login: async () => {
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Login Error:", error);
                    alert("Failed to login: " + error.message);
                }
            },
            logout: async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Logout Error:", error);
                }
            },

            // --- NAVIGATION ---
            navigate: (viewId) => {
                if (viewId === 'codals') {
                    window.open('https://www.ecodalplus.com/ecodals', '_blank');
                    return;
                }
                
                if(views[currentView] && views[currentView].unsubscribe) {
                    views[currentView].unsubscribe();
                }

                currentView = viewId;
                renderSidebar();
                
                const item = navItems.find(i => i.id === viewId);
                pageTitle.innerText = item ? item.label : 'App';
                
                if (views[viewId]) {
                    contentArea.innerHTML = views[viewId].render();
                    if (views[viewId].init) views[viewId].init();
                }
            },

            // --- DATABASE ACTIONS ---
            addReminder: async () => {
                const title = prompt("Reminder Title:");
                if (!title) return;
                const type = confirm("Is this a Quiz? (Cancel for Assignment/Other)") ? "Quiz" : "Assignment";
                
                await AppDB.add('reminders', {
                    title, type,
                    date: new Date().toISOString(),
                    created: serverTimestamp()
                });
            },
            deleteReminder: async (id) => {
                if(confirm("Complete this task?")) await AppDB.delete('reminders', id);
            },

            addSubject: async () => {
                const name = prompt("Subject Name (e.g., Obicon):");
                if (!name) return;
                const year = prompt("Year Level (e.g., 2L):") || "2L";
                const desc = prompt("Short Note/Description:");

                await AppDB.add('subjects', {
                    name, year, description: desc, 
                    created: serverTimestamp()
                });
            },
            deleteSubject: async (id) => {
                if(confirm("Remove this subject?")) await AppDB.delete('subjects', id);
            },

            addDigest: async () => {
                const title = prompt("Case Title:");
                if(!title) return;
                const subject = prompt("Subject:");
                const ruling = prompt("Ruling Summary:");

                await AppDB.add('digests', {
                    title, subject, ruling, 
                    created: serverTimestamp()
                });
            },
            deleteDigest: async (id) => await AppDB.delete('digests', id),

            // --- CASE DIGESTER LOGIC ---
            digestText: '',
            handleDigestUpload: async (input) => {
                const file = input.files[0];
                if (!file) return;
                
                const display = document.getElementById('digest-filename');
                const btn = document.getElementById('btn-process-digest');
                display.innerText = file.name;
                display.classList.remove('hidden');
                btn.innerText = "Reading PDF...";
                
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    
                    let fullText = "";
                    const maxPages = Math.min(pdf.numPages, 10);
                    for (let i = 1; i <= maxPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + "\n";
                    }
                    window.appHandlers.digestText = fullText;
                    btn.disabled = false;
                    btn.innerText = "Digest Case";
                } catch (e) {
                    console.error(e);
                    alert("Failed to read PDF.");
                    btn.innerText = "Error";
                }
            },
            processDigest: () => {
                const text = window.appHandlers.digestText;
                const area = document.getElementById('digest-results-area');
                const subject = document.getElementById('digest-subject').value || "General";
                
                area.innerHTML = `<div class="flex justify-center h-full items-center"><div class="loader"></div></div>`;
                
                setTimeout(() => {
                    let facts = "Unable to automatically extract facts. Please verify the document structure.";
                    let issue = "Unable to determine the main issue.";
                    let ruling = "Ruling could not be isolated.";
                    
                    const issueIdx = text.search(/Whether|Issue|WHETHER|ISSUE/);
                    const rulingIdx = text.search(/Held|Ruling|HELD|RULING|WHEREFORE/);
                    
                    if (issueIdx > -1) {
                        facts = text.substring(0, issueIdx).substring(0, 500) + "..."; 
                        if (rulingIdx > -1) {
                            issue = text.substring(issueIdx, rulingIdx).substring(0, 300) + "...";
                            ruling = text.substring(rulingIdx).substring(0, 500) + "...";
                        } else {
                            issue = text.substring(issueIdx).substring(0, 300) + "...";
                        }
                    } else {
                        const chunks = text.match(/.{1,500}/g) || [];
                        facts = chunks[0] || "";
                        issue = chunks[1] || "";
                        ruling = chunks[2] || "";
                    }

                    window.pendingDigest = { title: "New Case Digest", subject, ruling: ruling.substring(0,100) + "..." };
                    
                    area.innerHTML = `
                        <div class="space-y-4">
                            <div class="bg-white p-4 rounded border-l-4 border-blue-500 shadow-sm">
                                <h4 class="font-bold text-slate-700 mb-2 uppercase text-xs">Facts of the Case</h4>
                                <p class="text-sm text-slate-600 leading-relaxed">${facts}</p>
                            </div>
                            <div class="bg-white p-4 rounded border-l-4 border-amber-500 shadow-sm">
                                <h4 class="font-bold text-slate-700 mb-2 uppercase text-xs">Issue</h4>
                                <p class="text-sm text-slate-600 leading-relaxed font-semibold">${issue}</p>
                            </div>
                            <div class="bg-white p-4 rounded border-l-4 border-green-500 shadow-sm">
                                <h4 class="font-bold text-slate-700 mb-2 uppercase text-xs">Ruling</h4>
                                <p class="text-sm text-slate-600 leading-relaxed">${ruling}</p>
                            </div>
                            <button onclick="window.appHandlers.saveDigestedCase()" class="w-full py-2 bg-slate-800 text-white rounded text-sm hover:bg-slate-700 transition">
                                <i class="fas fa-save mr-2"></i> Save to Digests
                            </button>
                        </div>
                    `;
                }, 1500);
            },
            saveDigestedCase: async () => {
                if (window.pendingDigest) {
                    const title = prompt("Enter Case Title:", "People vs. Example");
                    if (title) {
                        window.pendingDigest.title = title;
                        await AppDB.add('digests', { ...window.pendingDigest, created: serverTimestamp() });
                        alert("Case saved to 'Cons. Digests'!");
                        window.appHandlers.navigate('digests');
                    }
                }
            },

            // --- MOCK REVIEW LOGIC ---
            reviewMode: 'recit',
            pdfText: '',
            setMode: (mode) => {
                window.appHandlers.reviewMode = mode;
                document.getElementById('btn-recit').className = mode === 'recit' ? "px-4 py-2 rounded border border-slate-200 text-sm font-medium bg-slate-800 text-white transition" : "px-4 py-2 rounded border border-slate-200 text-sm font-medium hover:bg-slate-50 text-slate-600 transition";
                document.getElementById('btn-exam').className = mode === 'exam' ? "px-4 py-2 rounded border border-slate-200 text-sm font-medium bg-slate-800 text-white transition" : "px-4 py-2 rounded border border-slate-200 text-sm font-medium hover:bg-slate-50 text-slate-600 transition";
            },
            handleFileUpload: async (input) => {
                const file = input.files[0];
                if (!file) return;

                document.getElementById('file-name-display').innerText = file.name;
                document.getElementById('file-name-display').classList.remove('hidden');
                document.getElementById('btn-generate').innerText = "Processing PDF...";
                
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    
                    let fullText = "";
                    const maxPages = Math.min(pdf.numPages, 10);
                    
                    for (let i = 1; i <= maxPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + "\n";
                    }

                    window.appHandlers.pdfText = fullText;
                    document.getElementById('btn-generate').disabled = false;
                    document.getElementById('btn-generate').innerText = "Generate Review";
                } catch (e) {
                    console.error(e);
                    alert("Error reading PDF. Please try a text-heavy PDF.");
                    document.getElementById('btn-generate').innerText = "Error";
                }
            },
            generateReview: () => {
                const text = window.appHandlers.pdfText;
                const mode = window.appHandlers.reviewMode;
                const output = document.getElementById('review-output');
                
                output.innerHTML = `<div class="flex justify-center p-10"><div class="loader"></div></div>`;

                setTimeout(() => {
                    output.innerHTML = '';
                    
                    const sentences = text.match(/[^\.!\?]+[\.!\?]+/g) || [];
                    const meaningfulSentences = sentences.filter(s => s.length > 50 && (s.includes('court') || s.includes('law') || s.includes('act') || s.includes('is') || s.includes('shall')));

                    if (mode === 'recit') {
                        const cards = [];
                        meaningfulSentences.forEach((s, idx) => {
                            if (cards.length >= 10) return;
                            if (idx % 3 === 0) { 
                                cards.push({
                                    front: `Based on the text, discuss the concept mentioned in this context: "...${s.substring(0, 40)}..."`,
                                    back: s
                                });
                            }
                        });
                        
                        if(cards.length === 0) cards.push({front: "No clear definitions found.", back: "Try a different PDF."});

                        output.innerHTML = `<h3 class="font-bold text-xl mb-4 sticky top-0 bg-slate-200 py-2">Flashcards (${cards.length})</h3>`;
                        const grid = document.createElement('div');
                        grid.className = "grid grid-cols-1 md:grid-cols-2 gap-4";
                        
                        cards.forEach((card, i) => {
                            const el = document.createElement('div');
                            el.className = "bg-white p-6 rounded-xl shadow-sm border border-slate-300 cursor-pointer hover:shadow-md transition flex flex-col justify-between min-h-[160px] group perspective";
                            el.onclick = function() {
                                this.querySelector('.card-inner').classList.toggle('hidden');
                                this.querySelector('.card-back').classList.toggle('hidden');
                            };
                            el.innerHTML = `
                                <div class="card-inner">
                                    <span class="text-xs text-blue-600 font-bold uppercase mb-2 block">Card ${i+1}</span>
                                    <p class="serif-text font-medium text-slate-800">${card.front}</p>
                                    <p class="text-xs text-slate-400 mt-4 text-center">(Click to reveal)</p>
                                </div>
                                <div class="card-back hidden animate-fade-in">
                                    <span class="text-xs text-green-600 font-bold uppercase mb-2 block">Answer</span>
                                    <p class="text-sm text-slate-700 leading-relaxed">${card.back}</p>
                                </div>
                            `;
                            grid.appendChild(el);
                        });
                        output.appendChild(grid);

                    } else {
                        const words = text.match(/\b[A-Z][a-z]+ [A-Z][a-z]+\b/g) || ["The Doctrine"];
                        const uniqueTerms = [...new Set(words)].slice(0, 5);
                        
                        output.innerHTML = `<h3 class="font-bold text-xl mb-4 sticky top-0 bg-slate-200 py-2">Bar Exam Simulation</h3>`;
                        const paper = document.createElement('div');
                        paper.className = "bg-white p-8 rounded shadow-sm border border-slate-300 min-h-[500px] serif-text";
                        
                        let html = `<div class="text-center border-b-2 border-black pb-4 mb-6">
                            <h2 class="text-2xl font-bold uppercase">Mock Bar Examination</h2>
                            <p class="italic">Subject: Review of Uploaded Material</p>
                        </div>`;

                        uniqueTerms.forEach((term, i) => {
                            html += `
                                <div class="mb-8">
                                    <p class="font-bold mb-2">Question ${i+1}</p>
                                    <p class="mb-4 leading-loose text-justify">
                                        Analyze the legal implications of <strong>${term}</strong> as presented in the materials. 
                                        Discuss its application in contemporary jurisprudence and distinguish it from related concepts. 
                                        Cite specific provisions or doctrines where applicable.
                                    </p>
                                    <textarea class="w-full p-3 border border-slate-200 rounded bg-slate-50 font-sans text-sm" rows="4" placeholder="Type your answer here..."></textarea>
                                </div>
                            `;
                        });
                        paper.innerHTML = html;
                        output.appendChild(paper);
                    }
                }, 1500);
            }
        };

        // --- AUTHENTICATION LISTENER ---
        onAuthStateChanged(auth, (user) => {
            const loginScreen = document.getElementById('login-screen');
            if (user) {
                currentUser = user;
                document.getElementById('user-display').innerText = user.displayName || "Counsel";
                
                loginScreen.classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => loginScreen.classList.add('hidden'), 300);
              // --- CUSTOM MODAL CONTROLLER ---
        const Modal = {
            show: (options) => {
                const modal = document.getElementById('app-modal');
                document.getElementById('app-modal-title').innerHTML = options.title;
                document.getElementById('app-modal-body').innerHTML = options.content;
                
                const submitBtn = document.getElementById('app-modal-submit');
                submitBtn.innerText = options.submitText || 'Save';
                submitBtn.className = options.submitClass || 'px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 text-sm font-medium transition shadow-sm';
                
                submitBtn.onclick = async () => {
                    const originalText = submitBtn.innerText;
                    submitBtn.innerText = 'Processing...';
                    submitBtn.disabled = true;
                    try {
                        await options.onSubmit();
                        modal.classList.add('hidden');
                    } catch (e) {
                        console.error(e);
                        alert("An error occurred.");
                    } finally {
                        submitBtn.innerText = originalText;
                        submitBtn.disabled = false;
                    }
                };
                
                modal.classList.remove('hidden');
            },
            hide: () => document.getElementById('app-modal').classList.add('hidden')
        };

        window.appHandlers = {
            // --- AUTHENTICATION METHODS ---
            login: async () => {
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Login Error:", error);
                    alert("Failed to login: " + error.message);
                }
            },
            logout: async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Logout Error:", error);
                }
            },

            // --- NAVIGATION ---
            navigate: (viewId) => {
                if (viewId === 'codals') {
                    window.open('https://www.ecodalplus.com/ecodals', '_blank');
                    return;
                }
                if(views[currentView] && views[currentView].unsubscribe) {
                    views[currentView].unsubscribe();
                }
                currentView = viewId;
                renderSidebar();
                
                const item = navItems.find(i => i.id === viewId);
                pageTitle.innerText = item ? item.label : 'App';
                
                if (views[viewId]) {
                    contentArea.innerHTML = views[viewId].render();
                    if (views[viewId].init) views[viewId].init();
                }
            },

            // --- DATABASE ACTIONS ---
            addReminder: () => {
                Modal.show({
                    title: '<i class="fas fa-bell text-amber-500"></i> New Reminder',
                    content: `
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Title</label>
                            <input type="text" id="rem-title" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="e.g., Read Obicon cases">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Type</label>
                            <select id="rem-type" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none bg-white">
                                <option value="Assignment">Assignment / Reading</option>
                                <option value="Quiz">Quiz / Recit Prep</option>
                            </select>
                        </div>
                    `,
                    onSubmit: async () => {
                        const title = document.getElementById('rem-title').value.trim();
                        const type = document.getElementById('rem-type').value;
                        if (!title) return;
                        
                        await AppDB.add('reminders', {
                            title, type,
                            date: new Date().toISOString(),
                            created: serverTimestamp()
                        });
                    }
                });
            },
            deleteReminder: (id) => {
                Modal.show({
                    title: '<i class="fas fa-check-circle text-green-500"></i> Complete Task',
                    content: '<p class="text-slate-600">Are you sure you want to mark this reminder as complete?</p>',
                    submitText: 'Complete',
                    submitClass: 'px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium transition shadow-sm',
                    onSubmit: async () => await AppDB.delete('reminders', id)
                });
            },

            addSubject: () => {
                Modal.show({
                    title: '<i class="fas fa-book text-blue-600"></i> New Subject',
                    content: `
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Subject Name</label>
                            <input type="text" id="sub-name" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="e.g., Obligations and Contracts">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Year Level</label>
                            <input type="text" id="sub-year" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="e.g., 2L" value="2L">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Description / Notes</label>
                            <textarea id="sub-desc" rows="3" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none resize-none" placeholder="Short note about the class..."></textarea>
                        </div>
                    `,
                    onSubmit: async () => {
                        const name = document.getElementById('sub-name').value.trim();
                        const year = document.getElementById('sub-year').value.trim() || '2L';
                        const desc = document.getElementById('sub-desc').value.trim();
                        if (!name) return;

                        await AppDB.add('subjects', { name, year, description: desc, created: serverTimestamp() });
                    }
                });
            },
            deleteSubject: (id) => {
                Modal.show({
                    title: '<i class="fas fa-exclamation-triangle text-red-500"></i> Remove Subject',
                    content: '<p class="text-slate-600">Are you sure you want to remove this subject? This action cannot be undone.</p>',
                    submitText: 'Delete',
                    submitClass: 'px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-medium transition shadow-sm',
                    onSubmit: async () => await AppDB.delete('subjects', id)
                });
            },

            addDigest: () => {
                Modal.show({
                    title: '<i class="fas fa-gavel text-amber-700"></i> Manual Case Digest',
                    content: `
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Case Title</label>
                            <input type="text" id="dig-title" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="e.g., People vs. Example">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Subject</label>
                            <input type="text" id="dig-sub" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="e.g., Crim 1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Ruling / Doctrine</label>
                            <textarea id="dig-ruling" rows="4" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none resize-none" placeholder="Summarize the court's decision..."></textarea>
                        </div>
                    `,
                    onSubmit: async () => {
                        const title = document.getElementById('dig-title').value.trim();
                        const subject = document.getElementById('dig-sub').value.trim();
                        const ruling = document.getElementById('dig-ruling').value.trim();
                        if (!title) return;

                        await AppDB.add('digests', { title, subject, ruling, created: serverTimestamp() });
                    }
                });
            },
            deleteDigest: (id) => {
                 Modal.show({
                    title: '<i class="fas fa-trash text-red-500"></i> Delete Digest',
                    content: '<p class="text-slate-600">Are you sure you want to delete this case digest?</p>',
                    submitText: 'Delete',
                    submitClass: 'px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-medium transition shadow-sm',
                    onSubmit: async () => await AppDB.delete('digests', id)
                });
            },

            // --- CASE DIGESTER LOGIC ---
            digestText: '',
            handleDigestUpload: async (input) => {
                const file = input.files[0];
                if (!file) return;
                
                const display = document.getElementById('digest-filename');
                const btn = document.getElementById('btn-process-digest');
                display.innerText = file.name;
                display.classList.remove('hidden');
                btn.innerText = "Reading PDF...";
                
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    
                    let fullText = "";
                    const maxPages = Math.min(pdf.numPages, 10);
                    for (let i = 1; i <= maxPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + "\n";
                    }
                    window.appHandlers.digestText = fullText;
                    btn.disabled = false;
                    btn.innerText = "Digest Case";
                } catch (e) {
                    console.error(e);
                    alert("Failed to read PDF.");
                    btn.innerText = "Error";
                }
            },
            processDigest: () => {
                const text = window.appHandlers.digestText;
                const area = document.getElementById('digest-results-area');
                const subject = document.getElementById('digest-subject').value || "General";
                
                area.innerHTML = `<div class="flex justify-center h-full items-center"><div class="loader"></div></div>`;
                
                setTimeout(() => {
                    let facts = "Unable to automatically extract facts. Please verify the document structure.";
                    let issue = "Unable to determine the main issue.";
                    let ruling = "Ruling could not be isolated.";
                    
                    const issueIdx = text.search(/Whether|Issue|WHETHER|ISSUE/);
                    const rulingIdx = text.search(/Held|Ruling|HELD|RULING|WHEREFORE/);
                    
                    if (issueIdx > -1) {
                        facts = text.substring(0, issueIdx).substring(0, 500) + "..."; 
                        if (rulingIdx > -1) {
                            issue = text.substring(issueIdx, rulingIdx).substring(0, 300) + "...";
                            ruling = text.substring(rulingIdx).substring(0, 500) + "...";
                        } else {
                            issue = text.substring(issueIdx).substring(0, 300) + "...";
                        }
                    } else {
                        const chunks = text.match(/.{1,500}/g) || [];
                        facts = chunks[0] || "";
                        issue = chunks[1] || "";
                        ruling = chunks[2] || "";
                    }

                    window.pendingDigest = { title: "New Case Digest", subject, ruling: ruling.substring(0,100) + "..." };
                    
                    area.innerHTML = `
                        <div class="space-y-4">
                            <div class="bg-white p-4 rounded border-l-4 border-blue-500 shadow-sm">
                                <h4 class="font-bold text-slate-700 mb-2 uppercase text-xs">Facts of the Case</h4>
                                <p class="text-sm text-slate-600 leading-relaxed">${facts}</p>
                            </div>
                            <div class="bg-white p-4 rounded border-l-4 border-amber-500 shadow-sm">
                                <h4 class="font-bold text-slate-700 mb-2 uppercase text-xs">Issue</h4>
                                <p class="text-sm text-slate-600 leading-relaxed font-semibold">${issue}</p>
                            </div>
                            <div class="bg-white p-4 rounded border-l-4 border-green-500 shadow-sm">
                                <h4 class="font-bold text-slate-700 mb-2 uppercase text-xs">Ruling</h4>
                                <p class="text-sm text-slate-600 leading-relaxed">${ruling}</p>
                            </div>
                            <button onclick="window.appHandlers.saveDigestedCase()" class="w-full py-2 bg-slate-800 text-white rounded text-sm hover:bg-slate-700 transition">
                                <i class="fas fa-save mr-2"></i> Save to Digests
                            </button>
                        </div>
                    `;
                }, 1500);
            },
            saveDigestedCase: () => {
                if (window.pendingDigest) {
                    Modal.show({
                        title: '<i class="fas fa-save text-blue-600"></i> Save AI Digest',
                        content: `
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Confirm Case Title</label>
                                <input type="text" id="ai-dig-title" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="e.g., People vs. Example" value="New Case Digest">
                            </div>
                        `,
                        onSubmit: async () => {
                            const title = document.getElementById('ai-dig-title').value.trim();
                            if (title) {
                                window.pendingDigest.title = title;
                                await AppDB.add('digests', { ...window.pendingDigest, created: serverTimestamp() });
                                window.appHandlers.navigate('digests');
                            }
                        }
                    });
                }
            },

            // --- MOCK REVIEW LOGIC ---
            reviewMode: 'recit',
            pdfText: '',
            setMode: (mode) => {
                window.appHandlers.reviewMode = mode;
                document.getElementById('btn-recit').className = mode === 'recit' ? "px-4 py-2 rounded border border-slate-200 text-sm font-medium bg-slate-800 text-white transition" : "px-4 py-2 rounded border border-slate-200 text-sm font-medium hover:bg-slate-50 text-slate-600 transition";
                document.getElementById('btn-exam').className = mode === 'exam' ? "px-4 py-2 rounded border border-slate-200 text-sm font-medium bg-slate-800 text-white transition" : "px-4 py-2 rounded border border-slate-200 text-sm font-medium hover:bg-slate-50 text-slate-600 transition";
            },
            handleFileUpload: async (input) => {
                const file = input.files[0];
                if (!file) return;

                document.getElementById('file-name-display').innerText = file.name;
                document.getElementById('file-name-display').classList.remove('hidden');
                document.getElementById('btn-generate').innerText = "Processing PDF...";
                
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    
                    let fullText = "";
                    const maxPages = Math.min(pdf.numPages, 10);
                    
                    for (let i = 1; i <= maxPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + "\n";
                    }

                    window.appHandlers.pdfText = fullText;
                    document.getElementById('btn-generate').disabled = false;
                    document.getElementById('btn-generate').innerText = "Generate Review";
                } catch (e) {
                    console.error(e);
                    alert("Error reading PDF. Please try a text-heavy PDF.");
                    document.getElementById('btn-generate').innerText = "Error";
                }
            },
            generateReview: () => {
                const text = window.appHandlers.pdfText;
                const mode = window.appHandlers.reviewMode;
                const output = document.getElementById('review-output');
                
                output.innerHTML = `<div class="flex justify-center p-10"><div class="loader"></div></div>`;

                setTimeout(() => {
                    output.innerHTML = '';
                    
                    const sentences = text.match(/[^\.!\?]+[\.!\?]+/g) || [];
                    const meaningfulSentences = sentences.filter(s => s.length > 50 && (s.includes('court') || s.includes('law') || s.includes('act') || s.includes('is') || s.includes('shall')));

                    if (mode === 'recit') {
                        const cards = [];
                        meaningfulSentences.forEach((s, idx) => {
                            if (cards.length >= 10) return;
                            if (idx % 3 === 0) { 
                                cards.push({
                                    front: `Based on the text, discuss the concept mentioned in this context: "...${s.substring(0, 40)}..."`,
                                    back: s
                                });
                            }
                        });
                        
                        if(cards.length === 0) cards.push({front: "No clear definitions found.", back: "Try a different PDF."});

                        output.innerHTML = `<h3 class="font-bold text-xl mb-4 sticky top-0 bg-slate-200 py-2">Flashcards (${cards.length})</h3>`;
                        const grid = document.createElement('div');
                        grid.className = "grid grid-cols-1 md:grid-cols-2 gap-4";
                        
                        cards.forEach((card, i) => {
                            const el = document.createElement('div');
                            el.className = "bg-white p-6 rounded-xl shadow-sm border border-slate-300 cursor-pointer hover:shadow-md transition flex flex-col justify-between min-h-[160px] group perspective";
                            el.onclick = function() {
                                this.querySelector('.card-inner').classList.toggle('hidden');
                                this.querySelector('.card-back').classList.toggle('hidden');
                            };
                            el.innerHTML = `
                                <div class="card-inner">
                                    <span class="text-xs text-blue-600 font-bold uppercase mb-2 block">Card ${i+1}</span>
                                    <p class="serif-text font-medium text-slate-800">${card.front}</p>
                                    <p class="text-xs text-slate-400 mt-4 text-center">(Click to reveal)</p>
                                </div>
                                <div class="card-back hidden animate-fade-in">
                                    <span class="text-xs text-green-600 font-bold uppercase mb-2 block">Answer</span>
                                    <p class="text-sm text-slate-700 leading-relaxed">${card.back}</p>
                                </div>
                            `;
                            grid.appendChild(el);
                        });
                        output.appendChild(grid);

                    } else {
                        const words = text.match(/\b[A-Z][a-z]+ [A-Z][a-z]+\b/g) || ["The Doctrine"];
                        const uniqueTerms = [...new Set(words)].slice(0, 5);
                        
                        output.innerHTML = `<h3 class="font-bold text-xl mb-4 sticky top-0 bg-slate-200 py-2">Bar Exam Simulation</h3>`;
                        const paper = document.createElement('div');
                        paper.className = "bg-white p-8 rounded shadow-sm border border-slate-300 min-h-[500px] serif-text";
                        
                        let html = `<div class="text-center border-b-2 border-black pb-4 mb-6">
                            <h2 class="text-2xl font-bold uppercase">Mock Bar Examination</h2>
                            <p class="italic">Subject: Review of Uploaded Material</p>
                        </div>`;

                        uniqueTerms.forEach((term, i) => {
                            html += `
                                <div class="mb-8">
                                    <p class="font-bold mb-2">Question ${i+1}</p>
                                    <p class="mb-4 leading-loose text-justify">
                                        Analyze the legal implications of <strong>${term}</strong> as presented in the materials. 
                                        Discuss its application in contemporary jurisprudence and distinguish it from related concepts. 
                                        Cite specific provisions or doctrines where applicable.
                                    </p>
                                    <textarea class="w-full p-3 border border-slate-200 rounded bg-slate-50 font-sans text-sm" rows="4" placeholder="Type your answer here..."></textarea>
                                </div>
                            `;
                        });
                        paper.innerHTML = html;
                        output.appendChild(paper);
                    }
                }, 1500);
            }
        };
        });

    </script>
</body>
</html>
