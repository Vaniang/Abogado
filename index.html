<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lex: Law School Companion</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF.js for parsing uploaded files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts: Merriweather for reading, Inter for UI -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .serif-text { font-family: 'Merriweather', serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #1e3a8a;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen flex overflow-hidden">

    <!-- Sidebar Navigation -->
    <aside class="w-64 bg-slate-900 text-white flex flex-col shadow-xl flex-shrink-0 transition-all duration-300" id="sidebar">
        <div class="p-6 border-b border-slate-800 flex items-center gap-3">
            <div class="w-10 h-10 bg-amber-600 rounded-lg flex items-center justify-center text-xl font-bold font-serif">L</div>
            <div>
                <h1 class="font-bold text-lg tracking-wide">LEX COMPANION</h1>
                <p class="text-xs text-slate-400">Juris Doctor Journey</p>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-4 space-y-1 px-3">
            <!-- Navigation Items will be injected here by JS -->
        </nav>

        <div class="p-4 border-t border-slate-800 space-y-3">
            <div id="local-mode-indicator" class="hidden text-xs bg-amber-900/50 text-amber-200 p-2 rounded border border-amber-700/50">
                <i class="fas fa-save mr-1"></i> Local Storage Mode
            </div>
            <div class="flex items-center gap-3 px-3 py-2 rounded bg-slate-800">
                <div class="w-8 h-8 rounded-full bg-slate-600 flex items-center justify-center">
                    <i class="fas fa-user text-xs"></i>
                </div>
                <div class="overflow-hidden">
                    <p class="text-sm font-medium truncate" id="user-display">Student</p>
                    <p class="text-xs text-green-400">Online</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 flex flex-col min-w-0 bg-slate-50 relative">
        <!-- Header -->
        <header class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-8 flex-shrink-0">
            <h2 id="page-title" class="text-2xl font-bold text-slate-800 serif-text">Dashboard</h2>
            <div class="flex items-center gap-4">
                <span id="header-date-display" class="text-sm font-medium text-slate-600 hidden md:inline-block"></span>
                <span id="header-clock" class="text-sm font-mono text-slate-500 bg-slate-100 px-3 py-1 rounded">00:00:00</span>
            </div>
        </header>

        <!-- Dynamic Content Container -->
        <div id="content-area" class="flex-1 overflow-y-auto p-8 relative">
            <!-- Views are rendered here -->
            <div class="flex items-center justify-center h-full">
                <div class="loader"></div>
            </div>
        </div>
    </main>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, updateDoc, deleteDoc, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDxKEf2v5P2LN_a2BcR_ODYDGINZMmVPWk",
            authDomain: "abogado-ea708.firebaseapp.com",
            projectId: "abogado-ea708",
            storageBucket: "abogado-ea708.firebasestorage.app",
            messagingSenderId: "469135522184",
            appId: "1:469135522184:web:d7cf28de119011f282623d",
            measurementId: "G-CPJBKR7T59"
        };
        
        const appNamespace = 'law-companion-v1'; 
        
        // --- APP STATE ---
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app); 
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let currentView = 'dashboard';

        // --- DATABASE ADAPTER (Switches between Firebase and LocalStorage) ---
        const AppDB = {
            isLocal: false,

            subscribe: (collectionName, callback) => {
                if (AppDB.isLocal) {
                    // Local Storage polling implementation
                    const fetchData = () => {
                        const key = `lex_${currentUser.uid}_${collectionName}`;
                        const data = JSON.parse(localStorage.getItem(key) || '[]');
                        // Mimic Firestore snapshot
                        callback({
                            empty: data.length === 0,
                            forEach: (fn) => data.forEach(item => fn({ id: item.id, data: () => item })),
                            docs: data.map(item => ({ id: item.id, data: () => item }))
                        });
                    };
                    fetchData(); // Initial call
                    // Poll for changes every 2 seconds (simple reactivity for local mode)
                    const interval = setInterval(fetchData, 2000);
                    return () => clearInterval(interval); // Return unsubscribe function
                } else {
                    // Firebase implementation
                    const q = collection(db, 'artifacts', appNamespace, 'users', currentUser.uid, collectionName);
                    return onSnapshot(q, callback, (error) => {
                        console.error("Firestore Error:", error);
                        // Fallback to empty state if permission denied
                        callback({ empty: true, forEach: () => {} }); 
                    });
                }
            },

            add: async (collectionName, data) => {
                if (AppDB.isLocal) {
                    const key = `lex_${currentUser.uid}_${collectionName}`;
                    const current = JSON.parse(localStorage.getItem(key) || '[]');
                    const newItem = { ...data, id: 'local_' + Date.now(), created: new Date().toISOString() };
                    current.push(newItem);
                    localStorage.setItem(key, JSON.stringify(current));
                    return newItem;
                } else {
                    return addDoc(collection(db, 'artifacts', appNamespace, 'users', currentUser.uid, collectionName), data);
                }
            },

            delete: async (collectionName, id) => {
                if (AppDB.isLocal) {
                    const key = `lex_${currentUser.uid}_${collectionName}`;
                    const current = JSON.parse(localStorage.getItem(key) || '[]');
                    const updated = current.filter(item => item.id !== id);
                    localStorage.setItem(key, JSON.stringify(updated));
                } else {
                    return deleteDoc(doc(db, 'artifacts', appNamespace, 'users', currentUser.uid, collectionName, id));
                }
            }
        };

        // --- BIBLE VERSES DATABASE ---
        const verses = [
            { text: "Learn to do right; seek justice. Defend the oppressed. Take up the cause of the fatherless; plead the case of the widow.", ref: "Isaiah 1:17" },
            { text: "But let justice roll on like a river, righteousness like a never-failing stream!", ref: "Amos 5:24" },
            { text: "Speak up for those who cannot speak for themselves, for the rights of all who are destitute.", ref: "Proverbs 31:8" },
            { text: "He has shown you, O mortal, what is good. And what does the Lord require of you? To act justly and to love mercy and to walk humbly with your God.", ref: "Micah 6:8" },
            { text: "Blessed are those who observe justice, who do righteousness at all times!", ref: "Psalm 106:3" },
            { text: "For the Lord is a God of justice; blessed are all those who wait for him.", ref: "Isaiah 30:18" }
        ];

        // --- UTILITIES ---
        const Utils = {
            formatDate: (date) => new Date(date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }),
            getDailyVerse: () => {
                const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
                return verses[dayOfYear % verses.length];
            },
            showToast: (msg) => {
                console.log("Toast:", msg);
            }
        };

        // --- VIEW CONTROLLERS ---

        /**
         * DASHBOARD VIEW
         */
        class DashboardView {
            constructor() {
                this.unsubscribe = null;
            }

            render() {
                const verse = Utils.getDailyVerse();
                return `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 max-w-6xl mx-auto">
                        <div class="lg:col-span-2 space-y-6">
                            <div class="bg-gradient-to-r from-slate-800 to-slate-900 rounded-2xl p-8 text-white shadow-lg">
                                <h3 class="text-2xl font-bold serif-text mb-2">Welcome back, Counsel.</h3>
                                <p class="text-slate-300 mb-6">Your journey to the Bar continues today.</p>
                                <div class="bg-white/10 p-4 rounded-lg border border-white/10 backdrop-blur-sm">
                                    <p class="serif-text italic text-lg mb-2">"${verse.text}"</p>
                                    <p class="text-sm text-amber-400 font-bold text-right">— ${verse.ref}</p>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                    <div class="flex items-center justify-between mb-4">
                                        <h4 class="font-bold text-slate-700">Upcoming</h4>
                                        <i class="fas fa-calendar-alt text-blue-600"></i>
                                    </div>
                                    <div id="dashboard-schedule-list" class="space-y-3">
                                        <p class="text-sm text-slate-400 italic">Loading schedule...</p>
                                    </div>
                                </div>
                                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                    <div class="flex items-center justify-between mb-4">
                                        <h4 class="font-bold text-slate-700">Study Streak</h4>
                                        <i class="fas fa-fire text-amber-500"></i>
                                    </div>
                                    <div class="text-center py-2">
                                        <span class="text-4xl font-bold text-slate-800">Active</span>
                                        <p class="text-xs text-slate-500 mt-1">Keep pushing forward</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-1">
                            <div class="bg-white rounded-xl shadow-sm border border-slate-100 h-full flex flex-col">
                                <div class="p-5 border-b border-slate-100 flex justify-between items-center">
                                    <h4 class="font-bold text-slate-700">Reminders</h4>
                                    <button onclick="window.appHandlers.addReminder()" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100 transition">
                                        <i class="fas fa-plus mr-1"></i> Add
                                    </button>
                                </div>
                                <div id="reminder-list" class="flex-1 overflow-y-auto p-4 space-y-3 max-h-[500px]">
                                    <!-- Reminders injected here -->
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            async init() {
                const clockEl = document.getElementById('header-clock');
                if (clockEl) {
                    setInterval(() => {
                        const now = new Date();
                        clockEl.innerText = now.toLocaleTimeString('en-US', { hour12: true });
                        const dateEl = document.getElementById('header-date-display');
                        if (dateEl) {
                            dateEl.innerText = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                        }
                    }, 1000);
                }

                this.unsubscribe = AppDB.subscribe('reminders', (snapshot) => {
                    const list = document.getElementById('reminder-list');
                    const schedList = document.getElementById('dashboard-schedule-list');
                    if (!list) return;

                    list.innerHTML = '';
                    schedList.innerHTML = '';

                    if (snapshot.empty) {
                        list.innerHTML = `<div class="text-center py-8 text-slate-400 text-sm">No reminders set.</div>`;
                        schedList.innerHTML = `<div class="text-slate-400 text-sm">No upcoming events.</div>`;
                        return;
                    }

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const id = doc.id;
                        const date = data.date ? new Date(data.date).toLocaleDateString() : 'No Date';
                        
                        const item = document.createElement('div');
                        item.className = `p-3 rounded-lg border-l-4 ${data.type === 'Quiz' ? 'border-red-500 bg-red-50' : 'border-blue-500 bg-blue-50'} flex justify-between items-start group`;
                        item.innerHTML = `
                            <div>
                                <p class="text-sm font-semibold text-slate-800">${data.title}</p>
                                <p class="text-xs text-slate-500">${data.type} • ${date}</p>
                            </div>
                            <button onclick="window.appHandlers.deleteReminder('${id}')" class="text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        list.appendChild(item);

                        if (schedList.children.length < 3) {
                            const schedItem = document.createElement('div');
                            schedItem.className = "flex items-center gap-3 text-sm";
                            schedItem.innerHTML = `
                                <div class="w-2 h-2 rounded-full ${data.type === 'Quiz' ? 'bg-red-500' : 'bg-blue-500'}"></div>
                                <span class="flex-1 truncate">${data.title}</span>
                                <span class="text-slate-400 text-xs">${date}</span>
                            `;
                            schedList.appendChild(schedItem);
                        }
                    });
                });
            }
        }

        /**
         * SUBJECTS VIEW
         */
        class SubjectsView {
            constructor() { this.unsubscribe = null; }
            render() {
                return `
                    <div class="max-w-5xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-slate-700">My Subjects</h3>
                            <button onclick="window.appHandlers.addSubject()" class="bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg text-sm transition shadow-md">
                                <i class="fas fa-plus mr-2"></i>New Subject
                            </button>
                        </div>
                        <div id="subjects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="col-span-full text-center py-12">
                                <div class="loader mx-auto mb-4"></div>
                                <p class="text-slate-500">Loading your curriculum...</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            init() {
                this.unsubscribe = AppDB.subscribe('subjects', (snapshot) => {
                    const grid = document.getElementById('subjects-grid');
                    if (!grid) return;
                    grid.innerHTML = '';

                    if (snapshot.empty) {
                        grid.innerHTML = `
                            <div class="col-span-full text-center py-12 border-2 border-dashed border-slate-300 rounded-xl">
                                <p class="text-slate-500 mb-2">No subjects added yet.</p>
                                <button onclick="window.appHandlers.addSubject()" class="text-blue-600 font-medium hover:underline">Add your first subject</button>
                            </div>
                        `;
                        return;
                    }

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const card = document.createElement('div');
                        card.className = "bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md transition cursor-pointer group relative";
                        card.innerHTML = `
                            <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition">
                                <button onclick="window.appHandlers.deleteSubject('${doc.id}')" class="text-slate-400 hover:text-red-500"><i class="fas fa-trash"></i></button>
                            </div>
                            <span class="inline-block px-2 py-1 bg-slate-100 text-slate-600 text-xs rounded mb-3 font-semibold tracking-wider uppercase">${data.year || 'General'}</span>
                            <h4 class="text-lg font-bold text-slate-800 mb-2 serif-text">${data.name}</h4>
                            <p class="text-sm text-slate-500 line-clamp-3 mb-4">${data.description || 'No notes added yet.'}</p>
                            <div class="pt-4 border-t border-slate-100 flex items-center justify-between">
                                <span class="text-xs text-slate-400"><i class="fas fa-book mr-1"></i> Notes</span>
                                <span class="text-blue-600 text-xs font-medium group-hover:translate-x-1 transition-transform">Open <i class="fas fa-arrow-right ml-1"></i></span>
                            </div>
                        `;
                        grid.appendChild(card);
                    });
                });
            }
        }

        /**
         * DIGESTS VIEW
         */
        class DigestsView {
            constructor() { this.unsubscribe = null; }
            render() {
                return `
                    <div class="max-w-4xl mx-auto h-full flex flex-col">
                        <div class="flex justify-between items-center mb-6 flex-shrink-0">
                            <h3 class="text-xl font-bold text-slate-700">Case Digests</h3>
                            <button onclick="window.appHandlers.addDigest()" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg text-sm transition shadow-md">
                                <i class="fas fa-gavel mr-2"></i>New Digest
                            </button>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex-1 overflow-hidden flex flex-col">
                            <div class="p-4 border-b border-slate-100 bg-slate-50 flex gap-4 text-sm font-semibold text-slate-600">
                                <div class="w-1/4">Case Title</div>
                                <div class="w-1/4">Subject</div>
                                <div class="w-1/2">Ruling Summary</div>
                            </div>
                            <div id="digest-list" class="overflow-y-auto flex-1 p-2">
                                <!-- List Items -->
                            </div>
                        </div>
                    </div>
                `;
            }

            init() {
                this.unsubscribe = AppDB.subscribe('digests', (snapshot) => {
                    const list = document.getElementById('digest-list');
                    if (!list) return;
                    list.innerHTML = '';
                    
                    if(snapshot.empty) {
                        list.innerHTML = `<div class="p-8 text-center text-slate-400">No case digests found.</div>`;
                        return;
                    }

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const row = document.createElement('div');
                        row.className = "p-3 border-b border-slate-100 last:border-0 hover:bg-slate-50 flex gap-4 text-sm items-start transition";
                        row.innerHTML = `
                            <div class="w-1/4 font-semibold text-slate-800 serif-text">${data.title}</div>
                            <div class="w-1/4 text-slate-500"><span class="bg-slate-100 px-2 py-0.5 rounded text-xs">${data.subject}</span></div>
                            <div class="w-1/2 text-slate-600 line-clamp-2">${data.ruling}</div>
                            <button onclick="window.appHandlers.deleteDigest('${doc.id}')" class="text-slate-300 hover:text-red-500 ml-2"><i class="fas fa-trash"></i></button>
                        `;
                        list.appendChild(row);
                    });
                });
            }
        }

        /**
         * MOCK REVIEW VIEW
         */
        class ReviewView {
            constructor() {
                this.generatedContent = null;
                this.isProcessing = false;
            }

            render() {
                return `
                    <div class="max-w-5xl mx-auto h-full flex flex-col">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col h-full">
                                <h3 class="font-bold text-lg text-slate-800 mb-4">Material Upload</h3>
                                
                                <div class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center hover:bg-slate-50 transition cursor-pointer relative" id="drop-zone">
                                    <input type="file" id="pdf-upload" accept=".pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="window.appHandlers.handleFileUpload(this)">
                                    <i class="fas fa-cloud-upload-alt text-3xl text-slate-400 mb-3"></i>
                                    <p class="text-sm font-medium text-slate-600">Click to upload PDF</p>
                                    <p class="text-xs text-slate-400 mt-1">Lecture notes, reviewers, or codals</p>
                                </div>
                                <div id="file-name-display" class="mt-2 text-xs text-blue-600 font-medium truncate hidden"></div>

                                <div class="mt-6 space-y-3">
                                    <label class="block text-sm font-medium text-slate-700">Review Mode</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button onclick="window.appHandlers.setMode('recit')" id="btn-recit" class="px-4 py-2 rounded border border-slate-200 text-sm font-medium hover:bg-slate-50 bg-slate-800 text-white transition">Recit (Flashcards)</button>
                                        <button onclick="window.appHandlers.setMode('exam')" id="btn-exam" class="px-4 py-2 rounded border border-slate-200 text-sm font-medium hover:bg-slate-50 text-slate-600 transition">Exam (Essay)</button>
                                    </div>
                                </div>

                                <button onclick="window.appHandlers.generateReview()" id="btn-generate" class="mt-auto w-full bg-amber-600 hover:bg-amber-700 text-white py-3 rounded-lg font-medium shadow-md transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    Generate Review
                                </button>
                            </div>

                            <div class="lg:col-span-2 bg-slate-200 rounded-xl border border-slate-300 p-6 overflow-y-auto flex flex-col relative" id="review-output">
                                <div class="absolute inset-0 flex flex-col items-center justify-center text-slate-500 pointer-events-none p-8 text-center">
                                    <i class="fas fa-brain text-4xl mb-4 opacity-50"></i>
                                    <h4 class="text-lg font-semibold">AI Mock Review</h4>
                                    <p class="text-sm max-w-xs mt-2">Upload a PDF to generate practice questions or flashcards based on your material.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // --- MAIN APP LOGIC ---

        const views = {
            dashboard: new DashboardView(),
            subjects: new SubjectsView(),
            digests: new DigestsView(),
            review: new ReviewView(),
            codals: { render: () => window.open('https://www.ecodalplus.com/ecodals', '_blank') || `<div class="text-center mt-20">Opening eCodal+ ...</div>` }, 
            cons_subject: new SubjectsView()
        };

        const sidebarNav = document.querySelector('nav');
        const contentArea = document.getElementById('content-area');
        const pageTitle = document.getElementById('page-title');

        const navItems = [
            { id: 'dashboard', label: 'Dashboard', icon: 'fa-home' },
            { id: 'subjects', label: 'Subjects', icon: 'fa-book' },
            { id: 'codals', label: 'Codals', icon: 'fa-balance-scale' },
            { id: 'digests', label: 'Cons. Digests', icon: 'fa-gavel' },
            { id: 'cons_subject', label: 'Cons. Subjects', icon: 'fa-layer-group' },
            { id: 'review', label: 'Mock Review', icon: 'fa-graduation-cap' }
        ];

        function renderSidebar() {
            sidebarNav.innerHTML = navItems.map(item => `
                <a href="#" onclick="window.appHandlers.navigate('${item.id}')" 
                   class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors mb-1 
                   ${currentView === item.id ? 'bg-amber-600 text-white shadow-md' : 'text-slate-300 hover:bg-slate-800 hover:text-white'}">
                    <i class="fas ${item.icon} w-5 text-center"></i>
                    ${item.label}
                </a>
            `).join('');
        }

        window.appHandlers = {
            navigate: (viewId) => {
                if (viewId === 'codals') {
                    window.open('https://www.ecodalplus.com/ecodals', '_blank');
                    return;
                }
                
                // Cleanup previous view if needed
                if(views[currentView] && views[currentView].unsubscribe) {
                    views[currentView].unsubscribe();
                }

                currentView = viewId;
                renderSidebar();
                
                const item = navItems.find(i => i.id === viewId);
                pageTitle.innerText = item ? item.label : 'App';
                
                if (views[viewId]) {
                    contentArea.innerHTML = views[viewId].render();
                    if (views[viewId].init) views[viewId].init();
                }
            },

            addReminder: async () => {
                const title = prompt("Reminder Title:");
                if (!title) return;
                const type = confirm("Is this a Quiz? (Cancel for Assignment/Other)") ? "Quiz" : "Assignment";
                
                await AppDB.add('reminders', {
                    title,
                    type,
                    date: new Date().toISOString(),
                    created: AppDB.isLocal ? new Date().toISOString() : serverTimestamp()
                });
            },
            deleteReminder: async (id) => {
                if(confirm("Complete this task?")) {
                    await AppDB.delete('reminders', id);
                }
            },

            addSubject: async () => {
                const name = prompt("Subject Name (e.g., Crim 1):");
                if (!name) return;
                const year = prompt("Year Level (e.g., 1L):") || "1L";
                const desc = prompt("Short Note/Description:");

                await AppDB.add('subjects', {
                    name, year, description: desc, 
                    created: AppDB.isLocal ? new Date().toISOString() : serverTimestamp()
                });
            },
            deleteSubject: async (id) => {
                if(confirm("Remove this subject?")) {
                    await AppDB.delete('subjects', id);
                }
            },

            addDigest: async () => {
                const title = prompt("Case Title:");
                if(!title) return;
                const subject = prompt("Subject:");
                const ruling = prompt("Ruling Summary:");

                await AppDB.add('digests', {
                    title, subject, ruling, 
                    created: AppDB.isLocal ? new Date().toISOString() : serverTimestamp()
                });
            },
            deleteDigest: async (id) => await AppDB.delete('digests', id),

            reviewMode: 'recit',
            pdfText: '',

            setMode: (mode) => {
                window.appHandlers.reviewMode = mode;
                document.getElementById('btn-recit').className = mode === 'recit' ? "px-4 py-2 rounded border border-slate-200 text-sm font-medium bg-slate-800 text-white transition" : "px-4 py-2 rounded border border-slate-200 text-sm font-medium hover:bg-slate-50 text-slate-600 transition";
                document.getElementById('btn-exam').className = mode === 'exam' ? "px-4 py-2 rounded border border-slate-200 text-sm font-medium bg-slate-800 text-white transition" : "px-4 py-2 rounded border border-slate-200 text-sm font-medium hover:bg-slate-50 text-slate-600 transition";
            },

            handleFileUpload: async (input) => {
                const file = input.files[0];
                if (!file) return;

                document.getElementById('file-name-display').innerText = file.name;
                document.getElementById('file-name-display').classList.remove('hidden');
                document.getElementById('btn-generate').innerText = "Processing PDF...";
                
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    
                    let fullText = "";
                    const maxPages = Math.min(pdf.numPages, 10);
                    
                    for (let i = 1; i <= maxPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + "\n";
                    }

                    window.appHandlers.pdfText = fullText;
                    document.getElementById('btn-generate').disabled = false;
                    document.getElementById('btn-generate').innerText = "Generate Review";
                } catch (e) {
                    console.error(e);
                    alert("Error reading PDF. Please try a text-heavy PDF.");
                    document.getElementById('btn-generate').innerText = "Error";
                }
            },

            generateReview: () => {
                const text = window.appHandlers.pdfText;
                const mode = window.appHandlers.reviewMode;
                const output = document.getElementById('review-output');
                
                output.innerHTML = `<div class="flex justify-center p-10"><div class="loader"></div></div>`;

                setTimeout(() => {
                    output.innerHTML = '';
                    
                    const sentences = text.match(/[^\.!\?]+[\.!\?]+/g) || [];
                    const meaningfulSentences = sentences.filter(s => s.length > 50 && (s.includes('court') || s.includes('law') || s.includes('act') || s.includes('is') || s.includes('shall')));

                    if (mode === 'recit') {
                        const cards = [];
                        meaningfulSentences.forEach((s, idx) => {
                            if (cards.length >= 10) return;
                            if (idx % 3 === 0) { 
                                cards.push({
                                    front: `Based on the text, discuss the concept mentioned in this context: "...${s.substring(0, 40)}..."`,
                                    back: s
                                });
                            }
                        });
                        
                        if(cards.length === 0) cards.push({front: "No clear definitions found.", back: "Try a different PDF."});

                        output.innerHTML = `<h3 class="font-bold text-xl mb-4 sticky top-0 bg-slate-200 py-2">Flashcards (${cards.length})</h3>`;
                        const grid = document.createElement('div');
                        grid.className = "grid grid-cols-1 md:grid-cols-2 gap-4";
                        
                        cards.forEach((card, i) => {
                            const el = document.createElement('div');
                            el.className = "bg-white p-6 rounded-xl shadow-sm border border-slate-300 cursor-pointer hover:shadow-md transition flex flex-col justify-between min-h-[160px] group perspective";
                            el.onclick = function() {
                                this.querySelector('.card-inner').classList.toggle('hidden');
                                this.querySelector('.card-back').classList.toggle('hidden');
                            };
                            el.innerHTML = `
                                <div class="card-inner">
                                    <span class="text-xs text-blue-600 font-bold uppercase mb-2 block">Card ${i+1}</span>
                                    <p class="serif-text font-medium text-slate-800">${card.front}</p>
                                    <p class="text-xs text-slate-400 mt-4 text-center">(Click to reveal)</p>
                                </div>
                                <div class="card-back hidden animate-fade-in">
                                    <span class="text-xs text-green-600 font-bold uppercase mb-2 block">Answer</span>
                                    <p class="text-sm text-slate-700 leading-relaxed">${card.back}</p>
                                </div>
                            `;
                            grid.appendChild(el);
                        });
                        output.appendChild(grid);

                    } else {
                        const words = text.match(/\b[A-Z][a-z]+ [A-Z][a-z]+\b/g) || ["The Doctrine"];
                        const uniqueTerms = [...new Set(words)].slice(0, 5);
                        
                        output.innerHTML = `<h3 class="font-bold text-xl mb-4 sticky top-0 bg-slate-200 py-2">Bar Exam Simulation</h3>`;
                        const paper = document.createElement('div');
                        paper.className = "bg-white p-8 rounded shadow-sm border border-slate-300 min-h-[500px] serif-text";
                        
                        let html = `<div class="text-center border-b-2 border-black pb-4 mb-6">
                            <h2 class="text-2xl font-bold uppercase">Mock Bar Examination</h2>
                            <p class="italic">Subject: Review of Uploaded Material</p>
                        </div>`;

                        uniqueTerms.forEach((term, i) => {
                            html += `
                                <div class="mb-8">
                                    <p class="font-bold mb-2">Question ${i+1}</p>
                                    <p class="mb-4 leading-loose text-justify">
                                        Analyze the legal implications of <strong>${term}</strong> as presented in the materials. 
                                        Discuss its application in contemporary jurisprudence and distinguish it from related concepts. 
                                        Cite specific provisions or doctrines where applicable.
                                    </p>
                                    <textarea class="w-full p-3 border border-slate-200 rounded bg-slate-50 font-sans text-sm" rows="4" placeholder="Type your answer here..."></textarea>
                                </div>
                            `;
                        });
                        paper.innerHTML = html;
                        output.appendChild(paper);
                    }
                }, 1500);
            }
        };

        const initAuth = async () => {
            try {
                await signInAnonymously(auth);
            } catch (e) {
                console.warn("Firebase Auth failed. Switching to Local Storage Mode.", e);
                // Fallback Logic
                AppDB.isLocal = true;
                currentUser = { uid: 'local-guest' };
                document.getElementById('local-mode-indicator').classList.remove('hidden');
                // Allow the app to start despite auth error
                window.appHandlers.navigate('dashboard');
            }
        };

        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-display').innerText = "Law Student";
                // Hide local mode indicator if we successfully logged in
                document.getElementById('local-mode-indicator').classList.add('hidden');
                AppDB.isLocal = false; // Ensure we try Firebase first next time
                window.appHandlers.navigate('dashboard');
            } else if (!AppDB.isLocal) {
                // Only show loading if we aren't already in local fallback mode
                contentArea.innerHTML = `<div class="flex items-center justify-center h-full">Signing in...</div>`;
            }
        });

    </script>
</body>
</html>
