<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lex: Law School Companion</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <link rel="apple-touch-icon" href="./LEX.png">
    <link rel="icon" href="./LEX.png">

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker registered!'))
                    .catch(err => console.log('SW registration failed:', err));
            });
        }
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({ startOnLoad: false, theme: 'default' });</script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .serif-text { font-family: 'Merriweather', serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #2563eb; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .mermaid svg { max-width: 100%; height: auto; font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen flex overflow-hidden">

    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center text-white transition-opacity duration-300">
        <img src="./LEX.png" alt="Lex Logo" class="w-24 h-24 rounded-2xl mb-6 shadow-2xl object-cover border border-slate-700">
        <h1 class="text-3xl font-bold mb-2 tracking-wide">LEX COMPANION</h1>
        <p class="text-slate-400 mb-8">Your 2L Journey, Synced Anywhere.</p>
        <button onclick="window.appHandlers.login()" class="bg-white text-slate-900 px-6 py-3 rounded-lg font-bold flex items-center gap-3 hover:bg-slate-100 transition shadow-xl">
            <i class="fab fa-google text-red-500"></i> Sign in with Google
        </button>
    </div>

    <aside class="w-64 bg-slate-900 text-white flex flex-col shadow-xl flex-shrink-0 transition-all duration-300" id="sidebar">
        <div class="p-6 border-b border-slate-800 flex items-center gap-3">
            <img src="./LEX.png" alt="Lex Logo" class="w-10 h-10 rounded-lg shadow-inner object-cover border border-slate-700">
            <div>
                <h1 class="font-bold text-lg tracking-wide">LEX</h1>
                <p class="text-[10px] text-amber-400 font-bold tracking-widest uppercase">Version 5.6</p>
            </div>
        </div>
        <nav class="flex-1 overflow-y-auto py-4 space-y-1 px-3"></nav>
        <div class="p-4 border-t border-slate-800 space-y-3">
            <div class="flex items-center justify-between px-3 py-2 rounded bg-slate-800">
                <div class="flex items-center gap-3 overflow-hidden">
                    <div class="w-8 h-8 rounded-full bg-slate-600 flex items-center justify-center"><i class="fas fa-user text-xs"></i></div>
                    <div class="overflow-hidden">
                        <p class="text-sm font-medium truncate" id="user-display">Student</p>
                        <p class="text-[10px] text-green-400"><i class="fas fa-cloud text-[10px]"></i> Cloud Sync Active</p>
                    </div>
                </div>
                <button onclick="window.appHandlers.logout()" class="text-slate-400 hover:text-red-400 transition" title="Log Out"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col min-w-0 bg-slate-50 relative z-0">
        <header class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-8 flex-shrink-0">
            <h2 id="page-title" class="text-2xl font-bold text-slate-800 serif-text">Dashboard</h2>
            <div class="flex items-center gap-4">
                <span id="header-date-display" class="text-sm font-medium text-slate-600 hidden md:inline-block"></span>
                <span id="header-clock" class="text-sm font-mono text-slate-500 bg-slate-100 px-3 py-1 rounded">00:00:00</span>
            </div>
        </header>
        <div id="content-area" class="flex-1 overflow-y-auto p-8 relative">
            <div class="flex items-center justify-center h-full"><div class="loader"></div></div>
        </div>
    </main>

    <div id="pomodoro-widget" class="fixed bottom-6 right-8 bg-white rounded-2xl shadow-2xl border border-slate-200 w-64 flex flex-col z-50 overflow-hidden transition-all duration-300 transform translate-y-[calc(100%-48px)]">
        <div class="flex justify-between items-center px-4 py-3 bg-slate-800 text-white cursor-pointer select-none" onclick="window.appHandlers.togglePomoMinimize()">
            <span id="pomo-mode-label" class="text-xs font-bold uppercase tracking-widest flex items-center gap-2"><i class="fas fa-brain text-amber-400"></i> Focus Mode</span>
            <i id="pomo-min-icon" class="fas fa-chevron-down text-xs opacity-70 rotate-180 transition-transform"></i>
        </div>
        <div id="pomo-main-content" class="p-5 flex flex-col items-center bg-slate-50 transition-all duration-300">
            <div class="text-5xl font-mono font-bold text-slate-800 text-center mb-4 tracking-tight" id="pomo-time">50:00</div>
            <div class="flex justify-center gap-3 w-full">
                <button onclick="window.appHandlers.startPomo()" id="btn-pomo-start" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold text-sm shadow-sm hover:bg-blue-700 transition"><i class="fas fa-play"></i> Start</button>
                <button onclick="window.appHandlers.pausePomo()" id="btn-pomo-pause" class="flex-1 bg-amber-500 text-white py-2 rounded-lg font-bold text-sm shadow-sm hover:bg-amber-600 transition hidden"><i class="fas fa-pause"></i> Pause</button>
                <button onclick="window.appHandlers.resetPomo()" class="bg-slate-200 text-slate-700 px-4 py-2 rounded-lg font-bold text-sm shadow-sm hover:bg-slate-300 transition" title="Reset Timer"><i class="fas fa-redo"></i></button>
                <button onclick="window.appHandlers.switchPomoMode()" class="bg-slate-800 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-sm hover:bg-slate-900 transition" title="Switch to Break"><i class="fas fa-mug-hot"></i></button>
            </div>
        </div>
    </div>

    <div id="app-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4 transition-all duration-200">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all duration-200" id="app-modal-card">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 id="app-modal-title" class="font-bold text-slate-800 text-lg flex items-center gap-2">Modal Title</h3>
                <button onclick="document.getElementById('app-modal').classList.add('hidden')" class="text-slate-400 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
            </div>
            <div id="app-modal-body" class="p-6 space-y-4"></div>
            <div class="px-6 py-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                <button onclick="document.getElementById('app-modal').classList.add('hidden')" class="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-lg text-sm font-medium transition">Cancel</button>
                <button id="app-modal-submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium transition shadow-sm">Save</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, serverTimestamp, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDxKEf2v5P2LN_a2BcR_ODYDGINZMmVPWk",
            authDomain: "abogado-ea708.firebaseapp.com",
            projectId: "abogado-ea708",
            storageBucket: "abogado-ea708.firebasestorage.app",
            messagingSenderId: "469135522184",
            appId: "1:469135522184:web:d7cf28de119011f282623d"
        };
        
        const appNamespace = 'law-companion-v1'; 
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const db = getFirestore(app);
        
        let currentUser = null;
        let currentView = 'dashboard';

        const POMO_FOCUS_MINS = 50; const POMO_BREAK_MINS = 10;
        let currentPomoSeconds = POMO_FOCUS_MINS * 60; let pomoInterval = null; let isPomoRunning = false; let currentPomoMode = 'focus'; 

        const AppDB = {
            subscribe: (collectionName, callback) => { if (!currentUser) return () => {}; return onSnapshot(collection(db, 'artifacts', appNamespace, 'users', currentUser.uid, collectionName), callback, (error) => { console.error(error); callback({ empty: true, forEach: () => {} }); }); },
            subscribeQuery: (collectionName, field, op, value, callback) => { if (!currentUser) return () => {}; return onSnapshot(query(collection(db, 'artifacts', appNamespace, 'users', currentUser.uid, collectionName), where(field, op, value)), callback, (error) => { console.error(error); callback({ empty: true, forEach: () => {} }); }); },
            add: async (collectionName, data) => { if (!currentUser) throw new Error("Unauthenticated"); return addDoc(collection(db, 'artifacts', appNamespace, 'users', currentUser.uid, collectionName), data); },
            update: async (collectionName, id, data) => { if (!currentUser) throw new Error("Unauthenticated"); return updateDoc(doc(db, 'artifacts', appNamespace, 'users', currentUser.uid, collectionName, id), data); },
            delete: async (collectionName, id) => { if (!currentUser) throw new Error("Unauthenticated"); return deleteDoc(doc(db, 'artifacts', appNamespace, 'users', currentUser.uid, collectionName, id)); }
        };

        const Utils = {
            getDailyVerse: () => {
                const verses = [{ text: "Learn to do right; seek justice. Defend the oppressed.", ref: "Isaiah 1:17" }, { text: "But let justice roll on like a river, righteousness like a never-failing stream!", ref: "Amos 5:24" }, { text: "Speak up for those who cannot speak for themselves...", ref: "Proverbs 31:8" }];
                return verses[Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24) % verses.length];
            }
        };

        const Modal = {
            show: (options) => {
                const modal = document.getElementById('app-modal'); document.getElementById('app-modal-title').innerHTML = options.title; document.getElementById('app-modal-body').innerHTML = options.content;
                const submitBtn = document.getElementById('app-modal-submit'); submitBtn.innerText = options.submitText || 'Save'; submitBtn.className = options.submitClass || 'px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium transition shadow-sm';
                submitBtn.onclick = async () => { const originalText = submitBtn.innerText; submitBtn.innerText = 'Processing...'; submitBtn.disabled = true; try { await options.onSubmit(); modal.classList.add('hidden'); } catch (e) { console.error(e); alert("An error occurred."); } finally { submitBtn.innerText = originalText; submitBtn.disabled = false; } };
                modal.classList.remove('hidden');
            },
            hide: () => document.getElementById('app-modal').classList.add('hidden')
        };

        // --- 1. Dashboard View ---
        class DashboardView {
            constructor() { this.unsubscribeReminders = null; this.unsubscribeSchedule = null; this.unsubscribePomoStats = null; }
            render() {
                const verse = Utils.getDailyVerse();
                return `<div class="max-w-6xl mx-auto pb-24"><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2 space-y-6"><div class="bg-gradient-to-r from-blue-800 to-slate-900 rounded-2xl p-8 text-white shadow-lg relative overflow-hidden"><i class="fas fa-balance-scale text-white opacity-5 text-9xl absolute -right-10 -bottom-10"></i><h3 class="text-2xl font-bold serif-text mb-2 relative z-10">Welcome back, Counsel.</h3><p class="text-blue-200 mb-6 relative z-10">Your journey to the Bar continues today.</p><div class="bg-white/10 p-4 rounded-lg border border-white/10 backdrop-blur-sm relative z-10"><p class="serif-text italic text-lg mb-2">"${verse.text}"</p><p class="text-sm text-amber-400 font-bold text-right">— ${verse.ref}</p></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col h-full"><div class="flex items-center justify-between mb-4"><h4 class="font-bold text-slate-700"><i class="fas fa-calendar-week text-blue-600 mr-2"></i> Schedule</h4><button onclick="window.appHandlers.addClass()" class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200 transition font-bold"><i class="fas fa-plus"></i></button></div><div id="dashboard-schedule-list" class="space-y-3 flex-1 overflow-y-auto max-h-[250px] pr-2"><div class="text-center py-8 text-slate-400 text-sm"><div class="loader mx-auto mb-2"></div>Loading...</div></div></div><div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col justify-center items-center h-full"><div class="w-full flex items-center justify-between mb-2"><h4 class="font-bold text-slate-700"><i class="fas fa-stopwatch text-amber-500 mr-2"></i> Study Tracker</h4></div><div class="text-center mt-4"><span id="dash-study-time" class="text-5xl font-bold text-slate-800 font-mono">0<span class="text-2xl text-slate-400">h</span> 0<span class="text-2xl text-slate-400">m</span></span><p id="dash-study-sessions" class="text-sm font-medium text-blue-600 mt-3 bg-blue-50 px-4 py-1.5 rounded-full inline-block">0 Focus Sessions Logged</p><p class="text-xs text-slate-400 mt-4 leading-relaxed max-w-[200px] mx-auto">Use the floating timer in the bottom right to track your deep work.</p></div></div></div></div><div class="lg:col-span-1"><div class="bg-white rounded-xl shadow-sm border border-slate-100 h-full flex flex-col"><div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-xl"><h4 class="font-bold text-slate-700"><i class="fas fa-tasks text-amber-500 mr-2"></i> Reminders</h4><button onclick="window.appHandlers.addReminder()" class="text-xs bg-amber-100 text-amber-700 px-3 py-1.5 rounded-lg hover:bg-amber-200 transition font-bold"><i class="fas fa-plus mr-1"></i> Add Task</button></div><div id="reminder-list" class="flex-1 overflow-y-auto p-4 space-y-3 max-h-[600px]"></div></div></div></div></div>`;
            }
            async init() {
                const clockEl = document.getElementById('header-clock');
                if (clockEl) { setInterval(() => { const now = new Date(); clockEl.innerText = now.toLocaleTimeString('en-US', { hour12: true }); const dateEl = document.getElementById('header-date-display'); if (dateEl) dateEl.innerText = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }); }, 1000); }
                this.unsubscribeReminders = AppDB.subscribe('reminders', (snapshot) => { const list = document.getElementById('reminder-list'); if (!list) return; list.innerHTML = ''; if (snapshot.empty) { list.innerHTML = `<div class="text-center py-10 text-slate-400 text-sm">No pending tasks. Great job!</div>`; return; } snapshot.forEach(doc => { const data = doc.data(); const item = document.createElement('div'); item.className = `p-4 rounded-xl border-l-4 shadow-sm ${data.type === 'Quiz' ? 'border-red-500 bg-red-50' : 'border-amber-500 bg-amber-50'} flex justify-between items-start group`; item.innerHTML = `<div><p class="text-sm font-bold text-slate-800">${data.title}</p><p class="text-xs text-slate-600 mt-1">${data.type} • ${data.date ? new Date(data.date).toLocaleDateString() : 'No Date'}</p></div><button onclick="window.appHandlers.deleteReminder('${doc.id}')" class="text-slate-300 hover:text-green-600 bg-white p-1.5 rounded shadow-sm opacity-0 group-hover:opacity-100 transition" title="Mark Complete"><i class="fas fa-check"></i></button>`; list.appendChild(item); }); });
                this.unsubscribeSchedule = AppDB.subscribe('schedule', (snapshot) => { const schedList = document.getElementById('dashboard-schedule-list'); if (!schedList) return; schedList.innerHTML = ''; if (snapshot.empty) { schedList.innerHTML = `<div class="text-center py-8 text-slate-400 text-sm">Your schedule is empty.<br>Click '+' to add a class.</div>`; return; } const classes = []; snapshot.forEach(doc => classes.push({ id: doc.id, ...doc.data() })); const dayOrder = { "Monday": 1, "Tuesday": 2, "Wednesday": 3, "Thursday": 4, "Friday": 5, "Saturday": 6, "Sunday": 7 }; classes.sort((a, b) => { if (dayOrder[a.day] !== dayOrder[b.day]) return dayOrder[a.day] - dayOrder[b.day]; return a.time.localeCompare(b.time); }); let currentDay = ""; classes.forEach(cls => { if (cls.day !== currentDay) { schedList.innerHTML += `<div class="font-bold text-slate-500 text-xs mt-4 mb-2 uppercase tracking-wider border-b border-slate-100 pb-1">${cls.day}</div>`; currentDay = cls.day; } const item = document.createElement('div'); item.className = "flex items-center justify-between p-3 bg-slate-50 border border-slate-100 rounded-lg mb-2 group hover:border-blue-200 transition"; item.innerHTML = `<div class="flex items-center gap-3"><div class="bg-blue-100 text-blue-800 font-bold text-xs py-1 px-2 rounded min-w-[70px] text-center">${cls.time}</div><div><p class="font-bold text-slate-800 text-sm">${cls.subject}</p><p class="text-[10px] text-slate-500 mt-0.5"><i class="fas fa-map-marker-alt"></i> ${cls.room} • <i class="fas fa-user-tie"></i> ${cls.professor}</p></div></div><button onclick="window.appHandlers.deleteClass('${cls.id}')" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-times"></i></button>`; schedList.appendChild(item); }); });
                this.unsubscribePomoStats = AppDB.subscribe('focus_sessions', (snapshot) => { const timeEl = document.getElementById('dash-study-time'); const sessionsEl = document.getElementById('dash-study-sessions'); if (!timeEl || !sessionsEl) return; let totalMinutes = 0; let totalSessions = 0; if (!snapshot.empty) { snapshot.forEach(doc => { totalMinutes += doc.data().minutes; totalSessions++; }); } const hours = Math.floor(totalMinutes / 60); const mins = totalMinutes % 60; timeEl.innerHTML = `${hours}<span class="text-2xl text-slate-400">h</span> ${mins}<span class="text-2xl text-slate-400">m</span>`; sessionsEl.innerText = `${totalSessions} Focus Sessions Logged`; });
            }
        }

        // --- 2. Subjects View ---
        class SubjectsView {
            constructor() { this.unsubscribe = null; }
            render() { return `<div class="max-w-5xl mx-auto pb-24"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-slate-700">My Subjects</h3><button onclick="window.appHandlers.addSubject()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition shadow-md"><i class="fas fa-plus mr-2"></i>New Subject</button></div><div id="subjects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>`; }
            init() { 
                this.unsubscribe = AppDB.subscribe('subjects', (snapshot) => { 
                    const grid = document.getElementById('subjects-grid'); if (!grid) return; grid.innerHTML = ''; 
                    if (snapshot.empty) { grid.innerHTML = `<div class="col-span-full text-center py-12 border-2 border-dashed border-slate-300 rounded-xl bg-white"><i class="fas fa-book-open text-4xl text-slate-300 mb-3"></i><p class="text-slate-500 mb-3">No subjects added yet.</p><button onclick="window.appHandlers.addSubject()" class="text-blue-600 font-bold hover:underline">Create Subject Notebook</button></div>`; return; } 
                    const sortedSubjects = []; snapshot.forEach(doc => sortedSubjects.push({ id: doc.id, ...doc.data() })); sortedSubjects.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                    sortedSubjects.forEach(data => { 
                        const card = document.createElement('div'); card.onclick = () => window.appHandlers.openSubject(data.id, data.name.replace(/'/g, "\\'")); 
                        card.className = "bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-blue-300 transition cursor-pointer group relative flex flex-col h-full"; 
                        card.innerHTML = `<div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition z-10"><button onclick="event.stopPropagation(); window.appHandlers.deleteSubject('${data.id}')" class="text-slate-400 hover:text-red-500 bg-white rounded-full p-1"><i class="fas fa-trash"></i></button></div><span class="inline-block self-start px-2 py-1 bg-blue-50 text-blue-700 text-xs rounded mb-3 font-bold tracking-wider uppercase">${data.year || 'General'}</span><h4 class="text-lg font-bold text-slate-800 mb-2 serif-text">${data.name}</h4><p class="text-sm text-slate-500 line-clamp-2 mb-4 flex-1">${data.description || 'Open notebook to view notes.'}</p><div class="pt-4 border-t border-slate-100 flex items-center justify-between mt-auto"><span class="text-xs font-bold text-slate-400 uppercase tracking-wider"><i class="fas fa-book mr-1"></i> Notebook</span><span class="text-blue-600 text-xs font-bold group-hover:translate-x-1 transition-transform">Open <i class="fas fa-arrow-right ml-1"></i></span></div>`; 
                        grid.appendChild(card); 
                    }); 
                }); 
            }
        }

        // --- 3. Subject Notebook View ---
        class SubjectNotebookView {
            constructor() { this.unsubscribe = null; this.subjectId = null; this.subjectName = ""; this.activeNoteId = null; }
            render() { return `<div class="h-[calc(100vh-4rem)] flex flex-col -m-8 pb-10"><div class="bg-white border-b border-slate-200 px-8 py-4 flex justify-between items-center flex-shrink-0 shadow-sm z-10"><div class="flex items-center gap-4"><button onclick="window.appHandlers.navigate('subjects')" class="text-slate-400 hover:text-blue-600 transition flex items-center gap-2 font-medium bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-200"><i class="fas fa-arrow-left"></i> Back to Subjects</button><h3 class="text-xl font-bold text-slate-800 serif-text">${this.subjectName}</h3></div><button onclick="window.appHandlers.addNote('${this.subjectId}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-sm"><i class="fas fa-plus mr-2"></i>New Page</button></div><div class="flex flex-1 overflow-hidden bg-slate-50"><div class="w-72 bg-white border-r border-slate-200 overflow-y-auto flex flex-col shadow-sm z-0" id="notebook-pages-list"><div class="p-8 text-center text-slate-400"><div class="loader mx-auto"></div></div></div><div class="flex-1 flex flex-col relative bg-slate-50/50" id="notebook-editor-area"><div class="absolute inset-0 flex flex-col items-center justify-center text-slate-400"><i class="fas fa-book-open text-6xl mb-4 opacity-20"></i><p class="font-medium text-slate-500">Select a page from the sidebar</p><p class="text-sm mt-1">or create a new one to start taking notes.</p></div></div></div></div>`; }
            init(subjectId, subjectName) {
                this.subjectId = subjectId; this.subjectName = subjectName; this.activeNoteId = null; document.getElementById('content-area').innerHTML = this.render();
                this.unsubscribe = AppDB.subscribeQuery('notes', 'subjectId', '==', subjectId, (snapshot) => {
                    const list = document.getElementById('notebook-pages-list'); if (!list) return; list.innerHTML = '';
                    if (snapshot.empty) { list.innerHTML = `<div class="p-8 text-center text-slate-400 text-sm mt-10"><i class="far fa-folder-open text-4xl mb-3 opacity-30"></i><br>Notebook is empty.</div>`; return; }
                    const sortedNotes = []; snapshot.forEach(doc => sortedNotes.push({ id: doc.id, ...doc.data() })); sortedNotes.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
                    sortedNotes.forEach(data => {
                        const noteId = data.id; const isActive = this.activeNoteId === noteId;
                        const btn = document.createElement('button'); btn.className = `w-full text-left px-5 py-4 border-b border-slate-100 text-sm font-medium transition group flex justify-between items-center ${isActive ? 'bg-blue-50 text-blue-700 border-l-4 border-l-blue-600' : 'text-slate-600 hover:bg-slate-50 border-l-4 border-l-transparent'}`; btn.innerHTML = `<span class="truncate pr-2 flex items-center gap-2"><i class="far fa-file-alt opacity-50"></i> ${data.title}</span><i class="fas fa-trash text-slate-300 hover:text-red-500 transition px-2 py-1 opacity-0 group-hover:opacity-100" onclick="event.stopPropagation(); window.appHandlers.deleteNote('${noteId}')"></i>`;
                        btn.onclick = () => window.appHandlers.openNote(noteId, data.title, data.content, btn); list.appendChild(btn);
                    });
                });
            }
        }

        // --- 4. Doctrine Matrix View ---
        class DoctrineMatrixView {
            constructor() { this.unsubscribe = null; this.doctrines = []; }
            render() { return `<div class="max-w-6xl mx-auto pb-24 h-full flex flex-col"><div class="flex justify-between items-center mb-6 flex-shrink-0"><div><h3 class="text-xl font-bold text-slate-700">Jurisprudence Doctrine Matrix</h3><p class="text-xs text-slate-500 mt-1">Map articles directly to key cases and doctrines for rapid Bar review.</p></div><button onclick="window.appHandlers.addDoctrine()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-md"><i class="fas fa-plus mr-2"></i>Add Doctrine</button></div><div class="bg-white rounded-xl shadow-sm border border-slate-200 flex-1 flex flex-col overflow-hidden"><div class="p-4 border-b border-slate-100 bg-slate-50"><div class="relative"><i class="fas fa-search absolute left-3 top-2.5 text-slate-400"></i><input type="text" id="matrix-search" placeholder="Search by Article, Case Title, or keyword..." class="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" onkeyup="window.appHandlers.filterMatrix()"></div></div><div class="flex-1 overflow-auto"><table class="w-full text-left border-collapse" id="matrix-table"><thead class="bg-slate-50 sticky top-0 shadow-sm z-10"><tr><th class="p-3 text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200 w-1/6">Article / Topic</th><th class="p-3 text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200 w-1/4">Case Title & Citation</th><th class="p-3 text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200 w-1/2">Core Doctrine</th><th class="p-3 text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200 text-center">Actions</th></tr></thead><tbody id="matrix-list" class="text-sm divide-y divide-slate-100"><tr><td colspan="4" class="p-8 text-center text-slate-400"><div class="loader mx-auto"></div></td></tr></tbody></table></div></div></div>`; }
            init() { 
                this.unsubscribe = AppDB.subscribe('doctrines', (snapshot) => { 
                    const list = document.getElementById('matrix-list'); if (!list) return; this.doctrines = []; 
                    if (snapshot.empty) { list.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-slate-400"><i class="fas fa-table text-4xl mb-3 opacity-30"></i><br>No doctrines mapped yet.</td></tr>`; return; } 
                    snapshot.forEach(doc => this.doctrines.push({ id: doc.id, ...doc.data() })); 
                    this.doctrines.sort((a, b) => (a.article || '').localeCompare(b.article || '')); 
                    window.appHandlers.renderMatrixRows(this.doctrines); 
                }); 
            }
        }

        // --- 5. Codal Trainer View ---
        class CodalTrainerView {
            constructor() { this.unsubscribe = null; }
            render() { return `<div class="max-w-4xl mx-auto h-full flex flex-col pb-24"><div class="flex justify-between items-center mb-6"><div><h3 class="text-xl font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-eye-slash text-blue-600"></i> Blind Codal Trainer</h3><p class="text-xs text-slate-500 mt-1">Paste a legal provision. We'll blank out the crucial terms to test your active recall.</p></div></div><div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col gap-4 mb-6"><label class="block text-sm font-medium text-slate-700">Paste Legal Provision</label><textarea id="codal-input" rows="4" class="w-full p-4 border border-slate-200 rounded-lg text-sm resize-none focus:ring-2 focus:ring-blue-500 outline-none leading-relaxed shadow-inner bg-slate-50" placeholder="e.g. Art. 1156. An obligation is a juridical necessity to give, to do or not to do."></textarea><div class="flex justify-between items-center mt-2 border-t border-slate-100 pt-4"><div class="flex items-center gap-3"><label class="text-sm font-bold text-slate-600">Difficulty:</label><select id="codal-difficulty" class="border border-slate-200 bg-white rounded-lg px-3 py-2 text-sm outline-none shadow-sm font-medium"><option value="0.2">Easy (Blank 20%)</option><option value="0.4" selected>Medium (Blank 40%)</option><option value="0.6">Hard (Blank 60%)</option><option value="0.9">Master (Blank 90%)</option></select></div><button onclick="window.appHandlers.generateBlindCodal()" class="bg-blue-600 text-white px-6 py-2.5 rounded-lg text-sm font-bold hover:bg-blue-700 transition shadow-sm"><i class="fas fa-magic mr-2"></i> Generate Test</button></div></div><div id="codal-workspace" class="hidden flex-1 bg-white p-8 rounded-xl shadow-sm border border-slate-200 overflow-y-auto"><div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4"><h4 class="font-bold text-slate-700"><i class="fas fa-pen-nib mr-2 text-amber-500"></i> Fill in the blanks</h4><div class="flex gap-3"><button onclick="window.appHandlers.resetCodal()" class="text-sm text-slate-500 hover:text-slate-800 font-bold transition px-3 py-1 bg-slate-100 rounded-lg"><i class="fas fa-redo mr-1"></i> Retry</button><button onclick="window.appHandlers.revealCodal()" class="text-sm text-amber-600 hover:text-amber-700 font-bold transition px-3 py-1 bg-amber-50 rounded-lg"><i class="fas fa-eye mr-1"></i> Reveal Answers</button></div></div><div id="codal-test-area" class="text-xl leading-loose text-slate-800 font-serif"></div></div></div>`; }
        }

        // --- 6. Mnemonic View ---
        class MnemonicView {
            constructor() { this.unsubscribe = null; this.generatedTitle = ""; this.generatedContent = ""; this.subjects = []; }
            render() { const savedKey = localStorage.getItem('gemini_api_key') || ''; return `<div class="max-w-5xl mx-auto h-full flex flex-col pb-24"><div class="flex justify-between items-center mb-6"><div><h3 class="text-xl font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-lightbulb text-amber-500"></i> AI Mnemonic Maker</h3><p class="text-xs text-slate-500 mt-1">Turn boring legal elements into unforgettable stories and acronyms.</p></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6 flex-1 overflow-hidden"><div class="md:col-span-1 bg-white p-6 rounded-xl shadow-sm border border-slate-200 overflow-y-auto flex flex-col gap-4"><div class="p-3 bg-blue-50 border border-blue-200 rounded-lg"><label class="block text-xs font-bold text-blue-800 mb-1"><i class="fas fa-key"></i> Gemini API Key</label><input type="password" id="mnem-api-key" class="w-full p-2 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" value="${savedKey}"></div><div><label class="block text-sm font-medium text-slate-700 mb-1">Legal Concept / Topic</label><input type="text" id="mnem-topic" placeholder="e.g., Requisites of Fortuitous Event" class="w-full p-2 border border-slate-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-amber-500"></div><div><label class="block text-sm font-medium text-slate-700 mb-1">Elements to Memorize</label><textarea id="mnem-elements" rows="5" class="w-full p-2 border border-slate-200 rounded-lg text-sm resize-none outline-none focus:ring-2 focus:ring-amber-500" placeholder="1. Independent of human will\n2. Unforeseeable or unavoidable..."></textarea></div><button onclick="window.appHandlers.generateMnemonic()" id="btn-generate-mnem" class="mt-auto w-full bg-amber-500 hover:bg-amber-600 text-white py-3 rounded-lg text-sm font-bold shadow-md transition"><i class="fas fa-magic mr-1"></i> Create Mnemonic</button></div><div class="md:col-span-2 bg-slate-50 border border-slate-200 rounded-xl p-6 overflow-y-auto flex flex-col relative" id="mnem-output-area"><div class="absolute inset-0 flex flex-col items-center justify-center text-slate-400"><i class="fas fa-brain text-6xl mb-4 opacity-20"></i><p class="font-medium text-slate-500">Enter your elements on the left.</p></div></div></div></div>`; }
            init() { this.unsubscribe = AppDB.subscribe('subjects', (snapshot) => { this.subjects = []; if (!snapshot.empty) { snapshot.forEach(doc => this.subjects.push({ id: doc.id, ...doc.data() })); } const select = document.getElementById('mnem-subject-select'); if (select) { const currentVal = select.value; select.innerHTML = '<option value="">Select Notebook to Save...</option>' + this.subjects.map(s => `<option value="${s.id}">${s.name}</option>`).join(''); select.value = currentVal; } }); }
        }

        // --- 7. Issue Tree View ---
        class IssueTreeView {
            constructor() { this.unsubscribe = null; }
            render() { const savedKey = localStorage.getItem('gemini_api_key') || ''; return `<div class="max-w-5xl mx-auto h-full flex flex-col pb-24"><div class="flex justify-between items-center mb-6"><div><h3 class="text-xl font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-project-diagram text-blue-600"></i> AI Issue Trees</h3><p class="text-xs text-slate-500 mt-1">Generate visual mental maps of rules, elements, and exceptions.</p></div></div><div class="grid grid-cols-1 md:grid-cols-4 gap-6 flex-1 overflow-hidden"><div class="md:col-span-1 bg-white p-6 rounded-xl shadow-sm border border-slate-200 overflow-y-auto flex flex-col gap-4"><div class="p-3 bg-blue-50 border border-blue-200 rounded-lg"><label class="block text-xs font-bold text-blue-800 mb-1"><i class="fas fa-key"></i> Gemini API Key</label><input type="password" id="tree-api-key" class="w-full p-2 border border-blue-200 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" value="${savedKey}"></div><div><label class="block text-sm font-medium text-slate-700 mb-1">Legal Topic to Map</label><textarea id="tree-topic" rows="4" class="w-full p-2 border border-slate-200 rounded-lg text-sm resize-none outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Article 1170 (Breach of Obligations)"></textarea></div><button onclick="window.appHandlers.generateTree()" id="btn-generate-tree" class="mt-auto w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg text-sm font-bold shadow-md transition"><i class="fas fa-sitemap mr-1"></i> Draw Visual Tree</button></div><div class="md:col-span-3 bg-white border border-slate-200 rounded-xl p-6 overflow-auto relative shadow-inner" id="tree-output-area"><div class="absolute inset-0 flex flex-col items-center justify-center text-slate-400"><i class="fas fa-project-diagram text-6xl mb-4 opacity-20"></i><p class="font-medium text-slate-500">Provide a topic on the left to map it out.</p></div></div></div></div>`; }
        }

        // --- 8. AI Legal Search View (FIXED TEXT WRAPPING PROMPT FOR ISSUE TREE BELOW) ---
        class AiSearchView {
            constructor() { this.unsubscribe = null; this.searchHistory = []; this.chatHistory = []; this.subjects = []; }
            render() {
                const savedKey = localStorage.getItem('gemini_api_key') || '';
                return `
                    <div class="max-w-5xl mx-auto h-[calc(100vh-8rem)] flex flex-col pb-4">
                        <div class="flex justify-between items-center mb-6 flex-shrink-0">
                            <div>
                                <h3 class="text-xl font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-search text-blue-600"></i> AI Legal Search</h3>
                                <p class="text-xs text-slate-500 mt-1">Chat with Gemini. Paste scenarios for Bar-style ALAC answers.</p>
                            </div>
                            <button onclick="window.appHandlers.clearAiSearch()" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-4 py-2 rounded-lg text-sm font-bold transition shadow-sm">
                                <i class="fas fa-broom mr-1"></i> Clear Chat
                            </button>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-1 min-h-0">
                            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col gap-4 h-full overflow-y-auto">
                                <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg flex-shrink-0">
                                    <label class="block text-xs font-bold text-blue-800 mb-1"><i class="fas fa-key"></i> Gemini API Key</label>
                                    <input type="password" id="search-api-key" class="w-full p-2 border border-blue-200 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" value="${savedKey}">
                                </div>
                                <div class="flex-1 flex flex-col min-h-[200px]">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Your Question or Scenario</label>
                                    <textarea id="search-query" class="w-full p-3 border border-slate-200 rounded-lg text-sm resize-none outline-none focus:ring-2 focus:ring-blue-500 flex-1" placeholder="e.g. Maya Man traveled to Italy to marry... Is Maha Dera entitled to damages?"></textarea>
                                </div>
                                <button onclick="window.appHandlers.performAiSearch()" id="btn-ai-search" class="mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg text-sm font-bold shadow-md transition flex-shrink-0">
                                    <i class="fas fa-paper-plane mr-1"></i> Send to Gemini
                                </button>
                            </div>
                            <div class="lg:col-span-2 bg-slate-50 border border-slate-200 rounded-xl p-6 flex flex-col relative h-full overflow-y-auto" id="search-output-area">
                                <div class="absolute inset-0 flex flex-col items-center justify-center text-slate-400" id="search-placeholder">
                                    <i class="fas fa-robot text-6xl mb-4 opacity-20"></i>
                                    <p class="font-medium text-slate-500">Send a message to start the conversation.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            init() {
                this.unsubscribe = AppDB.subscribe('subjects', (snapshot) => {
                    this.subjects = [];
                    if (!snapshot.empty) { snapshot.forEach(doc => this.subjects.push({ id: doc.id, ...doc.data() })); }
                    document.querySelectorAll('.search-subject-dropdown').forEach(select => {
                        const currentVal = select.value;
                        select.innerHTML = '<option value="">Select Notebook to Save...</option>' + this.subjects.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                        select.value = currentVal;
                    });
                });
            }
        }

        // --- 9. Digests View ---
        class DigestsView {
            constructor() { this.unsubscribe = null; }
            render() { return `<div class="max-w-5xl mx-auto h-full flex flex-col pb-24"><div class="flex justify-between items-center mb-6 flex-shrink-0"><div><h3 class="text-xl font-bold text-slate-700">Consolidated Case Digests</h3></div><button onclick="window.appHandlers.addDigest()" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-md"><i class="fas fa-plus mr-2"></i>Manual Digest</button></div><div class="bg-white rounded-xl shadow-sm border border-slate-200 flex-1 overflow-hidden flex flex-col"><div id="digest-list" class="overflow-y-auto flex-1 p-6 space-y-4"></div></div></div>`; }
            init() {
                this.unsubscribe = AppDB.subscribe('digests', (snapshot) => {
                    const list = document.getElementById('digest-list'); if (!list) return; list.innerHTML = '';
                    if(snapshot.empty) { list.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-slate-400"><i class="fas fa-folder-open text-5xl mb-4 opacity-30"></i><p>No case digests found.</p></div>`; return; }
                    const sortedDigests = []; snapshot.forEach(doc => sortedDigests.push({ id: doc.id, ...doc.data() })); sortedDigests.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
                    sortedDigests.forEach(data => {
                        const row = document.createElement('div'); row.className = "p-5 border border-slate-200 rounded-xl hover:border-blue-300 bg-slate-50 transition shadow-sm";
                        const safeTitle = data.title ? data.title.replace(/'/g, "\\'") : ''; const safeSubject = data.subject ? data.subject.replace(/'/g, "\\'") : '';
                        let downloadString = `Title: ${safeTitle}\nSubject: ${safeSubject}\n\n`; if (data.facts) downloadString += `FACTS:\n${data.facts.replace(/'/g, "\\'").replace(/\n/g, "\\n")}\n\n`; if (data.issue) downloadString += `ISSUE:\n${data.issue.replace(/'/g, "\\'").replace(/\n/g, "\\n")}\n\n`; if (data.ruling) downloadString += `RULING:\n${data.ruling.replace(/'/g, "\\'").replace(/\n/g, "\\n")}`;
                        let printString = `<h1>${safeTitle}</h1><p><strong>Subject:</strong> ${safeSubject}</p><br>`; if (data.facts) printString += `<h3>FACTS</h3><p>${data.facts.replace(/'/g, "\\'").replace(/\n/g, "<br>")}</p><br>`; if (data.issue) printString += `<h3>ISSUE</h3><p>${data.issue.replace(/'/g, "\\'").replace(/\n/g, "<br>")}</p><br>`; if (data.ruling) printString += `<h3>RULING</h3><p>${data.ruling.replace(/'/g, "\\'").replace(/\n/g, "<br>")}</p>`;
                        row.innerHTML = `<div class="flex justify-between items-start"><div class="flex-1 pr-4"><h4 class="font-bold text-slate-800 serif-text text-lg leading-snug">${data.title}</h4><span class="inline-block mt-2 bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-bold uppercase tracking-wider">${data.subject}</span></div><button onclick="window.appHandlers.deleteDigest('${data.id}')" class="text-slate-300 hover:text-red-500 transition bg-white border border-slate-200 p-2 rounded shadow-sm"><i class="fas fa-trash"></i></button></div><details class="mt-4 group cursor-pointer outline-none"><summary class="font-bold text-sm text-blue-600 hover:text-blue-800 outline-none list-none flex items-center gap-2 select-none border-t border-slate-200 pt-3"><div class="flex items-center gap-2 flex-1"><i class="fas fa-chevron-right text-xs transition-transform group-open:rotate-90"></i> Read Full Digest</div><div class="flex gap-2"><button onclick="event.stopPropagation(); window.appHandlers.printContent('${safeTitle}', '${printString.replace(/'/g, "\\'")}')" class="text-xs text-slate-400 hover:text-blue-600 p-1"><i class="fas fa-print"></i></button><button onclick="event.stopPropagation(); window.appHandlers.downloadText('${safeTitle}_Digest.txt', \`${downloadString.replace(/`/g, "'")}\`)" class="text-xs text-slate-400 hover:text-blue-600 p-1"><i class="fas fa-download"></i></button></div></summary><div class="mt-4 p-5 bg-white border border-slate-200 rounded-xl space-y-5 shadow-inner cursor-text text-sm">${data.facts ? `<div><h5 class="font-bold text-slate-500 text-xs uppercase tracking-widest mb-2 border-b border-slate-100 pb-1">Facts</h5><p class="text-slate-700 leading-relaxed whitespace-pre-wrap">${data.facts}</p></div>` : ''}${data.issue ? `<div><h5 class="font-bold text-slate-500 text-xs uppercase tracking-widest mb-2 border-b border-slate-100 pb-1">Issue</h5><p class="text-slate-800 font-semibold leading-relaxed whitespace-pre-wrap">${data.issue}</p></div>` : ''}<div><h5 class="font-bold text-slate-500 text-xs uppercase tracking-widest mb-2 border-b border-slate-100 pb-1">Ruling</h5><p class="text-slate-700 leading-relaxed whitespace-pre-wrap">${data.ruling || 'No ruling extracted.'}</p></div></div></details>`; list.appendChild(row);
                    });
                });
            }
        }

        // --- 10. Case Digester View ---
        class CaseDigesterView {
            constructor() { this.digestedData = null; }
            render() { const savedKey = localStorage.getItem('gemini_api_key') || ''; return `<div class="max-w-5xl mx-auto h-full flex flex-col pb-24"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-magic text-amber-500"></i> AI Case Digester</h3></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6 flex-1 overflow-hidden"><div class="md:col-span-1 bg-white p-6 rounded-xl shadow-sm border border-slate-200 overflow-y-auto flex flex-col gap-4"><div class="p-3 bg-blue-50 border border-blue-200 rounded-lg"><label class="block text-xs font-bold text-blue-800 mb-1"><i class="fas fa-key"></i> Gemini API Key</label><input type="password" id="gemini-api-key" placeholder="Paste key here..." class="w-full p-2 border border-blue-200 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" value="${savedKey}"></div><div><label class="block text-sm font-medium text-slate-700 mb-1">Case Title <span class="text-red-500">*</span></label><input type="text" id="digest-title" placeholder="e.g. People vs. Example" class="w-full p-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-amber-500 outline-none"></div><div><label class="block text-sm font-medium text-slate-700 mb-1">Subject Matter <span class="text-red-500">*</span></label><input type="text" id="digest-subject" placeholder="e.g. Crim 1" class="w-full p-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-amber-500 outline-none"></div><div class="border-t border-slate-100 pt-4"><label class="block text-sm font-medium text-slate-700 mb-1">Paste Full Text</label><textarea id="digest-textarea" rows="4" class="w-full p-2 border border-slate-200 rounded-lg text-sm resize-none focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Paste case text here..."></textarea></div><div class="text-center text-xs text-slate-400 font-bold uppercase tracking-wider my-1">- OR -</div><div><label class="block text-sm font-medium text-slate-700 mb-1">Upload PDF</label><div class="border-2 border-dashed border-slate-300 rounded-lg p-4 text-center hover:bg-slate-50 transition cursor-pointer relative"><input type="file" accept=".pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="window.appHandlers.handleDigestUpload(this)"><i class="fas fa-file-pdf text-2xl text-red-400 mb-1"></i><p class="text-xs text-slate-500">Click to upload PDF</p></div><div id="digest-filename" class="text-xs text-blue-600 mt-2 truncate hidden font-medium"></div></div><button onclick="window.appHandlers.processDigest()" id="btn-process-digest" class="w-full bg-slate-800 text-white py-3 rounded-lg text-sm font-bold hover:bg-slate-700 transition shadow-md mt-auto"><i class="fas fa-robot mr-1"></i> Digest & Auto-Save</button></div><div class="md:col-span-2 bg-slate-50 border border-slate-200 rounded-xl p-6 overflow-y-auto" id="digest-results-area"><div class="h-full flex flex-col items-center justify-center text-slate-400 text-center"><i class="fas fa-brain text-5xl mb-4 opacity-20"></i><p class="text-sm font-medium">Provide the case text and your API key.</p><p class="text-xs mt-1">Gemini will read it, extract the core elements, and automatically save it.</p></div></div></div></div>`; }
        }

        // --- 11. Review View ---
        class ReviewView {
            constructor() { this.generatedContent = null; this.isProcessing = false; }
            render() { const savedKey = localStorage.getItem('gemini_api_key') || ''; return `<div class="max-w-5xl mx-auto h-full flex flex-col pb-24"><div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full"><div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col h-full overflow-y-auto"><h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2"><i class="fas fa-graduation-cap text-blue-600"></i> AI Mock Review</h3><div class="p-3 bg-blue-50 border border-blue-200 rounded-lg mb-4"><label class="block text-xs font-bold text-blue-800 mb-1"><i class="fas fa-key"></i> Gemini API Key</label><input type="password" id="review-api-key" placeholder="Paste key here..." class="w-full p-2 border border-blue-200 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" value="${savedKey}"></div><div><label class="block text-sm font-medium text-slate-700 mb-1">Paste Text <span class="text-xs text-slate-400 font-normal">(Best for Codals)</span></label><textarea id="review-textarea" rows="4" class="w-full p-2 border border-slate-200 rounded-lg text-sm resize-none focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Paste provisions or notes here..." oninput="document.getElementById('btn-generate').disabled = false;"></textarea></div><div class="text-center text-xs text-slate-400 font-bold uppercase tracking-wider my-2">- OR -</div><div class="border-2 border-dashed border-slate-300 rounded-lg p-4 text-center hover:bg-slate-50 transition cursor-pointer relative" id="drop-zone"><input type="file" id="pdf-upload" accept=".pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="window.appHandlers.handleFileUpload(this)"><i class="fas fa-file-pdf text-2xl text-slate-400 mb-2"></i><p class="text-sm font-medium text-slate-600">Upload text-searchable PDF</p></div><div id="file-name-display" class="mt-2 text-xs text-blue-600 font-medium truncate hidden"></div><div class="mt-4 space-y-3"><label class="block text-sm font-medium text-slate-700">Review Mode</label><div class="grid grid-cols-2 gap-2"><button onclick="window.appHandlers.setMode('recit')" id="btn-recit" class="px-4 py-2 rounded border border-slate-200 text-sm font-medium bg-slate-800 text-white transition">Recit (Flashcards)</button><button onclick="window.appHandlers.setMode('exam')" id="btn-exam" class="px-4 py-2 rounded border border-slate-200 text-sm font-medium hover:bg-slate-50 text-slate-600 transition">Exam (Essay)</button></div></div><button onclick="window.appHandlers.generateReview()" id="btn-generate" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold shadow-md transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>Generate AI Review</button></div><div class="lg:col-span-2 bg-slate-200 rounded-xl border border-slate-300 p-6 overflow-y-auto flex flex-col relative" id="review-output"><div class="absolute inset-0 flex flex-col items-center justify-center text-slate-500 pointer-events-none p-8 text-center"><i class="fas fa-brain text-4xl mb-4 opacity-50"></i><h4 class="text-lg font-semibold">AI Mock Review</h4><p class="text-sm max-w-xs mt-2">Paste text or upload a PDF to generate interactive practice questions based on your material.</p></div></div></div></div>`; }
        }

        // --- 12. Saved Reviews View ---
        class SavedReviewsView {
            constructor() { this.unsubscribe = null; }
            render() { return `<div class="max-w-5xl mx-auto h-full flex flex-col pb-24"><div class="flex justify-between items-center mb-6 flex-shrink-0"><h3 class="text-xl font-bold text-slate-700">My Saved Reviews & SRS</h3></div><div class="bg-white rounded-xl shadow-sm border border-slate-200 flex-1 overflow-hidden flex flex-col"><div id="saved-reviews-list" class="overflow-y-auto flex-1 p-6 space-y-4"></div></div></div>`; }
            init() {
                this.unsubscribe = AppDB.subscribe('reviews', (snapshot) => {
                    const list = document.getElementById('saved-reviews-list'); if (!list) return; list.innerHTML = '';
                    if (snapshot.empty) { list.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-slate-400"><i class="fas fa-archive text-5xl mb-4 opacity-30"></i><p>No saved reviews yet.</p></div>`; return; }
                    window.appHandlers.savedExamData = {}; window.appHandlers.savedReviewData = {};
                    const sortedReviews = []; snapshot.forEach(doc => sortedReviews.push({ id: doc.id, ...doc.data() })); sortedReviews.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
                    sortedReviews.forEach(data => {
                        window.appHandlers.savedReviewData[data.id] = data.content; 
                        const row = document.createElement('div'); row.className = "p-5 border border-slate-200 rounded-xl hover:border-blue-300 bg-slate-50 transition shadow-sm";
                        let contentHtml = ''; let textForDownload = ''; const safeTitle = data.title ? data.title.replace(/'/g, "\\'") : 'Review';

                        if (data.type === 'recit') {
                            const now = Date.now(); let dueCards = []; let futureCards = [];
                            data.content.forEach((c, i) => { textForDownload += `Q${i+1}: ${c.front}\nA: ${c.back}\n\n`; if (!c.nextReview || c.nextReview <= now) { dueCards.push({card: c, index: i}); } else { futureCards.push({card: c, index: i}); } });
                            contentHtml = `<div class="mb-4 flex justify-between items-center bg-blue-50 p-3 rounded-lg border border-blue-100"><span class="font-bold text-blue-800"><i class="fas fa-brain mr-2"></i> Spaced Repetition</span><span class="text-sm font-bold bg-white text-blue-600 px-3 py-1 rounded shadow-sm">${dueCards.length} Due Today</span></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">`;
                            dueCards.forEach(({card, index}) => { contentHtml += `<div class="border border-slate-200 rounded-xl p-5 bg-white shadow-sm flex flex-col justify-between group"><div><p class="text-[10px] text-red-600 font-bold uppercase mb-2 tracking-widest"><i class="fas fa-exclamation-circle"></i> Due For Review</p><p class="text-sm font-semibold text-slate-800 mb-4 leading-relaxed">${card.front}</p></div><details class="text-sm group-details cursor-pointer outline-none mt-auto border-t border-slate-100 pt-3"><summary class="text-xs text-amber-600 font-bold hover:text-amber-700 outline-none list-none select-none">(Reveal Answer)</summary><div class="mt-3 p-3 bg-amber-50 rounded border border-amber-200 text-slate-700 leading-relaxed shadow-inner mb-3">${card.back}</div><div class="grid grid-cols-3 gap-2 mt-2"><button onclick="window.appHandlers.rateFlashcard('${data.id}', ${index}, 'hard')" class="bg-red-100 hover:bg-red-200 text-red-700 text-xs font-bold py-1.5 rounded transition">Hard (1d)</button><button onclick="window.appHandlers.rateFlashcard('${data.id}', ${index}, 'good')" class="bg-blue-100 hover:bg-blue-200 text-blue-700 text-xs font-bold py-1.5 rounded transition">Good (3d)</button><button onclick="window.appHandlers.rateFlashcard('${data.id}', ${index}, 'easy')" class="bg-green-100 hover:bg-green-200 text-green-700 text-xs font-bold py-1.5 rounded transition">Easy (7d)</button></div></details></div>`; });
                            if(futureCards.length > 0) {
                                contentHtml += `</div><h5 class="font-bold text-sm text-slate-500 mb-3 border-b border-slate-200 pb-2">Scheduled for Later (${futureCards.length})</h5><div class="grid grid-cols-1 md:grid-cols-2 gap-4 opacity-70">`;
                                futureCards.forEach(({card, index}) => { const days = Math.ceil((card.nextReview - now) / (1000 * 60 * 60 * 24)); contentHtml += `<div class="border border-slate-200 rounded-xl p-5 bg-slate-50 flex flex-col justify-between"><div><p class="text-[10px] text-slate-500 font-bold uppercase mb-2 tracking-widest"><i class="fas fa-clock mr-1"></i> Due in ${days} days</p><p class="text-sm font-semibold text-slate-600 mb-2">${card.front}</p></div></div>`; });
                            }
                            contentHtml += `</div>`;
                        } else {
                            window.appHandlers.savedExamData[data.id] = data.content;
                            data.content.forEach((c, i) => {
                                textForDownload += `Question ${i+1}:\n${c.question}\n\nSuggested Guide:\n${c.suggested_answer}\n\n-----------------\n\n`;
                                contentHtml += `<div class="mb-8 p-5 bg-white border border-slate-200 rounded-xl shadow-sm"><h4 class="font-bold mb-3 text-lg font-sans text-blue-800">Question ${i+1}</h4><p class="mb-5 leading-relaxed text-justify whitespace-pre-wrap">${c.question}</p><textarea id="saved-exam-answer-${data.id}-${i}" class="w-full p-4 border border-slate-200 rounded-lg font-sans text-sm focus:ring-0 outline-none resize-y min-h-[150px] shadow-inner bg-slate-50 placeholder-slate-400" placeholder="Type your answer here..."></textarea><div class="mt-4"><button onclick="window.appHandlers.evaluateAnswer(${i}, '${data.id}')" id="btn-eval-${data.id}-${i}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition"><i class="fas fa-check-double mr-1"></i> Check Answer</button></div><div id="eval-result-${data.id}-${i}" class="mt-4 hidden"></div><details class="mt-5 font-sans text-sm group border-t border-slate-100 pt-4"><summary class="cursor-pointer text-amber-600 font-bold flex items-center gap-2 hover:text-amber-700 outline-none list-none"><i class="fas fa-lightbulb transition-transform group-open:text-green-500"></i> Show Suggested Answer</summary><div class="mt-3 p-5 bg-amber-50 border border-amber-200 rounded-xl text-slate-800 leading-relaxed shadow-inner whitespace-pre-wrap">${c.suggested_answer}</div></details></div>`;
                            });
                        }
                        row.innerHTML = `<div class="flex justify-between items-start"><div class="flex-1 pr-4"><h4 class="font-bold text-slate-800 serif-text text-lg leading-snug">${data.title}</h4><span class="inline-block mt-2 ${data.type === 'recit' ? 'bg-amber-100 text-amber-800' : 'bg-blue-100 text-blue-800'} px-2 py-1 rounded text-xs font-bold uppercase tracking-wider">${data.type === 'recit' ? 'Flashcards' : 'Mock Exam'}</span></div><button onclick="window.appHandlers.deleteReview('${data.id}')" class="text-slate-300 hover:text-red-500 transition bg-white border border-slate-200 p-2 rounded shadow-sm"><i class="fas fa-trash"></i></button></div><details class="mt-4 group cursor-pointer outline-none"><summary class="font-bold text-sm text-blue-600 hover:text-blue-800 outline-none list-none flex items-center gap-2 select-none border-t border-slate-200 pt-3"><div class="flex items-center gap-2 flex-1"><i class="fas fa-chevron-right text-xs transition-transform group-open:rotate-90"></i> Open Material</div><div class="flex gap-2"><button onclick="event.stopPropagation(); window.appHandlers.printContent('${safeTitle}', '<h1>${safeTitle}</h1><br>${textForDownload.replace(/\n/g, '<br>').replace(/'/g, "\\'")}')" class="text-xs text-slate-400 hover:text-blue-600 p-1"><i class="fas fa-print"></i></button><button onclick="event.stopPropagation(); window.appHandlers.downloadText('${safeTitle}.txt', \`${textForDownload.replace(/`/g, "'")}\`)" class="text-xs text-slate-400 hover:text-blue-600 p-1"><i class="fas fa-download"></i></button></div></summary><div class="mt-4 cursor-text border-t border-slate-200 pt-4">${contentHtml}</div></details>`;
                        list.appendChild(row);
                    });
                });
            }
        }

        const views = {
            dashboard: new DashboardView(), subjects: new SubjectsView(), subject_notebook: new SubjectNotebookView(), matrix: new DoctrineMatrixView(),
            codal_trainer: new CodalTrainerView(), mnemonic: new MnemonicView(), issue_tree: new IssueTreeView(), ai_search: new AiSearchView(), digests: new DigestsView(),
            case_digester: new CaseDigesterView(), review: new ReviewView(), saved_reviews: new SavedReviewsView(),
            codals: { render: () => { return `<div class="text-center mt-20 text-slate-500">Opening eCodal+ in a new tab...</div>`; }, init: () => {} }
        };

        const sidebarNav = document.querySelector('nav'); const contentArea = document.getElementById('content-area'); const pageTitle = document.getElementById('page-title');
        
        const navItems = [
            { id: 'dashboard', label: 'Dashboard', icon: 'fa-home' }, { id: 'subjects', label: 'Subjects', icon: 'fa-book' }, { id: 'matrix', label: 'Doctrine Matrix', icon: 'fa-table' },
            { id: 'codals', label: 'Codals', icon: 'fa-balance-scale' }, { id: 'codal_trainer', label: 'Codal Trainer', icon: 'fa-eye-slash' }, { id: 'mnemonic', label: 'Mnemonic Maker', icon: 'fa-lightbulb' },
            { id: 'issue_tree', label: 'Issue Trees', icon: 'fa-project-diagram' }, { id: 'ai_search', label: 'AI Legal Search', icon: 'fa-search' }, { id: 'digests', label: 'Cons. Digests', icon: 'fa-gavel' }, 
            { id: 'case_digester', label: 'Case Digester', icon: 'fa-magic' }, { id: 'review', label: 'Mock Review', icon: 'fa-graduation-cap' }, { id: 'saved_reviews', label: 'Saved Reviews', icon: 'fa-archive' }
        ];

        function renderSidebar() {
            sidebarNav.innerHTML = navItems.map(item => {
                if (item.id === 'codals') {
                    return `<a href="https://www.ecodalplus.com/ecodals" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors mb-1 text-slate-300 hover:bg-slate-800 hover:text-white"><i class="fas ${item.icon} w-5 text-center"></i>${item.label}</a>`;
                } else {
                    return `<a href="#" onclick="event.preventDefault(); window.appHandlers.navigate('${item.id}')" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors mb-1 ${currentView === item.id ? 'bg-blue-600 text-white shadow-md' : 'text-slate-300 hover:bg-slate-800 hover:text-white'}"><i class="fas ${item.icon} w-5 text-center"></i>${item.label}</a>`;
                }
            }).join('');
        }

        window.appHandlers = {

            // --- AI LEGAL SEARCH ---
            clearAiSearch: () => {
                views.ai_search.searchHistory = []; views.ai_search.chatHistory = []; const output = document.getElementById('search-output-area');
                output.innerHTML = `<div class="absolute inset-0 flex flex-col items-center justify-center text-slate-400" id="search-placeholder"><i class="fas fa-robot text-6xl mb-4 opacity-20"></i><p class="font-medium text-slate-500">Send a message to start the conversation.</p></div>`;
            },
            performAiSearch: async () => {
                const apiKey = document.getElementById('search-api-key').value.trim(); const queryInput = document.getElementById('search-query'); const query = queryInput.value.trim(); const output = document.getElementById('search-output-area'); const btn = document.getElementById('btn-ai-search');
                if (!apiKey) { alert("Please enter your Gemini API Key."); return; } localStorage.setItem('gemini_api_key', apiKey); if (!query) { alert("Please enter a question or topic to search."); return; }
                btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; const placeholder = document.getElementById('search-placeholder'); if (placeholder) placeholder.remove();
                const msgId = Date.now();
                output.insertAdjacentHTML('beforeend', `<div class="mb-4 w-full flex justify-end animate-fade-in"><div class="bg-blue-600 text-white p-4 rounded-xl rounded-tr-none shadow-sm max-w-[85%] text-sm whitespace-pre-wrap leading-relaxed">${query}</div></div><div id="loading-${msgId}" class="mb-4 w-full flex justify-start"><div class="bg-white p-4 rounded-xl rounded-tl-none shadow-sm border border-slate-200 flex items-center gap-3"><div class="loader" style="width: 16px; height: 16px; border-width: 2px;"></div><p class="text-slate-500 text-sm font-medium animate-pulse">Professor Gemini is researching...</p></div></div>`);
                output.scrollTop = output.scrollHeight; queryInput.value = ''; 
                try {
                    const promptText = `You are a brilliant and highly accurate Philippine Law Professor and Bar Reviewer. Analyze the following query: "${query}". If the query is a factual scenario, a problem-solving question, or a hypothetical case, you MUST format your response strictly using the ALAC Method in PARAGRAPH FORM (Do not use bullet points or strict headings). Write exactly 3 to 4 flowing paragraphs: 1. First paragraph (Answer): A categorical Yes or No, followed by a brief reason. 2. Second paragraph (Legal Basis & Application): State the law or jurisprudence. You MUST **bold** the name of the legal basis (e.g., **Article 1169 of the Civil Code** or **Negotiorum Gestio**). Then, seamlessly apply this law to the specific facts of the scenario. 3. Third paragraph (Conclusion): A brief, final conclusion resolving the issue. If the query is just a general question or definition, provide a comprehensive and structured explanation citing relevant Philippine laws or jurisprudence. Format your response cleanly using HTML tags like <p> and <b> for readability. Do NOT use markdown code blocks like \`\`\`html.`;
                    let currentContext = [...views.ai_search.chatHistory]; currentContext.push({ role: "user", parts: [{ text: promptText }] });
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: currentContext }) });
                    if (!response.ok) throw new Error("API Error"); const data = await response.json(); const rawResponse = data.candidates[0].content.parts[0].text;
                    let answerHtml = rawResponse.replace(/^```html\s*/i, '').replace(/^```\s*/i, '').replace(/\s*```$/i, '').trim();
                    document.getElementById(`loading-${msgId}`).remove();
                    views.ai_search.chatHistory.push({ role: "user", parts: [{ text: query }] }); views.ai_search.chatHistory.push({ role: "model", parts: [{ text: rawResponse }] });
                    const plainText = document.createElement('div'); plainText.innerHTML = answerHtml.replace(/<br\s*[\/]?>/gi, '\n').replace(/<\/p>/gi, '\n\n').replace(/<li>/gi, '• ').replace(/<\/li>/gi, '\n'); const cleanPlainText = plainText.innerText || plainText.textContent;
                    const historyIndex = views.ai_search.searchHistory.length; views.ai_search.searchHistory.push({ query: query, answerHtml: answerHtml, plainText: cleanPlainText });
                    const subjectOptions = '<option value="">Select Notebook...</option>' + views.ai_search.subjects.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                    output.insertAdjacentHTML('beforeend', `<div class="mb-6 w-full flex justify-start animate-fade-in"><div class="bg-white p-5 rounded-xl rounded-tl-none shadow-sm border border-slate-200 max-w-[95%] text-slate-800 leading-relaxed font-serif text-sm group"><h4 class="font-bold text-blue-600 text-[10px] uppercase tracking-wider mb-3 border-b border-slate-100 pb-2"><i class="fas fa-robot mr-1"></i> Professor Gemini</h4>${answerHtml}<div class="mt-4 pt-3 border-t border-slate-100 flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><select id="save-select-${historyIndex}" class="search-subject-dropdown p-1.5 rounded border border-slate-300 text-xs outline-none focus:ring-1 focus:ring-blue-500 max-w-[150px]">${subjectOptions}</select><button onclick="window.appHandlers.saveAiSearch(${historyIndex})" class="bg-blue-50 text-blue-700 hover:bg-blue-100 px-3 py-1.5 rounded text-xs font-bold transition shadow-sm"><i class="fas fa-save mr-1"></i> Save to Notes</button></div></div></div>`);
                    output.scrollTop = output.scrollHeight;
                } catch (error) { document.getElementById(`loading-${msgId}`).remove(); output.insertAdjacentHTML('beforeend', `<div class="mb-4 w-full flex justify-start"><div class="p-4 bg-red-50 text-red-700 rounded-xl rounded-tl-none border border-red-200 shadow-sm text-sm">Failed to search: ${error.message}</div></div>`); output.scrollTop = output.scrollHeight; } finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-paper-plane mr-1"></i> Send to Gemini'; }
            },
            saveAiSearch: async (index) => {
                const historyItem = views.ai_search.searchHistory[index]; const subjectSelect = document.getElementById(`save-select-${index}`); const subjectId = subjectSelect.value;
                if (!subjectId) { alert("Please select a notebook from the dropdown first."); return; }
                const title = `AI Search: ${historyItem.query.substring(0, 30)}...`; const content = `QUERY:\n${historyItem.query}\n\nANSWER:\n${historyItem.plainText.trim()}`;
                try { await AppDB.add('notes', { subjectId: subjectId, title: title, content: content, created: serverTimestamp() }); alert("Search result successfully saved to your notebook!"); const subjectName = subjectSelect.options[subjectSelect.selectedIndex].text; window.appHandlers.openSubject(subjectId, subjectName); } catch(e) { alert("Error saving to notebook."); console.error(e); }
            },

            // --- ISSUE TREE MAKER (WITH TEXT WRAPPING PROMPT) ---
            generateTree: async () => {
                const apiKey = document.getElementById('tree-api-key').value.trim(); const topic = document.getElementById('tree-topic').value.trim(); const outputArea = document.getElementById('tree-output-area'); const btn = document.getElementById('btn-generate-tree');
                if (!apiKey) { alert("Please enter your Gemini API Key."); return; } localStorage.setItem('gemini_api_key', apiKey); if (!topic) { alert("Please enter a legal topic."); return; }
                btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Mapping...'; outputArea.innerHTML = `<div class="absolute inset-0 flex flex-col items-center justify-center text-slate-400"><div class="loader mb-4"></div><p class="text-sm font-medium animate-pulse">Gemini is structuring the rules...</p></div>`;
                try {
                    // FIXED: Explicitly asking Gemini to wrap text using <br> tags.
                    const promptText = `You are a law professor. Create a Mermaid.js flowchart mapping out the general rule, elements, and exceptions for the legal topic: "${topic}". Use a top-down flowchart format starting with "graph TD". Keep nodes short and concise. IMPORTANT: To prevent text from being cut off, use <br> tags to wrap long text inside nodes into multiple lines (e.g., C[4. No Legal Excuse<br>for Non-compliance]). Output ONLY the raw Mermaid syntax. Do NOT use markdown backticks like \`\`\`mermaid. Just output the code.`;
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: promptText }] }] }) });
                    if (!response.ok) throw new Error("API Error"); const data = await response.json(); let mermaidSyntax = data.candidates[0].content.parts[0].text;
                    mermaidSyntax = mermaidSyntax.replace(/^```mermaid\s*/i, '').replace(/^```\s*/i, '').replace(/\s*```$/i, '').trim();
                    const { svg } = await mermaid.render('mermaid-graph-generated', mermaidSyntax);
                    
                    // FIXED: Added overflow-x-auto to the container to prevent squishing
                    outputArea.innerHTML = `<div class="w-full flex justify-between items-center mb-4"><h4 class="font-bold text-slate-800 text-sm tracking-wider uppercase">Visual Map: ${topic}</h4><button onclick="window.appHandlers.printContent('Issue Tree: ${topic.replace(/'/g, "\\'")}', document.getElementById('rendered-tree-container').innerHTML)" class="text-xs bg-slate-100 text-slate-600 hover:text-blue-600 px-3 py-1.5 rounded transition font-bold"><i class="fas fa-print mr-1"></i> Print / PDF</button></div><div id="rendered-tree-container" class="mermaid w-full flex justify-center bg-white p-4 rounded border border-slate-100 overflow-x-auto">${svg}</div>`;
                } catch(e) { outputArea.innerHTML = `<div class="absolute inset-0 flex flex-col items-center justify-center p-8 text-center text-red-500"><i class="fas fa-exclamation-triangle text-4xl mb-4"></i><p class="font-bold">Failed to draw map.</p><p class="text-xs mt-2 text-slate-500">Gemini may have generated invalid diagram code. Try rephrasing your topic.</p></div>`; console.error(e); } 
                finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-sitemap mr-1"></i> Draw Visual Tree'; }
            },

            // ... (All other existing handlers remain exactly the same)
            generateMnemonic: async () => {
                const apiKey = document.getElementById('mnem-api-key').value.trim(); const topic = document.getElementById('mnem-topic').value.trim(); const elements = document.getElementById('mnem-elements').value.trim(); const output = document.getElementById('mnem-output-area'); const btn = document.getElementById('btn-generate-mnem');
                if (!apiKey) { alert("Please enter your Gemini API Key."); return; } localStorage.setItem('gemini_api_key', apiKey); if (!topic || !elements) { alert("Please provide a topic and the elements."); return; }
                btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Generating...'; output.innerHTML = `<div class="flex justify-center flex-col items-center h-full"><div class="loader mb-4"></div><p class="text-slate-500 font-medium animate-pulse">Brewing a bizarre story...</p></div>`;
                try {
                    const promptText = `You are a creative memory coach for law students. I need to memorize the elements of: "${topic}". Here are the elements: ${elements}. Create TWO things: 1. A catchy ACRONYM (if possible) using the first letters of the key words. 2. A bizarre, vivid, ridiculous, and highly memorable short story that links all these elements together. The weirder, the better the brain remembers it. Format the output strictly in valid JSON format like this: {"acronym": "The acronym and what it stands for", "story": "The vivid story"}. Do not use markdown blocks like \`\`\`json.`;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: promptText }] }], generationConfig: { responseMimeType: "application/json" } }) });
                    if (!response.ok) throw new Error("API Error"); const data = await response.json(); let jsonString = data.candidates[0].content.parts[0].text.replace(/^```json\s*/i, '').replace(/\s*```$/i, '').trim(); const parsed = JSON.parse(jsonString);
                    views.mnemonic.generatedTitle = `Mnemonic: ${topic}`; views.mnemonic.generatedContent = `ACRONYM:\n${parsed.acronym}\n\nSTORY:\n${parsed.story}\n\nORIGINAL ELEMENTS:\n${elements}`;
                    output.innerHTML = `<div class="mb-6 flex gap-3 items-center bg-white p-4 rounded-xl border border-slate-200 shadow-sm sticky top-0 z-10"><select id="mnem-subject-select" class="flex-1 p-2 rounded-lg border border-slate-300 text-sm outline-none focus:ring-2 focus:ring-blue-500"><option value="">Select Notebook to Save...</option>${views.mnemonic.subjects.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}</select><button onclick="window.appHandlers.saveMnemonic()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg text-sm font-bold shadow-sm transition whitespace-nowrap"><i class="fas fa-save mr-1"></i> Save to Notebook</button></div><div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-4"><h4 class="font-bold text-blue-800 text-sm uppercase tracking-wider mb-3"><i class="fas fa-font mr-2"></i> Acronym</h4><p class="text-slate-700 leading-relaxed">${parsed.acronym.replace(/\n/g, '<br>')}</p></div><div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><h4 class="font-bold text-amber-600 text-sm uppercase tracking-wider mb-3"><i class="fas fa-book-open mr-2"></i> Memory Story</h4><p class="text-slate-800 leading-relaxed font-serif text-lg">${parsed.story.replace(/\n/g, '<br>')}</p></div>`;
                } catch (error) { output.innerHTML = `<div class="p-4 bg-red-50 text-red-700 rounded-lg border border-red-200 shadow-sm">Failed to generate: ${error.message}</div>`; } finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-magic mr-1"></i> Create Mnemonic'; }
            },
            saveMnemonic: async () => {
                const subjectSelect = document.getElementById('mnem-subject-select'); const subjectId = subjectSelect.value;
                if (!subjectId) { alert("Please select a notebook from the dropdown first."); return; }
                try { await AppDB.add('notes', { subjectId: subjectId, title: views.mnemonic.generatedTitle, content: views.mnemonic.generatedContent, created: serverTimestamp() }); alert("Mnemonic successfully saved as a new page in your notebook!"); const subjectName = subjectSelect.options[subjectSelect.selectedIndex].text; window.appHandlers.openSubject(subjectId, subjectName); } 
                catch(e) { alert("Error saving to notebook."); console.error(e); }
            },

            generateBlindCodal: () => {
                const text = document.getElementById('codal-input').value.trim(); if (!text) { alert("Please paste a provision first."); return; }
                const difficulty = parseFloat(document.getElementById('codal-difficulty').value); const stopWords = ['a', 'an', 'the', 'and', 'or', 'but', 'is', 'are', 'to', 'in', 'of', 'for', 'by', 'with', 'on', 'at', 'as', 'it']; const tokens = text.split(/([a-zA-Z0-9]+)/); let eligibleIndices = [];
                tokens.forEach((tok, index) => { if (/[a-zA-Z0-9]+/.test(tok)) { if (tok.length > 3 || !stopWords.includes(tok.toLowerCase())) { eligibleIndices.push(index); } } });
                eligibleIndices.sort(() => Math.random() - 0.5); const blanksCount = Math.floor(eligibleIndices.length * difficulty); const selectedIndices = eligibleIndices.slice(0, blanksCount); let html = '';
                tokens.forEach((tok, index) => {
                    if (selectedIndices.includes(index)) { const width = Math.max(tok.length * 12 + 10, 40); html += `<input type="text" data-answer="${tok}" class="codal-blank border-b-2 border-slate-400 focus:border-blue-600 outline-none text-center bg-slate-50 text-blue-700 mx-1 font-bold font-sans transition-colors" style="width: ${width}px" oninput="window.appHandlers.checkCodalInput(this)">`; } 
                    else { html += tok; }
                });
                html = html.replace(/\n/g, '<br>'); document.getElementById('codal-workspace').classList.remove('hidden'); document.getElementById('codal-test-area').innerHTML = html; const firstBlank = document.querySelector('.codal-blank'); if (firstBlank) firstBlank.focus();
            },
            checkCodalInput: (input) => {
                const answer = input.getAttribute('data-answer');
                if (input.value.toLowerCase().trim() === answer.toLowerCase()) {
                    input.value = answer; input.classList.remove('border-slate-400', 'focus:border-blue-600', 'text-blue-700', 'bg-slate-50'); input.classList.add('border-green-500', 'text-green-700', 'bg-green-50', 'pointer-events-none'); input.readOnly = true;
                    const blanks = Array.from(document.querySelectorAll('.codal-blank:not([readonly])'));
                    if (blanks.length > 0) blanks[0].focus(); else { setTimeout(() => alert("Perfect! You've mastered this provision."), 100); }
                }
            },
            revealCodal: () => { document.querySelectorAll('.codal-blank').forEach(input => { if (!input.readOnly) { input.value = input.getAttribute('data-answer'); input.classList.remove('border-slate-400', 'focus:border-blue-600', 'text-blue-700', 'bg-slate-50'); input.classList.add('border-red-400', 'text-red-600', 'bg-red-50'); input.readOnly = true; } }); },
            resetCodal: () => { window.appHandlers.generateBlindCodal(); },

            renderMatrixRows: (data) => { const list = document.getElementById('matrix-list'); if (!list) return; list.innerHTML = data.map(d => `<tr class="hover:bg-slate-50 transition group"><td class="p-3 align-top"><span class="bg-blue-100 text-blue-800 font-bold px-2 py-1 rounded text-xs whitespace-nowrap">${d.article}</span></td><td class="p-3 align-top"><p class="font-bold text-slate-800 serif-text">${d.caseTitle}</p><p class="text-xs text-slate-500 mt-1">${d.citation}</p></td><td class="p-3 align-top text-slate-700 leading-relaxed">${d.doctrine}</td><td class="p-3 align-top text-center"><button onclick="window.appHandlers.deleteDoctrine('${d.id}')" class="text-slate-300 hover:text-red-500 transition opacity-0 group-hover:opacity-100 bg-white p-1 rounded shadow-sm border border-slate-200"><i class="fas fa-trash"></i></button></td></tr>`).join(''); },
            filterMatrix: () => { const term = document.getElementById('matrix-search').value.toLowerCase(); const filtered = views.matrix.doctrines.filter(d => d.article.toLowerCase().includes(term) || d.caseTitle.toLowerCase().includes(term) || d.doctrine.toLowerCase().includes(term)); window.appHandlers.renderMatrixRows(filtered); },
            addDoctrine: () => { Modal.show({ title: '<i class="fas fa-table text-blue-600"></i> Map New Doctrine', content: `<div class="grid grid-cols-2 gap-3 mb-3"><div><label class="block text-sm font-medium text-slate-700 mb-1">Article / Topic</label><input type="text" id="doc-art" class="w-full p-2 border border-slate-300 rounded-lg outline-none" placeholder="e.g., Art. 1156"></div><div><label class="block text-sm font-medium text-slate-700 mb-1">Citation / Year</label><input type="text" id="doc-cite" class="w-full p-2 border border-slate-300 rounded-lg outline-none" placeholder="e.g., G.R. 12345 (2020)"></div></div><div class="mb-3"><label class="block text-sm font-medium text-slate-700 mb-1">Case Title</label><input type="text" id="doc-title" class="w-full p-2 border border-slate-300 rounded-lg outline-none" placeholder="e.g., People vs. Example"></div><div><label class="block text-sm font-medium text-slate-700 mb-1">1-Sentence Doctrine</label><textarea id="doc-text" rows="3" class="w-full p-2 border border-slate-300 rounded-lg outline-none resize-none" placeholder="State the core ruling concisely..."></textarea></div>`, onSubmit: async () => { const article = document.getElementById('doc-art').value.trim() || 'General'; const caseTitle = document.getElementById('doc-title').value.trim(); const citation = document.getElementById('doc-cite').value.trim(); const doctrine = document.getElementById('doc-text').value.trim(); if (!caseTitle || !doctrine) { alert("Case Title and Doctrine are required."); throw new Error("Validation failed"); } await AppDB.add('doctrines', { article, caseTitle, citation, doctrine, created: serverTimestamp() }); } }); },
            deleteDoctrine: (id) => { Modal.show({ title: '<i class="fas fa-trash text-red-500"></i> Delete Doctrine', content: '<p>Are you sure you want to remove this doctrine from your matrix?</p>', submitText: 'Delete', submitClass: 'px-4 py-2 bg-red-600 text-white rounded-lg', onSubmit: async () => await AppDB.delete('doctrines', id) }); },

            printContent: (title, htmlContent) => { const printWindow = window.open('', '', 'height=600,width=800'); printWindow.document.write('<html><head><title>'+title+'</title><script src="https://cdn.tailwindcss.com"><\\/script><link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet"></head><body class="p-10 font-serif leading-relaxed text-slate-800">'); printWindow.document.write(htmlContent); printWindow.document.write('</body></html>'); printWindow.document.close(); setTimeout(() => printWindow.print(), 800); },
            printNote: (title) => { const content = document.getElementById('note-content-editor').value; const html = `<h1>${title}</h1><br><p>${content.replace(/\n/g, '<br>')}</p>`; window.appHandlers.printContent(title, html); },
            downloadText: (filename, textContent) => { const cleanText = typeof textContent === 'string' ? textContent.replace(/\\n/g, '\n') : textContent; const element = document.createElement('a'); element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(cleanText)); element.setAttribute('download', filename); element.style.display = 'none'; document.body.appendChild(element); element.click(); document.body.removeChild(element); },
            
            login: async () => { try { await signInWithPopup(auth, provider); } catch (e) { alert("Login failed. Check Authorized Domains in Firebase Console."); } },
            logout: async () => { try { await signOut(auth); } catch (e) {} },
            navigate: (viewId) => { 
                if (viewId === 'codals') return; 
                if(views[currentView] && views[currentView].unsubscribe) views[currentView].unsubscribe(); 
                currentView = viewId; renderSidebar(); const item = navItems.find(i => i.id === viewId); pageTitle.innerText = item ? item.label : 'App'; 
                if (views[viewId]) { contentArea.innerHTML = views[viewId].render(); if (views[viewId].init) views[viewId].init(); } 
            },
            
            updatePomoUI: () => { const mins = Math.floor(currentPomoSeconds / 60).toString().padStart(2, '0'); const secs = (currentPomoSeconds % 60).toString().padStart(2, '0'); const el = document.getElementById('pomo-time'); if(el) el.innerText = `${mins}:${secs}`; },
            startPomo: () => { if(isPomoRunning) return; isPomoRunning = true; document.getElementById('btn-pomo-start').classList.add('hidden'); document.getElementById('btn-pomo-pause').classList.remove('hidden'); if(pomoInterval) clearInterval(pomoInterval); pomoInterval = setInterval(() => { currentPomoSeconds--; window.appHandlers.updatePomoUI(); if(currentPomoSeconds <= 0) { clearInterval(pomoInterval); isPomoRunning = false; document.getElementById('btn-pomo-start').classList.remove('hidden'); document.getElementById('btn-pomo-pause').classList.add('hidden'); if(currentPomoMode === 'focus') { if(currentUser) { AppDB.add('focus_sessions', { minutes: POMO_FOCUS_MINS, created: serverTimestamp() }); } alert("Great job! Focus session complete. Time for a break."); window.appHandlers.setPomoMode('break'); } else { alert("Break is over! Time to get back to the grind."); window.appHandlers.setPomoMode('focus'); } } }, 1000); },
            pausePomo: () => { isPomoRunning = false; clearInterval(pomoInterval); document.getElementById('btn-pomo-start').classList.remove('hidden'); document.getElementById('btn-pomo-pause').classList.add('hidden'); },
            resetPomo: () => { window.appHandlers.pausePomo(); currentPomoSeconds = currentPomoMode === 'focus' ? POMO_FOCUS_MINS * 60 : POMO_BREAK_MINS * 60; window.appHandlers.updatePomoUI(); },
            setPomoMode: (mode) => { window.appHandlers.pausePomo(); currentPomoMode = mode; currentPomoSeconds = mode === 'focus' ? POMO_FOCUS_MINS * 60 : POMO_BREAK_MINS * 60; const label = document.getElementById('pomo-mode-label'); if(mode === 'focus') { label.innerHTML = `<i class="fas fa-brain text-amber-400"></i> Focus Mode`; document.getElementById('pomo-main-content').classList.remove('bg-green-50'); document.getElementById('pomo-main-content').classList.add('bg-slate-50'); } else { label.innerHTML = `<i class="fas fa-mug-hot text-green-400"></i> Break Time`; document.getElementById('pomo-main-content').classList.remove('bg-slate-50'); document.getElementById('pomo-main-content').classList.add('bg-green-50'); } window.appHandlers.updatePomoUI(); },
            switchPomoMode: () => { window.appHandlers.setPomoMode(currentPomoMode === 'focus' ? 'break' : 'focus'); },
            togglePomoMinimize: () => { const widget = document.getElementById('pomodoro-widget'); const icon = document.getElementById('pomo-min-icon'); if (widget.classList.contains('translate-y-[calc(100%-48px)]')) { widget.classList.remove('translate-y-[calc(100%-48px)]'); icon.classList.remove('rotate-180'); } else { widget.classList.add('translate-y-[calc(100%-48px)]'); icon.classList.add('rotate-180'); } },
            addClass: () => { Modal.show({ title: '<i class="fas fa-calendar-plus text-blue-600"></i> Add Class to Schedule', content: `<div><label class="block text-sm font-medium text-slate-700 mb-1">Subject</label><input type="text" id="cls-sub" class="w-full p-2 border border-slate-300 rounded-lg outline-none" placeholder="e.g., Obicon"></div><div class="mt-3"><label class="block text-sm font-medium text-slate-700 mb-1">Day of Week</label><select id="cls-day" class="w-full p-2 border border-slate-300 rounded-lg outline-none"><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option></select></div><div class="mt-3 grid grid-cols-2 gap-3"><div><label class="block text-sm font-medium text-slate-700 mb-1">Time</label><input type="text" id="cls-time" class="w-full p-2 border border-slate-300 rounded-lg outline-none" placeholder="e.g. 5:30 PM"></div><div><label class="block text-sm font-medium text-slate-700 mb-1">Room</label><input type="text" id="cls-room" class="w-full p-2 border border-slate-300 rounded-lg outline-none" placeholder="e.g. Room 101"></div></div><div class="mt-3"><label class="block text-sm font-medium text-slate-700 mb-1">Professor</label><input type="text" id="cls-prof" class="w-full p-2 border border-slate-300 rounded-lg outline-none" placeholder="e.g. Atty. Mason"></div>`, onSubmit: async () => { const sub = document.getElementById('cls-sub').value.trim(); if (!sub) return; await AppDB.add('schedule', { subject: sub, day: document.getElementById('cls-day').value, time: document.getElementById('cls-time').value.trim(), room: document.getElementById('cls-room').value.trim(), professor: document.getElementById('cls-prof').value.trim() }); } }); },
            deleteClass: (id) => { Modal.show({ title: '<i class="fas fa-trash text-red-500"></i> Remove Class', content: '<p>Remove this class from your schedule?</p>', submitText: 'Delete', submitClass: 'px-4 py-2 bg-red-600 text-white rounded-lg', onSubmit: async () => await AppDB.delete('schedule', id) }); },
            
            openSubject: (id, name) => { if(views[currentView] && views[currentView].unsubscribe) views[currentView].unsubscribe(); currentView = 'subject_notebook'; renderSidebar(); pageTitle.innerText = 'Notebook'; views.subject_notebook.init(id, name); },
            addNote: (subjectId) => { Modal.show({ title: '<i class="fas fa-file-alt text-blue-600"></i> New Page', content: `<div><label class="block text-sm font-medium text-slate-700 mb-1">Page Title</label><input type="text" id="note-title" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="e.g., Article 1156"></div>`, onSubmit: async () => { const title = document.getElementById('note-title').value.trim() || 'Untitled Page'; await AppDB.add('notes', { subjectId, title, content: '', created: serverTimestamp() }); } }); },
            
            openNote: (noteId, title, content, btnElement) => {
                views.subject_notebook.activeNoteId = noteId;
                document.querySelectorAll('#notebook-pages-list button').forEach(b => { b.classList.remove('bg-blue-50', 'text-blue-700', 'border-l-blue-600'); b.classList.add('text-slate-600', 'border-l-transparent'); });
                if(btnElement) { btnElement.classList.remove('text-slate-600', 'border-l-transparent'); btnElement.classList.add('bg-blue-50', 'text-blue-700', 'border-l-blue-600'); }
                let displayTitle = title ? title.replace(/\\'/g, "'") : 'Untitled Page';
                let displayContent = content ? content.replace(/\\n/g, '\n').replace(/\\'/g, "'") : '';
                const safeTitleForPrint = displayTitle.replace(/'/g, "\\'");
                const area = document.getElementById('notebook-editor-area');
                area.innerHTML = `<div class="flex-1 flex flex-col p-8 bg-white m-6 rounded-2xl shadow-sm border border-slate-200"><div class="flex justify-between items-center mb-6"><input type="text" id="note-title-editor" class="text-3xl font-bold text-slate-800 border-none outline-none focus:ring-0 placeholder-slate-300 serif-text bg-transparent flex-1" value="${displayTitle.replace(/"/g, '&quot;')}" placeholder="Page Title..."><div class="flex gap-2"><button onclick="window.appHandlers.printNote('${safeTitleForPrint}')" class="text-slate-400 hover:text-blue-600 p-2" title="Print / Save PDF"><i class="fas fa-print"></i></button><button onclick="window.appHandlers.downloadText('${safeTitleForPrint}.txt', document.getElementById('note-content-editor').value)" class="text-slate-400 hover:text-blue-600 p-2" title="Download Text"><i class="fas fa-download"></i></button></div></div><textarea id="note-content-editor" class="flex-1 w-full border-none outline-none resize-none text-slate-700 leading-relaxed text-base font-sans placeholder-slate-300 focus:ring-0 bg-transparent" placeholder="Start typing your notes here..."></textarea><div class="mt-4 flex justify-end items-center gap-4 pt-4 border-t border-slate-100"><span id="note-save-status" class="text-sm font-bold text-green-500 opacity-0 transition-opacity"><i class="fas fa-check-circle mr-1"></i> Saved to Cloud</span><button onclick="window.appHandlers.saveNote('${noteId}')" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-bold transition shadow-md"><i class="fas fa-save mr-2"></i> Save Page</button></div></div>`;
                document.getElementById('note-content-editor').value = displayContent;
            },
            saveNote: async (noteId) => { const title = document.getElementById('note-title-editor').value.trim() || 'Untitled Page'; const content = document.getElementById('note-content-editor').value; const status = document.getElementById('note-save-status'); try { await AppDB.update('notes', noteId, { title, content, updated: serverTimestamp() }); status.classList.remove('opacity-0'); setTimeout(() => status.classList.add('opacity-0'), 3000); } catch(e) { alert("Error saving note."); } },
            deleteNote: (noteId) => { Modal.show({ title: '<i class="fas fa-trash text-red-500"></i> Delete Page', content: '<p class="text-slate-600">Are you sure you want to delete this page permanently?</p>', submitText: 'Delete', submitClass: 'px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700', onSubmit: async () => { await AppDB.delete('notes', noteId); views.subject_notebook.activeNoteId = null; document.getElementById('notebook-editor-area').innerHTML = `<div class="absolute inset-0 flex flex-col items-center justify-center text-slate-400"><i class="fas fa-book-open text-6xl mb-4 opacity-20"></i><p class="font-medium text-slate-500">Page deleted.</p></div>`; } }); },
            
            handleDigestUpload: async (input) => { const file = input.files[0]; if (!file) return; const display = document.getElementById('digest-filename'); const btn = document.getElementById('btn-process-digest'); display.innerText = file.name; display.classList.remove('hidden'); btn.innerText = "Reading PDF..."; btn.disabled = true; try { const arrayBuffer = await file.arrayBuffer(); const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise; let fullText = ""; const maxPages = Math.min(pdf.numPages, 10); for (let i = 1; i <= maxPages; i++) { const page = await pdf.getPage(i); const textContent = await page.getTextContent(); fullText += textContent.items.map(item => item.str).join(' ') + "\n"; } window.appHandlers.digestText = fullText; document.getElementById('digest-textarea').value = ''; btn.disabled = false; btn.innerHTML = '<i class="fas fa-robot mr-1"></i> Digest with Gemini'; } catch (e) { alert("Failed to read PDF."); btn.innerHTML = "Error"; } },
            processDigest: async () => { const titleInput = document.getElementById('digest-title').value.trim(); const subjectInput = document.getElementById('digest-subject').value.trim(); const textAreaInput = document.getElementById('digest-textarea').value.trim(); const apiKey = document.getElementById('gemini-api-key').value.trim(); if (!apiKey) { alert("Please enter your Gemini API Key."); return; } localStorage.setItem('gemini_api_key', apiKey); if (!titleInput || !subjectInput) { alert("Please enter both the Case Title and Subject Matter."); return; } let textToDigest = textAreaInput || window.appHandlers.digestText; if (!textToDigest) { alert("Please paste the full text of the case or upload a PDF."); return; } const area = document.getElementById('digest-results-area'); const btn = document.getElementById('btn-process-digest'); btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Gemini is Digesting...'; area.innerHTML = `<div class="flex justify-center h-full items-center flex-col"><div class="loader mb-4"></div><p class="text-slate-500 text-sm animate-pulse">Gemini is analyzing the case...</p></div>`; try { const promptText = `You are an expert law professor. Digest the following legal case text. Focus your extraction of the Facts, Issue, and Ruling strictly in relation to: "${subjectInput}". Return the result STRICTLY as a raw JSON object with exactly three keys: "facts", "issue", and "ruling". Do NOT use markdown formatting like \`\`\`json. DO NOT add any other text. Case Text: ${textToDigest.substring(0, 50000)}`; const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: promptText }] }], generationConfig: { responseMimeType: "application/json" } }) }); if (!response.ok) throw new Error(`API Error: ${response.status}`); const data = await response.json(); let jsonString = data.candidates[0].content.parts[0].text; jsonString = jsonString.replace(/^```json\s*/i, '').replace(/\s*```$/i, '').trim(); const parsedDigest = JSON.parse(jsonString); const facts = parsedDigest.facts || "Facts not found."; const issue = parsedDigest.issue || "Issue not found."; const ruling = parsedDigest.ruling || "Ruling not found."; await AppDB.add('digests', { title: titleInput, subject: subjectInput, facts: facts, issue: issue, ruling: ruling, created: serverTimestamp() }); area.innerHTML = `<div class="space-y-4"><div class="bg-green-50 border border-green-200 text-green-700 p-4 rounded-xl flex items-center gap-4 shadow-sm animate-fade-in"><i class="fas fa-check-circle text-3xl"></i><div class="flex-1"><p class="font-bold">Successfully Digested!</p><p class="text-xs opacity-80">Saved to Cons. Digests.</p></div><button onclick="window.appHandlers.navigate('digests')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm">View</button></div><div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><h4 class="font-bold text-slate-700 text-xs tracking-wider uppercase mb-2">Facts</h4><p class="text-sm whitespace-pre-wrap">${facts}</p></div><div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><h4 class="font-bold text-slate-700 text-xs tracking-wider uppercase mb-2">Issue</h4><p class="text-sm font-medium whitespace-pre-wrap">${issue}</p></div><div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><h4 class="font-bold text-slate-700 text-xs tracking-wider uppercase mb-2">Ruling</h4><p class="text-sm whitespace-pre-wrap">${ruling}</p></div></div>`; } catch (error) { area.innerHTML = `<div class="bg-red-50 text-red-700 p-4 rounded-xl border border-red-200">Error processing: ${error.message}</div>`; } finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-robot mr-1"></i> Digest with Gemini'; window.appHandlers.digestText = ''; } },
            handleFileUpload: async (input) => { const file = input.files[0]; if (!file) return; document.getElementById('file-name-display').innerText = file.name; document.getElementById('file-name-display').classList.remove('hidden'); document.getElementById('btn-generate').innerText = "Processing PDF..."; document.getElementById('review-textarea').value = ''; try { const arrayBuffer = await file.arrayBuffer(); const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise; let fullText = ""; const maxPages = Math.min(pdf.numPages, 10); for (let i = 1; i <= maxPages; i++) { const page = await pdf.getPage(i); const textContent = await page.getTextContent(); fullText += textContent.items.map(item => item.str).join(' '); fullText += pageText + "\n"; } window.appHandlers.pdfText = fullText; document.getElementById('btn-generate').disabled = false; document.getElementById('btn-generate').innerText = "Generate AI Review"; } catch (e) { console.error(e); alert("Error reading PDF."); document.getElementById('btn-generate').innerText = "Error"; } },
            generateReview: async () => { const textAreaInput = document.getElementById('review-textarea').value.trim(); let text = textAreaInput || window.appHandlers.pdfText; const mode = window.appHandlers.reviewMode; const output = document.getElementById('review-output'); const apiKey = document.getElementById('review-api-key').value.trim(); const btn = document.getElementById('btn-generate'); if (!apiKey) { alert("Please enter your Gemini API Key."); return; } localStorage.setItem('gemini_api_key', apiKey); if (!text) { alert("Please paste text or upload a text-searchable PDF first."); return; } btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Generating...'; output.innerHTML = `<div class="flex justify-center flex-col items-center h-full p-10"><div class="loader mb-4"></div><p class="text-slate-500 font-medium">Gemini is designing your ${mode === 'recit' ? 'Flashcards' : 'Mock Bar Exam'}...</p></div>`; try { let promptText = mode === 'recit' ? `You are a strict law professor helping a student memorize key concepts. Based strictly on the provided text, generate exactly 10 flashcards for recitation prep. Focus on definitions, elements, exceptions, and core doctrines. Return ONLY a raw JSON array of objects, where each object has a "front" (the question or term) and a "back" (the answer or definition). Do NOT use markdown like \`\`\`json. Output raw JSON only. Material: ${text.substring(0, 45000)}` : `You are a rigorous Bar Examiner. Based strictly on the provided text, generate exactly 5 essay-type hypothetical legal problems. These problems must test issue spotting, critical thinking, and the direct application of the rules and jurisprudence found in the text. Return ONLY a raw JSON array of objects, where each object has: "question": (The hypothetical scenario and the specific question asked at the end). "suggested_answer": (A brief suggested answer key highlighting the specific legal issue to spot and the rule to apply). Do NOT use markdown like \`\`\`json. Output raw JSON only. Material: ${text.substring(0, 45000)}`; const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: promptText }] }], generationConfig: { responseMimeType: "application/json" } }) }); if (!response.ok) throw new Error(`API Error: ${response.status}`); const data = await response.json(); let jsonString = data.candidates[0].content.parts[0].text; jsonString = jsonString.replace(/^```json\s*/i, '').replace(/\s*```$/i, '').trim(); let parsedData = JSON.parse(jsonString); if (mode === 'recit') { parsedData = parsedData.map(c => ({...c, nextReview: Date.now(), interval: 0})); } window.appHandlers.currentReviewData = { mode: mode, content: parsedData }; output.innerHTML = `<div class="bg-white p-4 rounded-xl border border-blue-200 shadow-sm mb-6 flex gap-3 items-center sticky top-0 z-20"><input type="text" id="save-review-title" placeholder="Name this review (e.g., Obicon Art 1156)" class="flex-1 p-2 rounded-lg border border-slate-200 text-sm outline-none focus:ring-2 focus:ring-blue-500 font-medium"><button onclick="window.appHandlers.saveCurrentReview()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg text-sm font-bold shadow-sm transition whitespace-nowrap"><i class="fas fa-save mr-1"></i> Save Material</button></div>`; if (mode === 'recit') { output.innerHTML += `<h3 class="font-bold text-xl mb-4 py-2 flex items-center gap-2"><i class="fas fa-bolt text-amber-500"></i> Recit Flashcards (${parsedData.length})</h3>`; const grid = document.createElement('div'); grid.className = "grid grid-cols-1 md:grid-cols-2 gap-4 pb-8"; parsedData.forEach((card, i) => { const el = document.createElement('div'); el.className = "bg-white p-6 rounded-xl shadow-sm border border-slate-300 cursor-pointer hover:shadow-md transition flex flex-col justify-between min-h-[160px] group perspective relative overflow-hidden"; el.onclick = function() { this.querySelector('.card-inner').classList.toggle('hidden'); this.querySelector('.card-back').classList.toggle('hidden'); }; el.innerHTML = `<div class="card-inner"><span class="text-[10px] text-blue-600 font-bold uppercase mb-3 block tracking-widest">Card ${i+1} / Question</span><p class="serif-text font-semibold text-slate-800 leading-snug">${card.front}</p><div class="mt-4 pt-3 border-t border-slate-100 text-center"><p class="text-xs text-slate-400 group-hover:text-amber-600 transition">(Click to reveal answer)</p></div></div><div class="card-back hidden animate-fade-in flex flex-col h-full justify-between"><div><span class="text-[10px] text-green-600 font-bold uppercase mb-3 block tracking-widest">Answer</span><p class="text-sm text-slate-700 leading-relaxed">${card.back}</p></div><div class="mt-4 pt-3 border-t border-slate-100 text-center"><p class="text-xs text-slate-400 group-hover:text-blue-600 transition">(Click to flip back)</p></div></div>`; grid.appendChild(el); }); output.appendChild(grid); } else { output.innerHTML += `<h3 class="font-bold text-xl mb-4 py-2 flex items-center gap-2"><i class="fas fa-balance-scale text-slate-800"></i> Mock Bar Examination</h3>`; const paper = document.createElement('div'); paper.className = "bg-white p-8 rounded shadow-md border border-slate-300 min-h-[500px] serif-text mb-8"; let html = `<div class="text-center border-b-2 border-black pb-4 mb-8"><h2 class="text-2xl font-bold uppercase tracking-widest">Mock Bar Examination</h2><p class="italic text-slate-600 mt-1">Focus: Issue Spotting & Application</p></div>`; parsedData.forEach((item, i) => { html += `<div class="mb-10"><h4 class="font-bold mb-3 text-lg font-sans text-blue-800">Question ${i+1}</h4><p class="mb-5 leading-relaxed text-justify whitespace-pre-wrap">${item.question}</p><textarea id="live-exam-answer-${i}" class="w-full p-4 border border-slate-200 rounded-lg font-sans text-sm focus:ring-0 outline-none resize-y min-h-[150px] shadow-inner bg-slate-50 placeholder-slate-400" placeholder="Type your legal analysis here..."></textarea><div class="mt-4"><button onclick="window.appHandlers.evaluateAnswer(${i}, null)" id="btn-eval-live-${i}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition"><i class="fas fa-check-double mr-1"></i> Check My Answer</button></div><div id="eval-result-live-${i}" class="mt-4 hidden"></div><details class="mt-5 font-sans text-sm group border-t border-slate-100 pt-4"><summary class="cursor-pointer text-amber-600 font-bold flex items-center gap-2 hover:text-amber-700 outline-none list-none"><i class="fas fa-lightbulb transition-transform group-open:text-green-500"></i> Show Suggested Answer</summary><div class="mt-3 p-5 bg-amber-50 border border-amber-200 rounded-xl text-slate-800 leading-relaxed shadow-inner whitespace-pre-wrap">${item.suggested_answer}</div></details></div>${i !== parsedData.length - 1 ? '<hr class="my-8 border-slate-200">' : ''}`; }); paper.innerHTML = html; output.appendChild(paper); } } catch (error) { console.error("Gemini failed:", error); output.innerHTML = `<div class="bg-red-50 text-red-700 p-6 rounded-xl border border-red-200 flex items-start gap-4 shadow-sm w-full max-w-lg mx-auto mt-10"><i class="fas fa-exclamation-triangle text-2xl mt-1"></i><div><p class="font-bold text-lg mb-1">Failed to generate review.</p><p class="text-sm opacity-90">${error.message}</p></div></div>`; } finally { btn.disabled = false; btn.innerHTML = 'Generate AI Review'; window.appHandlers.pdfText = ''; } },
            evaluateAnswer: async (index, docId) => { const apiKey = localStorage.getItem('gemini_api_key'); if (!apiKey) { alert("Please enter your Gemini API Key at the top of the page."); return; } const isLive = docId === null; const answerId = isLive ? `live-exam-answer-${index}` : `saved-exam-answer-${docId}-${index}`; const btnId = isLive ? `btn-eval-live-${index}` : `btn-eval-${docId}-${index}`; const resultId = isLive ? `eval-result-live-${index}` : `eval-result-${docId}-${index}`; const answerEl = document.getElementById(answerId); const userAnswer = answerEl.value.trim(); if (!userAnswer) { alert("Please type an answer first."); return; } const btn = document.getElementById(btnId); const resultDiv = document.getElementById(resultId); let reviewData; if (isLive && window.appHandlers.currentReviewData) { reviewData = window.appHandlers.currentReviewData.content[index]; } else if (!isLive && window.appHandlers.savedExamData[docId]) { reviewData = window.appHandlers.savedExamData[docId][index]; } if(!reviewData) return; btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Grading...'; resultDiv.classList.remove('hidden'); resultDiv.innerHTML = `<div class="p-4 bg-slate-50 rounded-lg text-sm text-slate-500 animate-pulse border border-slate-200">Professor Gemini is reviewing your answer...</div>`; try { const promptText = `You are a strict but fair law professor grading a student's answer to a Bar Exam question. Question: ${reviewData.question} Suggested Correct Answer / Rubric: ${reviewData.suggested_answer} Student's Answer: ${userAnswer} Task: Provide a brief, constructive evaluation. Mention what they got right (Issue spotting, Rule application). Mention what they missed. Give a final score out of 100%. Keep formatting clean using basic HTML tags like <b> and <br>, do NOT use code blocks or markdown backticks.`; const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: promptText }] }] }) }); if (!response.ok) throw new Error(`API Error: ${response.status}`); const data = await response.json(); let feedback = data.candidates[0].content.parts[0].text; resultDiv.innerHTML = `<div class="p-5 bg-blue-50 border border-blue-200 rounded-xl shadow-inner text-sm text-slate-800 leading-relaxed font-sans mt-2"><h5 class="font-bold text-blue-800 mb-3 border-b border-blue-200 pb-2 uppercase tracking-wider text-xs"><i class="fas fa-marker mr-1"></i> Professor's Feedback</h5>${feedback}</div>`; } catch (error) { resultDiv.innerHTML = `<div class="p-4 bg-red-50 text-red-700 rounded-lg text-sm border border-red-200">Error grading answer: ${error.message}</div>`; } finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-check-double mr-1"></i> Check Answer'; } },
            rateFlashcard: async (reviewId, cardIndex, rating) => { try { const reviewContent = window.appHandlers.savedReviewData[reviewId]; if (!reviewContent) return; let card = reviewContent[cardIndex]; const now = Date.now(); let newInterval = card.interval || 0; if (rating === 'hard') { newInterval = 1; } else if (rating === 'good') { newInterval = newInterval === 0 ? 3 : newInterval * 2; } else if (rating === 'easy') { newInterval = newInterval === 0 ? 7 : newInterval * 3; } card.interval = newInterval; card.nextReview = now + (newInterval * 24 * 60 * 60 * 1000); reviewContent[cardIndex] = card; await AppDB.update('reviews', reviewId, { content: reviewContent }); } catch(e) { console.error("Error updating flashcard:", e); alert("Failed to save flashcard rating."); } },
            saveCurrentReview: async () => { const title = document.getElementById('save-review-title').value.trim(); if (!title) { alert('Please enter a title to save this review.'); return; } if (!window.appHandlers.currentReviewData) return; const { mode, content } = window.appHandlers.currentReviewData; try { await AppDB.add('reviews', { title, type: mode, content: content, created: serverTimestamp() }); alert('Review saved successfully to your Saved Reviews tab!'); window.appHandlers.navigate('saved_reviews'); } catch (e) { console.error(e); alert('Failed to save review.'); } },
            deleteReview: (id) => { Modal.show({ title: '<i class="fas fa-trash text-red-500"></i> Delete Review', content: '<p>Are you sure you want to delete this saved review?</p>', submitText: 'Delete', submitClass: 'px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition shadow-sm', onSubmit: async () => await AppDB.delete('reviews', id) }); }
        };

        onAuthStateChanged(auth, (user) => {
            const loginScreen = document.getElementById('login-screen');
            if (user) {
                currentUser = user; document.getElementById('user-display').innerText = user.displayName || "Counsel";
                loginScreen.classList.add('opacity-0', 'pointer-events-none'); setTimeout(() => loginScreen.classList.add('hidden'), 300);
                window.appHandlers.navigate('dashboard'); window.appHandlers.updatePomoUI();
            } else {
                currentUser = null; if(views[currentView] && views[currentView].unsubscribe) views[currentView].unsubscribe();
                loginScreen.classList.remove('hidden', 'opacity-0', 'pointer-events-none');
            }
        });
    </script>
</body>
</html>
